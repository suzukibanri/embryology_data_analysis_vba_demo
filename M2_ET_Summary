' 移植サマリーを出力するマクロです

Public hCG_globalET_Count_Denominator As Object
Public GS_globalEgg_Count_Denominator As Object
Public FHB_globalEgg_Count_Denominator As Object
Public LB_globalEgg_Count_Denominator
Public targetRow As Long

Sub ET01_CreateReportSheet()
    ' 移植サマリーシートを新規作成し、ピボットテーブルから情報をまとめて出力するマクロ

    Dim ws As Worksheet
    Dim pt As pivotTable
    Dim rng As Range
    Dim cell As Range
    Dim dict As Object
    Dim Yearcount As Integer
    Dim row As Long
    Dim col As Long
    Dim clinicCol As Long
    Dim i As Integer
    Dim btnGoBack  As Button

    ' 既存の「移植サマリー」シートがあれば削除
    On Error Resume Next
    Set ws = ThisWorkbook.Sheets("移植サマリー")
    On Error GoTo 0

    If Not ws Is Nothing Then
        Application.DisplayAlerts = False
        ws.Delete
        Application.DisplayAlerts = True
    End If

    ' 新しいシートを追加して名前を設定
    Set ws = ThisWorkbook.Sheets.Add(After:=ThisWorkbook.Sheets(ThisWorkbook.Sheets.count))
    ws.name = "移植サマリー"

    ' タイトルや見出しを入力
    With ws
        With .Cells(2, 3)
        .value = "移植サマリー "  ' C2
        .Font.Size = 14
        .Font.Bold = True
        End With
        .Cells(5, 3).HorizontalAlignment = xlCenter
        .Cells(5, 3).value = "全院"         ' C5
        .Cells(2, 5).HorizontalAlignment = xlCenter
        .Cells(2, 5).value = "検索"
        .Cells(2, 6).HorizontalAlignment = xlCenter
        .Cells(2, 6).value = "院名"
        .Cells(2, 7).HorizontalAlignment = xlCenter
        .Cells(2, 7).value = "年度"
        .Cells(3, 6).HorizontalAlignment = xlCenter
        .Cells(3, 7).HorizontalAlignment = xlCenter
    End With
    
    With ws.Range("E2:G3")
    .Borders.LineStyle = xlContinuous
    .Borders.Weight = xlThin
    .Interior.Color = RGB(221, 235, 247)
End With

ws.Range("E2").Borders(xlEdgeBottom).LineStyle = xlNone
ws.Range("F3:G3").Interior.Color = RGB(255, 255, 255)


    ' 年一覧の取得
    yearKeys = GetSortedYearsFromPivot()

    ' 院名と識別番号を取得し、昇順に並べ替え
    Dim hospitalMap As Object
    Dim sortedKeys As Variant
    Dim j As Long
    Dim outputSheet As Worksheet
    Dim outputRow As Long
    Dim outputCol As Long

    Set hospitalMap = GetHospitalMap()
    sortedKeys = SortKeysByValue(hospitalMap)
    Dim hospitalCount As Long
    hospitalCount = hospitalMap.count
    
    ' F3 に院名プルダウン設定
    ' sortedKeysの先頭に "全院" を追加
    Dim allKeys() As String
    ReDim allKeys(0 To UBound(sortedKeys) + 1)

    allKeys(0) = "全院"
    Dim n As Long
    For n = 0 To UBound(sortedKeys)
        allKeys(n + 1) = sortedKeys(n)
    Next n
    
    Dim keyList As String
    keyList = Join(allKeys, ",")

    With ws.Range("F3").Validation
        .Delete
        .Add Type:=xlValidateList, AlertStyle:=xlValidAlertStop, _
            Operator:=xlBetween, Formula1:=keyList
        .IgnoreBlank = True
        .InCellDropdown = True
    End With

    ' G3 に年度プルダウン設定
    ' yearKeys の先頭に "全期間" を追加
Dim allYears() As String
ReDim allYears(0 To UBound(yearKeys) + 1)

allYears(0) = "全期間"
Dim m As Long
For m = 0 To UBound(yearKeys)
    allYears(m + 1) = yearKeys(m)
Next m
    
    Dim yearStr As String
    yearStr = Join(allYears, ",")

    With ws.Range("G3").Validation
        .Delete
        .Add Type:=xlValidateList, AlertStyle:=xlValidAlertStop, _
            Operator:=xlBetween, Formula1:=yearStr
        .IgnoreBlank = True
        .InCellDropdown = True
    End With

    ' C列（列番号3）から出力開始
    col = 3

    ' 各院ごとに年度別のレイアウトと年度見出しを出力
    For j = 0 To hospitalCount
        clinicCol = col + j * 15 ' 各院ごとに8列ずらす
        row = 5

        ' 最初に「全期間」のブロックを出力
        With ThisWorkbook.Sheets("移植サマリー")
            .Cells(row, clinicCol + 1).value = "全期間"
            .Cells(row, clinicCol).Font.Size = 12
            .Cells(row, clinicCol + 1).Font.Size = 12
            .Cells(row + 1, clinicCol + 1).value = "All ET"
            .Cells(row + 1, clinicCol + 3).value = "SBT"
            .Cells(row + 1, clinicCol + 5).value = "DBT"
            .Cells(row + 1, clinicCol + 7).value = "2StepET"
            .Cells(row + 1, clinicCol + 9).value = "Clevage-Stage ET"
            .Cells(row + 1, clinicCol + 9).Font.Size = 9
            .Cells(row + 1, clinicCol + 11).value = "その他"
            .Cells(row + 2, clinicCol).value = "移植件数"
            .Cells(row + 3, clinicCol).value = "卵数"
            .Cells(row + 4, clinicCol).value = "hCG陽性率(%)"
            .Cells(row + 5, clinicCol).value = "GS確認率(%)"
            .Cells(row + 6, clinicCol).value = "FHB確認率(%)"
            .Cells(row + 7, clinicCol).value = "出産率(%)"
       
        
    '  行の高さを23に設定（C7～C13に対応）
    .Rows(row + 1 & ":" & row + 7).RowHeight = 23
    
    ' 罫線を引く(上下端）
    With .Range(.Cells(row + 1, clinicCol), .Cells(row + 7, clinicCol + 12))

' 上下の罫線を太く（中太）
.Borders(xlEdgeTop).LineStyle = xlContinuous
.Borders(xlEdgeTop).Weight = xlThick

.Borders(xlEdgeBottom).LineStyle = xlContinuous
.Borders(xlEdgeBottom).Weight = xlThick
'
'        ' --- 中央揃え ---
    .HorizontalAlignment = xlCenter
    .VerticalAlignment = xlCenter

    End With
    
 ' 罫線を引く(内側１）
    With .Range(.Cells(row + 2, clinicCol), .Cells(row + 2, clinicCol + 12))
    .Borders(xlEdgeTop).LineStyle = xlContinuous
    .Borders(xlEdgeTop).Weight = xlThin
    .HorizontalAlignment = xlCenter
    .VerticalAlignment = xlCenter
End With

 ' 罫線を引く(内側２）
    With .Range(.Cells(row + 4, clinicCol), .Cells(row + 4, clinicCol + 12))
    .Borders(xlEdgeTop).LineStyle = xlContinuous
    .Borders(xlEdgeTop).Weight = xlThin
    .HorizontalAlignment = xlCenter
    .VerticalAlignment = xlCenter
End With

End With

    ' 背景を白くする
   With ws.Range(ws.Cells(row, clinicCol), ws.Cells(row + 7, clinicCol + 12))
    
    .Interior.Color = RGB(255, 255, 255)
    
    End With
    
    ' 背景を灰色にする
   With ws.Range(ws.Cells(row + 1, clinicCol), ws.Cells(row + 1, clinicCol + 12))
    
    .Interior.Color = RGB(242, 242, 242)
    
    End With
    
        ' ボタン作成
        Set btnGoBack = ws.Buttons.Add( _
         ws.Cells(row + 7, clinicCol + 12).Left + 60, _
         ws.Cells(row + 7, clinicCol + 12).Top, _
          40, 20) '

    With btnGoBack
'        .OnAction = "btnGoBack_First_i" & i & "_j" & j
        .Caption = "戻る"
        .name = "btnGoBack_First_i" & i & "_j" & j
    End With
    
        row = row + 9 ' 次のブロックの開始位置

        ' 年度を上から下に出力（最新→過去）+ レイアウト作成
        For i = LBound(yearKeys) To UBound(yearKeys)
            With ThisWorkbook.Sheets("移植サマリー")
            
            If j = 0 Then
            .Cells(row, clinicCol).HorizontalAlignment = xlCenter
            .Cells(row, clinicCol).value = "全院"
            End If
            
            If j <= UBound(sortedKeys) Then
            .Cells(row, clinicCol + 15).HorizontalAlignment = xlCenter
            .Cells(row, clinicCol + 15).value = sortedKeys(j)
            End If
            
            .Cells(row, clinicCol + 1).value = yearKeys(i) & "年"
            .Cells(row + 1, clinicCol + 1).value = "All ET"
            .Cells(row + 1, clinicCol + 3).value = "SBT"
            .Cells(row + 1, clinicCol + 5).value = "DBT"
            .Cells(row + 1, clinicCol + 7).value = "2StepET"
            .Cells(row + 1, clinicCol + 9).value = "Clevage-Stage ET"
            .Cells(row + 1, clinicCol + 9).Font.Size = 9
            .Cells(row + 1, clinicCol + 11).value = "その他"
            .Cells(row + 2, clinicCol).value = "移植件数"
            .Cells(row + 3, clinicCol).value = "卵数"
            .Cells(row + 4, clinicCol).value = "hCG陽性率(%)"
            .Cells(row + 5, clinicCol).value = "GS確認率(%)"
            .Cells(row + 6, clinicCol).value = "FHB確認率(%)"
            .Cells(row + 7, clinicCol).value = "出産率(%)"
            
                '  行の高さを23に設定（C7～C13に対応）
    .Rows(row + 1 & ":" & row + 7).RowHeight = 23
    
    ' 罫線を引く（C7～H13）
    With .Range(.Cells(row + 1, clinicCol), .Cells(row + 7, clinicCol + 12))

' 上下の罫線を太く（中太）
.Borders(xlEdgeTop).LineStyle = xlContinuous
.Borders(xlEdgeTop).Weight = xlThick

.Borders(xlEdgeBottom).LineStyle = xlContinuous
.Borders(xlEdgeBottom).Weight = xlThick
    
        ' --- 中央揃え ---
    .HorizontalAlignment = xlCenter
    .VerticalAlignment = xlCenter
End With

 ' 罫線を引く(内側１）
    With .Range(.Cells(row + 2, clinicCol), .Cells(row + 2, clinicCol + 12))
    .Borders(xlEdgeTop).LineStyle = xlContinuous
    .Borders(xlEdgeTop).Weight = xlThin
    .HorizontalAlignment = xlCenter
    .VerticalAlignment = xlCenter
End With

 ' 罫線を引く(内側２）
    With .Range(.Cells(row + 4, clinicCol), Cells(row + 4, clinicCol + 12))
    .Borders(xlEdgeTop).LineStyle = xlContinuous
    .Borders(xlEdgeTop).Weight = xlThin
    .HorizontalAlignment = xlCenter
    .VerticalAlignment = xlCenter
End With
            
            End With
            
    ' 背景を白くする
   With ws.Range(ws.Cells(row, clinicCol), ws.Cells(row + 7, clinicCol + 12))
    
    .Interior.Color = RGB(255, 255, 255)
    
    End With
    
        ' 背景を灰色にする
   With ws.Range(ws.Cells(row + 1, clinicCol), ws.Cells(row + 1, clinicCol + 12))
    
    .Interior.Color = RGB(242, 242, 242)
    
    End With
    
            ' ボタン作成
        Set btnGoBack = ws.Buttons.Add( _
         ws.Cells(row + 7, clinicCol + 12).Left + 60, _
         ws.Cells(row + 7, clinicCol + 12).Top, _
          40, 20) '

    With btnGoBack
'        .OnAction = "btnGoBack_Second_i" & i & "_j" & j
        .Caption = "戻る"
        .name = "btnGoBack_Second_i" & i & "_j" & j
    End With
            
            row = row + 9 ' 次の年度の行位置
        Next i
    Next j
    
    ' 列幅・整列の調整
    Dim formatCol As Long
    For j = 0 To hospitalCount
        formatCol = 3 + j * 15

        With ThisWorkbook.Sheets("移植サマリー")
            .Columns(formatCol).ColumnWidth = 15.8
            .Columns(formatCol + 1).ColumnWidth = 7
            .Columns(formatCol + 3).ColumnWidth = 7
            .Columns(formatCol + 5).ColumnWidth = 7
            .Columns(formatCol + 7).ColumnWidth = 7
            .Columns(formatCol + 9).ColumnWidth = 7
            .Columns(formatCol + 11).ColumnWidth = 7
            
            .Columns(formatCol + 2).ColumnWidth = 10
            .Columns(formatCol + 4).ColumnWidth = 10
            .Columns(formatCol + 6).ColumnWidth = 10
            .Columns(formatCol + 8).ColumnWidth = 10
            .Columns(formatCol + 10).ColumnWidth = 10
            .Columns(formatCol + 12).ColumnWidth = 10

            .Columns(formatCol + 2).HorizontalAlignment = xlLeft
            .Columns(formatCol + 4).HorizontalAlignment = xlLeft
            .Columns(formatCol + 6).HorizontalAlignment = xlLeft
            .Columns(formatCol + 8).HorizontalAlignment = xlLeft
            .Columns(formatCol + 10).HorizontalAlignment = xlLeft
            .Columns(formatCol + 12).HorizontalAlignment = xlLeft

            .Columns(formatCol + 2).Font.Size = 9
            .Columns(formatCol + 4).Font.Size = 9
            .Columns(formatCol + 6).Font.Size = 9
            .Columns(formatCol + 8).Font.Size = 9
            .Columns(formatCol + 10).Font.Size = 9
            .Columns(formatCol + 12).Font.Size = 9

        End With
    Next j
    
    With Range("E2:G3")
    .Font.Size = 11
    .HorizontalAlignment = xlCenter
    .VerticalAlignment = xlCenter
End With


    ' 院名をH列から右に6列おきに出力
    Set outputSheet = ThisWorkbook.Sheets("移植サマリー")
    outputRow = 5
    outputCol = 18

    For j = LBound(sortedKeys) To UBound(sortedKeys)
   outputSheet.Cells(outputRow, outputCol).HorizontalAlignment = xlCenter
        outputSheet.Cells(outputRow, outputCol).value = sortedKeys(j)
        outputCol = outputCol + 15
    Next j

    Set hospitalMap = Nothing
    Set dict = Nothing
    
    Dim btn As Button
    Dim topLeftCell As Range
    Set topLeftCell = ws.Range("G2")

    ' 既存のボタンがあれば削除（重複防止）
    Dim shp As Shape
    For Each shp In ws.Shapes
        If shp.Type = msoFormControl Then
            If shp.topLeftCell.Address = topLeftCell.Address Then shp.Delete
        End If
    Next shp

    ' ボタン作成
        Set btn = ws.Buttons.Add( _
         topLeftCell.Left + 80, _
         topLeftCell.Top + 15, _
          80, 25)

    With btn
'        .OnAction = "SearchClinicYear"
        .Caption = "検索"
        .name = "btnSearch"
    End With
        
        ' ボタン名（例: "btnSearch"）にマクロを割り当てる
    With ws.Shapes("btnSearch")
        .OnAction = "Search_Sheet1" ' ←割り当てたいSub名
    End With
    
    Dim shpb As Shape
    For Each shpb In ws.Shapes
        If shpb.Type = msoFormControl Then
            If InStr(shpb.name, "btnGoBack") > 0 Then
                shpb.OnAction = "GoToA1_Sheet1" ' ←割り当てたいマクロ名
            End If
        End If
    Next shpb
    
        targetRow = row ' ← 公開変数にセット
        
    Set abtn = ws.Buttons.Add( _
    topLeftCell.Left + 80 + 80 + 10, _
    topLeftCell.Top + 15, _
    120, 25)
    With abtn
        .Caption = "タイトルに戻る"
        .OnAction = "GoBackHome"
    End With
    
End Sub

' 総移植件数/卵数の取得
Sub ET02_ETcount()

    Dim wsPivot As Worksheet
    Dim wsSummary As Worksheet
    Dim pt As pivotTable
    Dim lastCol As Long, lastRow As Long
    Dim methodRow As Long, clinicRow As Long
    Dim yearCol As Long
    Dim totalRow As Long
    Dim colLabel1 As String, colLabel2 As String
    Dim prevLabel1 As String
    Dim value As Variant
    Dim c As Long, r As Long
    Dim totalSum As Double
    Dim currentRowOffset As Long
    Dim yearmonth As Variant, year As Variant, month As Variant
    Dim cell As Range
    Dim methodName As Variant
    Dim baseCol As Long, baseMethodCol As Long
    Dim currentYear As Variant
    Dim yearList As Collection
    Dim yearArray() As Variant
    Dim i As Long, j As Long, tmp As Variant
    Dim yearExists As Boolean
    Dim hospitalMap As Object
    Dim sortedHospitals As Variant
    Dim hospitalName As Variant
    Dim clinicID As String
    Dim hospitalIndex As Long
       
       
    Set globalET_Count = CreateObject("Scripting.Dictionary")
    Set globalEgg_Count = CreateObject("Scripting.Dictionary")
       

    ' ピボットシートと出力先シートの設定
    Set wsPivot = ThisWorkbook.Sheets("S07_移植件数")
    Set wsSummary = ThisWorkbook.Sheets("移植サマリー")
    Set pt = wsPivot.PivotTables("P07_移植件数")

    ' ピボットの行・列情報を取得
    yearCol = pt.TableRange2.Column

    ETmethodRow = pt.RowRange.row - 1
    clinicRow = pt.RowRange.row
    rowYear = pt.RowRange.row + 1
    Dim dataStartRow As Long: dataStartRow = rowYear ' データ本体の開始行

    lastCol = pt.TableRange2.Columns.count + pt.TableRange2.Column - 1
    lastRow = pt.TableRange2.Rows.count + pt.TableRange2.row - 1
    totalRow = lastRow
    
    ' 年度リストを作成
    yearArray = GetSortedYearsFromPivot()

    ' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
    Dim yearDict As Object
    Set yearDict = CreateObject("Scripting.Dictionary")

    For i = UBound(yearArray) To LBound(yearArray) Step -1
        If Not yearDict.Exists(yearArray(i)) Then
            yearDict.Add yearArray(i), True
        End If
    Next i
'

    ' 院マップと識別番号でソートされた院名リストを取得
    Set hospitalMap = GetHospitalMap()
    sortedHospitals = SortKeysByValue(hospitalMap)

    ' データ列の開始列
    Dim firstDataCol As Long: firstDataCol = pt.TableRange2.Column
    
        ' データ集計
     ' 集計用ディクショナリ
    Dim ET_Count As Object
    Set ET_Count = CreateObject("Scripting.Dictionary")
    
    For r = dataStartRow To lastRow - 1 ' 最終行（総計）は除外
        yearmonth = wsPivot.Cells(r, firstDataCol).value
        If IsNumeric(yearmonth) Then
            year = yearmonth
        Else
            month = yearmonth
            yearMonthKey = year & "_" & month

            For c = firstDataCol To lastCol - 1 ' 最終列（総計）は除外
                If wsPivot.Cells(ETmethodRow, c).value <> "" Then prevMethod = Trim(wsPivot.Cells(ETmethodRow, c).value)
                method = prevMethod

                If wsPivot.Cells(clinicRow, c).value <> "" Then prevClinic = Trim(wsPivot.Cells(clinicRow, c).value)
                clinic = prevClinic

                value = wsPivot.Cells(r, c).value

                If method <> "" And clinic <> "" And IsNumeric(value) Then
                    Dim uniqueKey As String
                    
                    uniqueKey = Format(clinic, "00") & "_" & method & "_" & yearMonthKey

                    If Not ET_Count.Exists(uniqueKey) Then
                        ET_Count.Add uniqueKey, value
                    Else
                        ET_Count(uniqueKey) = ET_Count(uniqueKey) + value
                    End If
                End If
            Next c
        End If
    Next r

    ' === 院識別番号一覧を抽出 ===
    Dim clinicList As Object
    Set clinicList = CreateObject("Scripting.Dictionary")
    
For i = LBound(sortedHospitals) To UBound(sortedHospitals)
    Dim code As String
    code = Format(i + 1, "00")  ' "01", "02", ...
    
    If Not clinicList.Exists(code) Then
        clinicList.Add code, True
    End If
Next i


' === 各年度 × 院別 × 移植方法の合算値を出力（補正あり＆なし）===
Dim yearClinicSumDict As Object
Set yearClinicSumDict = CreateObject("Scripting.Dictionary")

Dim methodList As Variant
methodList = Array("1BT", "2BT", "2StepET", "1分割胚", "2分割胚", "1想定外STAGE", "2想定外STAGE", "混在：1想定外 + 他")

' 集計：分類ごとに件数を格納
For Each method In methodList
    For Each k In ET_Count.keys
'        If InStr(k, method) > 0 Then
            parts = Split(k, "_")
            If UBound(parts) >= 3 Then
             If parts(1) = method Then
                gClinic = parts(0)
                localYear = parts(2)
                
                If yearDict.Exists(localYear) And clinicList.Exists(gClinic) Then
                    yckey = localYear & "_" & Format(gClinic, "00") & "_" & method
                    If yearClinicSumDict.Exists(yckey) Then
                        yearClinicSumDict(yckey) = yearClinicSumDict(yckey) + ET_Count(k)
                    Else
                        yearClinicSumDict.Add yckey, ET_Count(k)
                    End If
                End If
            End If
        End If
    Next k
Next method


' === 出力設定 ===
Dim methodMap As Object
Set methodMap = CreateObject("Scripting.Dictionary")
methodMap.Add "1BT", Array(2, False)
methodMap.Add "2BT", Array(4, True)
methodMap.Add "2StepET", Array(6, True)
methodMap.Add "1+2分割胚", Array(8, "mixed")
methodMap.Add "1想定外STAGE", Array(5, False)
methodMap.Add "2想定外STAGE", Array(6, True)
methodMap.Add "混在：1想定外 + 他", Array(7, True)

' 年度を新しい順に並び替え
' 年度を昇順にソート
Call QuickSort(yearArray, LBound(yearArray), UBound(yearArray))

' ソート後、逆順に入れ替え（新しい年度順）
Dim sortedYears() As Variant
Dim n As Long

n = UBound(yearArray) - LBound(yearArray) + 1
ReDim sortedYears(0 To n - 1)

For i = 0 To n - 1
    sortedYears(i) = yearArray(UBound(yearArray) - i)
Next i

' === 出力処理 ===
Dim yearIndex As Long, clinicIndex As Long
For yearIndex = LBound(sortedYears) To UBound(sortedYears)
    Dim yearItem As Variant: yearItem = sortedYears(yearIndex)
    Dim rowBase As Long: rowBase = 16 + yearIndex * 9

    clinicIndex = 0
    For Each clinicItem In clinicList.keys
        Dim clinicCode As String: clinicCode = Format(clinicItem, "00")
        Dim colStart As Long: colStart = 19 + clinicIndex * 15 ' M列スタート

        Dim totalWithCorrection As Double: totalWithCorrection = 0
        Dim totalNoCorrection As Double: totalNoCorrection = 0

        ' 分類ごとに出力
        For Each method In methodMap.keys
            Dim offset As Long: offset = methodMap(method)(0)
            Dim applyCorrection As Variant: applyCorrection = methodMap(method)(1)

            Dim valueWithCorrection As Double: valueWithCorrection = 0
            Dim valueRaw As Double: valueRaw = 0

            If method = "1+2分割胚" Then
                Dim v1 As Double: v1 = 0
                Dim v2 As Double: v2 = 0
                If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "1分割胚") Then
                    v1 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "1分割胚")
                End If
                If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "2分割胚") Then
                    v2 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "2分割胚")
                End If
                valueWithCorrection = v1 + v2 / 2
                valueRaw = v1 + v2
            Else
                Dim key As String: key = yearItem & "_" & clinicCode & "_" & method
                If yearClinicSumDict.Exists(key) Then
                    valueRaw = yearClinicSumDict(key)
                    valueWithCorrection = IIf(applyCorrection = True, valueRaw / 2, valueRaw)
                End If
            End If
            
            Dim outKey As String: outKey = yearItem & "_" & Format(clinicItem, "00") & "_" & method

' 出力時に分岐
If method <> "1想定外STAGE" And method <> "2想定外STAGE" And method <> "混在：1想定外 + 他" Then

            ' 出力（補正あり（件数）：上段、補正なし（卵数）：下段）
            wsSummary.Cells(rowBase, colStart + offset).value = valueWithCorrection
            wsSummary.Cells(rowBase + 1, colStart + offset).value = valueRaw
            
             ' グローバル変数に格納
             globalET_Count(outKey) = valueWithCorrection
             globalEgg_Count(outKey) = valueRaw
             
            End If

            ' === 総合値（補正あり）の加算 ===
totalWithCorrection = totalWithCorrection + valueWithCorrection

' === 総合値（補正なし）の加算 ===
totalNoCorrection = totalNoCorrection + valueRaw

        Next method

        ' 総合値（0列目）
        wsSummary.Cells(rowBase, colStart).value = totalWithCorrection
        wsSummary.Cells(rowBase + 1, colStart).value = totalNoCorrection
        
        ' グローバル変数に格納
        outKey = yearItem & "_" & Format(clinicItem, "00") & "_All"
             globalET_Count(outKey) = totalWithCorrection
             globalEgg_Count(outKey) = totalNoCorrection
             
         ' --- 想定外系合計の出力 ---
        Dim unexpected1 As Double, unexpected2 As Double, mixed As Double
        unexpected1 = 0: unexpected2 = 0: mixed = 0

        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "1想定外STAGE") Then
            unexpected1 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "1想定外STAGE")
        End If
        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "2想定外STAGE") Then
            unexpected2 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "2想定外STAGE")
        End If
        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "混在：1想定外 + 他") Then
            mixed = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "混在：1想定外 + 他")
        End If

        Dim valueWithCorrectionU As Double, valueRawU As Double
        valueWithCorrectionU = unexpected1 + unexpected2 / 2 + mixed / 2
        valueRawU = unexpected1 + unexpected2 + mixed

        ' 分割胚(列番号8)の2列隣 = offset 10
        wsSummary.Cells(rowBase, colStart + 10).value = valueWithCorrectionU
        wsSummary.Cells(rowBase + 1, colStart + 10).value = valueRawU

        clinicIndex = clinicIndex + 1
    Next clinicItem
Next yearIndex


'' === 全期間 × ET方法ごとの合計値を記録・出力 ===

Dim totalRaw As Object: Set totalRaw = CreateObject("Scripting.Dictionary")
Dim totalCorrected As Object: Set totalCorrected = CreateObject("Scripting.Dictionary")

' 出力対象（E列?）→ 見せたい分類のみ
Dim outputMethods As Variant
outputMethods = Array("1BT", "2BT", "2StepET", "分割胚")

'' 全体集計対象（D列：総合に含める分類すべて）
'Dim allMethods As Variant
'allMethods = Array("1BT", "2BT", "2StepET", "1分割胚", "2分割胚", "1想定外STAGE", "2想定外STAGE", "混在：1想定外 + 他")

' 2で割る分類
Dim correctHalfList As Variant
correctHalfList = Array("2BT", "2StepET", "2分割胚", "2想定外STAGE", "混在：1想定外 + 他")

Dim raw As Double, corrected As Double

' === 件数集計（全分類） ===
For Each method In methodList
    raw = 0
    For Each k In ET_Count.keys
        If InStr(k, method) > 0 Then raw = raw + ET_Count(k)
    Next k
    totalRaw(method) = raw
    If Not IsError(Application.Match(method, correctHalfList, 0)) Then
        totalCorrected(method) = raw / 2
    Else
        totalCorrected(method) = raw
    End If
Next method

' === 総合（補正あり／なし） ===
Dim sumRaw As Double: sumRaw = 0
Dim sumCorrected As Double: sumCorrected = 0
For Each method In methodList
    sumRaw = sumRaw + totalRaw(method)
    sumCorrected = sumCorrected + totalCorrected(method)
Next method

' === 出力処理 ===
Dim ws As Worksheet: Set ws = wsSummary
Dim baseRow As Long: baseRow = 7
 baseCol = 4  ' D列

' 総合値をD列へ出力
ws.Cells(baseRow, baseCol).value = sumCorrected
ws.Cells(baseRow + 1, baseCol).value = sumRaw

        ' グローバル変数に格納
        outKey = "AllClinic" & "_Allmethod"
        globalET_Count(outKey) = sumCorrected
        globalEgg_Count(outKey) = sumRaw


' 出力対象のみを右に並べて出力（E列-）
For i = 0 To UBound(outputMethods)
    method = outputMethods(i)
    If method = "分割胚" Then
        ws.Cells(baseRow, baseCol + 2 + i * 2).value = totalCorrected("1分割胚") + totalCorrected("2分割胚")
        ws.Cells(baseRow + 1, baseCol + 2 + i * 2).value = totalRaw("1分割胚") + totalRaw("2分割胚")
        
         ' グローバル変数に格納
        outKey = "AllClinic" & "_" & method
        globalET_Count(outKey) = totalCorrected("1分割胚") + totalCorrected("2分割胚")
        globalEgg_Count(outKey) = totalRaw("1分割胚") + totalRaw("2分割胚")
        
    Else
        ws.Cells(baseRow, baseCol + 2 + i * 2).value = totalCorrected(method)
        ws.Cells(baseRow + 1, baseCol + 2 + i * 2).value = totalRaw(method)
        
        ' グローバル変数に格納
        outKey = "AllClinic" & "_" & method
        globalET_Count(outKey) = totalCorrected(method)
        globalEgg_Count(outKey) = totalRaw(method)
    
    End If
Next i

' === 想定外合算の出力 ===
unexpected1 = 0: unexpected2 = 0: mixed = 0

If totalRaw.Exists("1想定外STAGE") Then unexpected1 = totalRaw("1想定外STAGE")
If totalRaw.Exists("2想定外STAGE") Then unexpected2 = totalRaw("2想定外STAGE")
If totalRaw.Exists("混在：1想定外 + 他") Then mixed = totalRaw("混在：1想定外 + 他")

valueWithCorrectionU = 0
valueRawU = 0

valueWithCorrectionU = unexpected1 + unexpected2 / 2 + mixed / 2
valueRawU = unexpected1 + unexpected2 + mixed

' 分割胚（=baseCol + 6）の2列右 → baseCol + 8
ws.Cells(baseRow, baseCol + 10).value = valueWithCorrectionU
ws.Cells(baseRow + 1, baseCol + 10).value = valueRawU



'' === 各年度 × ET方法ごとの合計値を記録 ===

 baseRow = 16
 baseCol = 4

For i = 0 To UBound(sortedYears)
    year = sortedYears(i)

    Dim countDict As Object: Set countDict = CreateObject("Scripting.Dictionary")
    Dim eggDict As Object: Set eggDict = CreateObject("Scripting.Dictionary")
    Dim ET_Eggs As Object: Set ET_Eggs = CreateObject("Scripting.Dictionary")
    Dim keys: keys = Array("All", "1BT", "2BT", "2StepET", "Cleavage")
    For Each k In keys: countDict(k) = 0: eggDict(k) = 0: Next

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 3 And parts(2) = year Then
            For Each m In methodList
                If InStr(k, m) > 0 Then
                    Dim cnt As Double: cnt = ET_Count(k)
                    Dim egg As Double: egg = cnt
                    Dim half As Boolean: half = Not IsError(Application.Match(m, correctHalfList, 0))

                    ' All
                    countDict("All") = countDict("All") + IIf(half, cnt / 2, cnt)
                    eggDict("All") = eggDict("All") + egg

                    ' 個別
                    If m = "1BT" Then countDict("1BT") = countDict("1BT") + cnt: eggDict("1BT") = eggDict("1BT") + egg
                    If m = "2BT" Then countDict("2BT") = countDict("2BT") + cnt / 2: eggDict("2BT") = eggDict("2BT") + egg
                    If m = "2StepET" Then countDict("2StepET") = countDict("2StepET") + cnt / 2: eggDict("2StepET") = eggDict("2StepET") + egg
                    If m = "1分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt: eggDict("Cleavage") = eggDict("Cleavage") + egg
                    If m = "2分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt / 2: eggDict("Cleavage") = eggDict("Cleavage") + egg
                End If
            Next
        End If
    Next

    ' 出力（9行ごと）
 r = baseRow + i * 9
    For j = 0 To 4
        ws.Cells(r, baseCol + j * 2).value = countDict(keys(j))
        ws.Cells(r + 1, baseCol + j * 2).value = eggDict(keys(j))
        
        ' グローバル変数に格納
        outKey = year & "_" & "AllClinic" & keys(j)
        globalET_Count(outKey) = countDict(keys(j))
        globalEgg_Count(outKey) = eggDict(keys(j))

    Next j
    
    
    ' === 想定外3分類の合算出力 ===
    unexp1 = 0
    unexp2 = 0
    mixed = 0

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 2 Then
           method = parts(1)
            Dim ym As String: ym = parts(2)
            If Left(ym, 4) = year Then
                Select Case method
                    Case "1想定外STAGE": unexp1 = unexp1 + ET_Count(k)
                    Case "2想定外STAGE": unexp2 = unexp2 + ET_Count(k)
                    Case "混在：1想定外 + 他": mixed = mixed + ET_Count(k)
                End Select
            End If
        End If
    Next

    totalC = unexp1 + unexp2 / 2 + mixed / 2
    totalR = unexp1 + unexp2 + mixed

    ws.Cells(r, baseCol + 10).value = totalC
    ws.Cells(r + 1, baseCol + 10).value = totalR
    
Next i


'全期間×各院

Dim lastYear As String
lastYear = yearArray(UBound(yearArray)) - 1  ' 前年度

Dim cIdx As Variant
 baseRow = 7   ' 件数：L7（行7）
 baseCol = 19  ' 列L（12）
 
c = 0

For Each cIdx In clinicList.keys
    clinic = cIdx

     Set countDict = CreateObject("Scripting.Dictionary")
    Set eggDict = CreateObject("Scripting.Dictionary")
    Dim etType As Variant
    For Each etType In keys: countDict(etType) = 0: eggDict(etType) = 0: Next

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 3 Then
            year = parts(2)
            If parts(0) = clinic Then
                For Each m In methodList
                    If InStr(k, m) > 0 Then
                        cnt = ET_Count(k)
                        egg = cnt  ' 卵数は補正なし
                         half = Not IsError(Application.Match(m, correctHalfList, 0))

                        ' All
                        countDict("All") = countDict("All") + IIf(half, cnt / 2, cnt)
                        eggDict("All") = eggDict("All") + egg

                        ' 個別
                        If m = "1BT" Then countDict("1BT") = countDict("1BT") + cnt: eggDict("1BT") = eggDict("1BT") + egg
                        If m = "2BT" Then countDict("2BT") = countDict("2BT") + cnt / 2: eggDict("2BT") = eggDict("2BT") + egg
                        If m = "2StepET" Then countDict("2StepET") = countDict("2StepET") + cnt / 2: eggDict("2StepET") = eggDict("2StepET") + egg
                        If m = "1分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt: eggDict("Cleavage") = eggDict("Cleavage") + egg
                        If m = "2分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt / 2: eggDict("Cleavage") = eggDict("Cleavage") + egg
                    End If
                Next
            End If
        End If
    Next

    ' 出力（8列おきに右へ）
    Dim colOffset As Long: colOffset = baseCol + c * 15
    For j = 0 To 4
        ws.Cells(baseRow, colOffset + j * 2).value = countDict(keys(j))    ' 件数
        ws.Cells(baseRow + 1, colOffset + j * 2).value = eggDict(keys(j))  ' 卵数（1行下）
        
        ' グローバル変数に格納
        outKey = Format(clinic, "00") & "_" & keys(j)
        globalET_Count(outKey) = countDict(keys(j))
        globalEgg_Count(outKey) = eggDict(keys(j))
        
    Next j
    
        ' === 想定外3分類の合算（クリニック単位・全期間） ===
    unexp1 = 0
    unexp2 = 0
    mixed = 0

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 2 Then
            Dim cl As String: cl = parts(0)
            method = parts(1)

            If cl = clinic Then
                Select Case method
                    Case "1想定外STAGE": unexp1 = unexp1 + ET_Count(k)
                    Case "2想定外STAGE": unexp2 = unexp2 + ET_Count(k)
                    Case "混在：1想定外 + 他": mixed = mixed + ET_Count(k)
                End Select
            End If
        End If
    Next

    totalC = unexp1 + unexp2 / 2 + mixed / 2
    totalR = unexp1 + unexp2 + mixed

    ws.Cells(baseRow, colOffset + 10).value = totalC
    ws.Cells(baseRow + 1, colOffset + 10).value = totalR
    
     c = c + 1
Next cIdx

End Sub

Sub ET04_hCG_Counts()

    Dim wsPivot As Worksheet
    Dim wsSummary As Worksheet
    Dim pt As pivotTable
    Dim lastCol As Long, lastRow As Long
    Dim methodRow As Long, clinicRow As Long
    Dim yearCol As Long
    Dim totalRow As Long
    Dim colLabel1 As String, colLabel2 As String
    Dim prevLabel1 As String
    Dim value As Variant
    Dim c As Long, r As Long
    Dim totalSum As Double
    Dim currentRowOffset As Long
    Dim yearmonth As Variant, year As Variant, month As Variant
    Dim cell As Range
    Dim methodName As Variant
    Dim baseCol As Long, baseMethodCol As Long
    Dim currentYear As Variant
    Dim yearList As Collection
    Dim yearArray() As Variant
    Dim i As Long, j As Long, tmp As Variant
    Dim yearExists As Boolean
    Dim hospitalMap As Object
    Dim sortedHospitals As Variant
    Dim hospitalName As Variant
    Dim clinicID As String
    Dim hospitalIndex As Long
  
    ' ピボットシートと出力先シートの設定
    Set wsPivot = ThisWorkbook.Sheets("S09_科学的妊娠判定")
    Set wsSummary = ThisWorkbook.Sheets("移植サマリー")
    Set pt = wsPivot.PivotTables("P09_科学的妊娠判定")

    ' ピボットの行・列情報を取得
    yearCol = pt.TableRange2.Column

    ETmethodRow = pt.RowRange.row - 2
    clinicRow = pt.RowRange.row - 1
    rowYear = pt.RowRange.row + 1
    Dim dataStartRow As Long: dataStartRow = rowYear ' データ本体の開始行

    lastCol = pt.TableRange2.Columns.count + pt.TableRange2.Column - 1
    lastRow = pt.TableRange2.Rows.count + pt.TableRange2.row - 1
    totalRow = lastRow
    
     ' 年度リストを作成
    yearArray = GetSortedYearsFromPivot()

    ' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
    Dim yearDict As Object
    Set yearDict = CreateObject("Scripting.Dictionary")

    For i = UBound(yearArray) To LBound(yearArray) Step -1
        If Not yearDict.Exists(yearArray(i)) Then
            yearDict.Add yearArray(i), True
        End If
    Next i


'    ' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
'Dim yearDict As Object
'Set yearDict = CreateObject("Scripting.Dictionary")
'
'' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
'On Error Resume Next
'For Each cell In wsPivot.Range(wsPivot.Cells(rowYear, yearCol), wsPivot.Cells(totalRow - 1, yearCol))
'    If cell.IndentLevel = 0 And IsNumeric(cell.value) Then
'        If Not yearDict.Exists(cell.value) Then
'            yearDict.Add cell.value, 1 ' 値をキーとして、値は任意（ここでは 1）
'        End If
'    End If
'Next cell
'On Error GoTo 0
'
'' 年度リストが空なら終了
'If yearDict.Count = 0 Then Exit Sub
'
'' Dictionary のキーを配列に変換して昇順にソート
'yearArray = yearDict.keys
'
'' ソート（昇順）
'Call QuickSort(yearArray, LBound(yearArray), UBound(yearArray))

'' ソート後の年を使用する場合
'For i = LBound(yearArray) To UBound(yearArray)
'    Debug.Print yearArray(i) ' 年度を表示
'Next i

    ' 院マップと識別番号でソートされた院名リストを取得
    Set hospitalMap = GetHospitalMap()
    sortedHospitals = SortKeysByValue(hospitalMap)

    ' データ列の開始列
    Dim firstDataCol As Long: firstDataCol = pt.TableRange2.Column
    
        ' データ集計
     ' 集計用ディクショナリ
    Dim ET_Count As Object
    Set ET_Count = CreateObject("Scripting.Dictionary")
    
    For r = dataStartRow To lastRow - 1 ' 最終行（総計）は除外
        yearmonth = wsPivot.Cells(r, firstDataCol).value
        If IsNumeric(yearmonth) Then
            year = yearmonth
        Else
            month = yearmonth
            yearMonthKey = year & "_" & month

            For c = firstDataCol To lastCol - 1 ' 最終列（総計）は除外
                If wsPivot.Cells(ETmethodRow, c).value <> "" Then prevMethod = Trim(wsPivot.Cells(ETmethodRow, c).value)
                method = prevMethod

                If wsPivot.Cells(clinicRow, c).value <> "" Then prevClinic = Trim(wsPivot.Cells(clinicRow, c).value)
                clinic = prevClinic

                value = wsPivot.Cells(r, c).value

                If method <> "" And clinic <> "" And IsNumeric(value) Then
                    Dim uniqueKey As String
                    
                    uniqueKey = Format(clinic, "00") & "_" & method & "_" & yearMonthKey

                    If Not ET_Count.Exists(uniqueKey) Then
                        ET_Count.Add uniqueKey, value
                    Else
                        ET_Count(uniqueKey) = ET_Count(uniqueKey) + value
                    End If
                End If
            Next c
        End If
    Next r


    ' === 院識別番号一覧を取得 ===
    Dim clinicList As Object
    Set clinicList = CreateObject("Scripting.Dictionary")
    
For i = LBound(sortedHospitals) To UBound(sortedHospitals)
    Dim code As String
    code = Format(i + 1, "00")  ' "01", "02", ...
    
    If Not clinicList.Exists(code) Then
        clinicList.Add code, True
    End If
Next i

' === 各年度 × 院別 × 移植方法の合算値を出力（補正あり＆なし）===
Dim yearClinicSumDict As Object
Set yearClinicSumDict = CreateObject("Scripting.Dictionary")

Dim methodList As Variant
methodList = Array("1BT", "2BT", "2StepET", "1分割胚", "2分割胚", "1想定外STAGE", "2想定外STAGE", "混在：1想定外 + 他")

' 集計：分類ごとに件数を格納
For Each method In methodList
    For Each k In ET_Count.keys
'        If InStr(k, method) > 0 Then
            parts = Split(k, "_")
            If UBound(parts) >= 3 Then
             If parts(1) = method Then
                gClinic = parts(0)
                localYear = parts(2)
                
                If yearDict.Exists(localYear) And clinicList.Exists(gClinic) Then
                    yckey = localYear & "_" & Format(gClinic, "00") & "_" & method
                    If yearClinicSumDict.Exists(yckey) Then
                        yearClinicSumDict(yckey) = yearClinicSumDict(yckey) + ET_Count(k)
                    Else
                        yearClinicSumDict.Add yckey, ET_Count(k)
                    End If
                End If
            End If
        End If
    Next k
Next method


' === 出力設定 ===
Dim methodMap As Object
Set methodMap = CreateObject("Scripting.Dictionary")
methodMap.Add "1BT", Array(1, False)
methodMap.Add "2BT", Array(2, True)
methodMap.Add "2StepET", Array(3, True)
methodMap.Add "1+2分割胚", Array(4, "mixed")
methodMap.Add "1想定外STAGE", Array(5, False)
methodMap.Add "2想定外STAGE", Array(6, True)
methodMap.Add "混在：1想定外 + 他", Array(7, True)

' 年度を新しい順に並び替え
' 年度を昇順にソート
Call QuickSort(yearArray, LBound(yearArray), UBound(yearArray))

' ソート後、逆順に入れ替え（新しい年度順）
Dim sortedYears() As Variant
Dim n As Long

n = UBound(yearArray) - LBound(yearArray) + 1
ReDim sortedYears(0 To n - 1)

For i = 0 To n - 1
    sortedYears(i) = yearArray(UBound(yearArray) - i)
Next i

' === 出力処理 ===
Dim yearIndex As Long, clinicIndex As Long
For yearIndex = LBound(sortedYears) To UBound(sortedYears)
    Dim yearItem As Variant: yearItem = sortedYears(yearIndex)
    Dim rowBase As Long: rowBase = 18 + yearIndex * 9

    clinicIndex = 0
    For Each clinicItem In clinicList.keys
        Dim clinicCode As String: clinicCode = Format(clinicItem, "00")
        Dim colStart As Long: colStart = 19 + clinicIndex * 15 ' M列スタート

        Dim totalWithCorrection As Double: totalWithCorrection = 0
        Dim totalNoCorrection As Double: totalNoCorrection = 0

        ' 分類ごとに出力
        For Each method In methodMap.keys
            Dim offset As Long: offset = methodMap(method)(0)
            Dim applyCorrection As Variant: applyCorrection = methodMap(method)(1)

            Dim valueWithCorrection As Double: valueWithCorrection = 0
            Dim valueRaw As Double: valueRaw = 0

            If method = "1+2分割胚" Then
                Dim v1 As Double: v1 = 0
                Dim v2 As Double: v2 = 0
                If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "1分割胚") Then
                    v1 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "1分割胚")
                End If
                If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "2分割胚") Then
                    v2 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "2分割胚")
                End If
                valueWithCorrection = v1 + v2 / 2
                valueRaw = v1 + v2
            Else
                Dim key As String: key = yearItem & "_" & clinicCode & "_" & method
                If yearClinicSumDict.Exists(key) Then
                    valueRaw = yearClinicSumDict(key)
                    valueWithCorrection = IIf(applyCorrection = True, valueRaw / 2, valueRaw)
                End If
            End If
            
            Dim outKey As String: outKey = yearItem & "_" & Format(clinicItem, "00") & "_" & method

' 出力時に分岐
If method <> "1想定外STAGE" And method <> "2想定外STAGE" And method <> "混在：1想定外 + 他" Then
                
    If valueWithCorrection <> 0 And hCG_globalET_Count_Denominator(outKey) <> 0 Then

            ' 出力（補正あり（件数）：上段、補正なし（卵数）：下段）
            wsSummary.Cells(rowBase, colStart + offset * 2).NumberFormat = "0.0"
            wsSummary.Cells(rowBase, colStart + offset * 2).value = Round(valueWithCorrection / hCG_globalET_Count_Denominator(outKey) * 100, 1)
            wsSummary.Cells(rowBase, colStart + offset * 2 + 1).value = "'" & valueWithCorrection & "/" & hCG_globalET_Count_Denominator(outKey)

'            wsSummary.Cells(rowBase + 1, colStart + offset).value = valueRaw

                    Else
                    wsSummary.Cells(rowBase, colStart + offset * 2).NumberFormat = "0.0"
                    wsSummary.Cells(rowBase, colStart + offset * 2).value = 0
                    wsSummary.Cells(rowBase, colStart + offset * 2 + 1).value = "'" & valueWithCorrection & "/" & hCG_globalET_Count_Denominator(outKey)

                End If
             
            End If

            ' === 総合値（補正あり）の加算 ===
totalWithCorrection = totalWithCorrection + valueWithCorrection

' === 総合値（補正なし）の加算 ===
totalNoCorrection = totalNoCorrection + valueRaw

        Next method
        
        outKey = yearItem & "_" & Format(clinicItem, "00") & "_All"
        
        If totalWithCorrection <> 0 And hCG_globalET_Count_Denominator(outKey) <> 0 Then

        ' 総合値（0列目）
        wsSummary.Cells(rowBase, colStart + offset).NumberFormat = "0.0"
        wsSummary.Cells(rowBase, colStart).value = Round(totalWithCorrection / hCG_globalET_Count_Denominator(outKey) * 100, 1)
        wsSummary.Cells(rowBase, colStart + 1).value = "'" & totalWithCorrection & "/" & hCG_globalET_Count_Denominator(outKey)

'        wsSummary.Cells(rowBase + 1, colStart).value = totalNoCorrection

        Else
          wsSummary.Cells(rowBase, colStart).NumberFormat = "0.0"
          wsSummary.Cells(rowBase, colStart).value = 0
          wsSummary.Cells(rowBase, colStart + 1).value = "'" & totalWithCorrection & "/" & hCG_globalET_Count_Denominator(outKey)
        End If
        
                 ' --- 想定外系合計の出力 ---
        Dim unexpected1 As Double, unexpected2 As Double, mixed As Double
        unexpected1 = 0: unexpected2 = 0: mixed = 0

        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "1想定外STAGE") Then
            unexpected1 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "1想定外STAGE")
        End If
        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "2想定外STAGE") Then
            unexpected2 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "2想定外STAGE")
        End If
        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "混在：1想定外 + 他") Then
            mixed = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "混在：1想定外 + 他")
        End If

        Dim valueWithCorrectionU As Double, valueRawU As Double
        valueWithCorrectionU = unexpected1 + unexpected2 / 2 + mixed / 2
        valueRawU = unexpected1 + unexpected2 + mixed

        outKey = yearItem & "_" & Format(clinicItem, "00") & "_unexpected"
        
        If valueWithCorrectionU <> 0 And hCG_globalET_Count_Denominator(outKey) <> 0 Then

'         分割胚(列番号8)の2列隣 = offset 10
        wsSummary.Cells(rowBase, colStart + 10).NumberFormat = "0.0"
        wsSummary.Cells(rowBase, colStart + 10).value = Round(valueWithCorrectionU / hCG_globalET_Count_Denominator(outKey) * 100, 1)
        wsSummary.Cells(rowBase, colStart + 11).value = "'" & valueWithCorrectionU & "/" & hCG_globalET_Count_Denominator(outKey)

        Else
          wsSummary.Cells(rowBase, colStart + 10).NumberFormat = "0.0"
          wsSummary.Cells(rowBase, colStart + 10).value = 0
          wsSummary.Cells(rowBase, colStart + 11).value = "'" & valueWithCorrectionU & "/" & hCG_globalET_Count_Denominator(outKey)
        End If
         
        clinicIndex = clinicIndex + 1
    Next clinicItem
Next yearIndex


'' === 全期間 × ET方法ごとの合計値を記録・出力 ===

Dim totalRaw As Object: Set totalRaw = CreateObject("Scripting.Dictionary")
Dim totalCorrected As Object: Set totalCorrected = CreateObject("Scripting.Dictionary")

' 出力対象（E列?）→ 見せたい分類のみ
Dim outputMethods As Variant
outputMethods = Array("1BT", "2BT", "2StepET", "分割胚")

'' 全体集計対象（D列：総合に含める分類すべて）
'Dim allMethods As Variant
'allMethods = Array("1BT", "2BT", "2StepET", "1分割胚", "2分割胚", "1想定外STAGE", "2想定外STAGE", "混在：1想定外 + 他")

' 2で割る分類
Dim correctHalfList As Variant
correctHalfList = Array("2BT", "2StepET", "2分割胚", "2想定外STAGE", "混在：1想定外 + 他")

Dim raw As Double, corrected As Double

' === 件数集計（全分類） ===
For Each method In methodList
    raw = 0
    For Each k In ET_Count.keys
        If InStr(k, method) > 0 Then raw = raw + ET_Count(k)
    Next k
    totalRaw(method) = raw
    If Not IsError(Application.Match(method, correctHalfList, 0)) Then
        totalCorrected(method) = raw / 2
    Else
        totalCorrected(method) = raw
    End If
Next method

' === 総合（補正あり／なし） ===
Dim sumRaw As Double: sumRaw = 0
Dim sumCorrected As Double: sumCorrected = 0
For Each method In methodList
    sumRaw = sumRaw + totalRaw(method)
    sumCorrected = sumCorrected + totalCorrected(method)
Next method

' === 出力処理 ===
Dim ws As Worksheet: Set ws = wsSummary
Dim baseRow As Long: baseRow = 9
 baseCol = 4  ' D列

' 総合値をD列へ出力
outKey = "AllClinic" & "_Allmethod"

        If sumCorrected <> 0 And hCG_globalET_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(baseRow, baseCol).NumberFormat = "0.0"
        ws.Cells(baseRow, baseCol).value = Round(sumCorrected / hCG_globalET_Count_Denominator(outKey) * 100, 1)
        ws.Cells(baseRow, baseCol + 1).value = "'" & sumCorrected & "/" & hCG_globalET_Count_Denominator(outKey)
        'ws.Cells(baseRow + 1, baseCol).value = sumRaw

        Else
          wsSummary.Cells(baseRow, baseCol).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, baseCol).value = 0
          wsSummary.Cells(baseRow, baseCol + 1).value = "0/0"
        End If

'        ' グローバル変数に格納
'        outKey = "AllClinic" & "_Allmethod"
'        globalET_Count(outKey) = sumCorrected
'        globalEgg_Count(outKey) = sumRaw


' 出力対象のみを右に並べて出力（E列-）
For i = 0 To UBound(outputMethods)
    method = outputMethods(i)
    If method = "分割胚" Then
    
    Dim CountValue As Variant
    Dim EggValue As Variant
    
    outKey = "AllClinic" & "_" & method
    
        CountValue = totalCorrected("1分割胚") + totalCorrected("2分割胚")
        EggValue = totalRaw("1分割胚") + totalRaw("2分割胚")
        
        If CountValue <> 0 And hCG_globalET_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(baseRow, baseCol + 2 + i * 2).NumberFormat = "0.0"
        ws.Cells(baseRow, baseCol + 2 + i * 2).value = Round(CountValue / hCG_globalET_Count_Denominator(outKey) * 100, 1)
        ws.Cells(baseRow, baseCol + 3 + i * 2).value = "'" & CountValue & "/" & hCG_globalET_Count_Denominator(outKey)
'        ws.Cells(baseRow + 1, baseCol + 1 + i).value = EggValue
        
        
         ' グローバル変数に格納
'        outKey = "AllClinic" & "_" & method
'        globalET_Count(outKey) = totalCorrected("1分割胚") + totalCorrected("2分割胚")
'        globalEgg_Count(outKey) = totalRaw("1分割胚") + totalRaw("2分割胚")
        
        Else
          wsSummary.Cells(baseRow, baseCol + 2 + i * 2).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, baseCol + 2 + i * 2).value = 0
          wsSummary.Cells(baseRow, baseCol + 3 + i * 2).value = "0/0"
        End If
        
    Else
        outKey = "AllClinic" & "_" & method
        
        If totalCorrected(method) <> 0 And hCG_globalET_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(baseRow, baseCol + 2 + i * 2).NumberFormat = "0.0"
        ws.Cells(baseRow, baseCol + 2 + i * 2).value = Round(totalCorrected(method) / hCG_globalET_Count_Denominator(outKey) * 100, 1)
        ws.Cells(baseRow, baseCol + 3 + i * 2).value = "'" & totalCorrected(method) & "/" & hCG_globalET_Count_Denominator(outKey)

'        ws.Cells(baseRow + 1, baseCol + 1 + i).value = totalRaw(method)
        
        ' グローバル変数に格納
'        outKey = "AllClinic" & "_" & method
'        globalET_Count(outKey) = totalCorrected(method)
'        globalEgg_Count(outKey) = totalRaw(method)
        
        Else
          wsSummary.Cells(baseRow, baseCol + 2 + i * 2).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, baseCol + 2 + i * 2).value = 0
          wsSummary.Cells(baseRow, baseCol + 3 + i * 2).value = "'" & totalCorrected(method) & "/" & hCG_globalET_Count_Denominator(outKey)
        End If
    End If
Next i

' === 想定外合算の出力 ===
unexpected1 = 0: unexpected2 = 0: mixed = 0

If totalRaw.Exists("1想定外STAGE") Then unexpected1 = totalRaw("1想定外STAGE")
If totalRaw.Exists("2想定外STAGE") Then unexpected2 = totalRaw("2想定外STAGE")
If totalRaw.Exists("混在：1想定外 + 他") Then mixed = totalRaw("混在：1想定外 + 他")

valueWithCorrectionU = 0
valueRawU = 0

valueWithCorrectionU = unexpected1 + unexpected2 / 2 + mixed / 2
valueRawU = unexpected1 + unexpected2 + mixed

outKey = "AllClinic" & "_" & "unexpected"

If valueWithCorrectionU <> 0 And hCG_globalET_Count_Denominator(outKey) <> 0 Then

'' 分割胚（=baseCol + 6）の2列右 → baseCol + 8
wsSummary.Cells(baseRow, baseCol + 10).NumberFormat = "0.0"
ws.Cells(baseRow, baseCol + 10).value = Round(valueWithCorrectionU / hCG_globalET_Count_Denominator(outKey) * 100, 1)
wsSummary.Cells(baseRow, baseCol + 11).value = "'" & valueWithCorrectionU & "/" & hCG_globalET_Count_Denominator(outKey)
        
        Else
          wsSummary.Cells(baseRow, baseCol + 10).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, baseCol + 10).value = 0
          wsSummary.Cells(baseRow, baseCol + 11).value = "'" & valueWithCorrectionU & "/" & hCG_globalET_Count_Denominator(outKey)
        End If


'' === 各年度 × ET方法ごとの合計値を記録 ===

 baseRow = 18
 baseCol = 4

For i = 0 To UBound(sortedYears)
    year = sortedYears(i)

    Dim countDict As Object: Set countDict = CreateObject("Scripting.Dictionary")
    Dim eggDict As Object: Set eggDict = CreateObject("Scripting.Dictionary")
    Dim ET_Eggs As Object: Set ET_Eggs = CreateObject("Scripting.Dictionary")
    Dim keys: keys = Array("All", "1BT", "2BT", "2StepET", "Cleavage")
    For Each k In keys: countDict(k) = 0: eggDict(k) = 0: Next

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 3 And parts(2) = year Then
            For Each m In methodList
                If InStr(k, m) > 0 Then
                    Dim cnt As Double: cnt = ET_Count(k)
                    Dim egg As Double: egg = cnt
                    Dim half As Boolean: half = Not IsError(Application.Match(m, correctHalfList, 0))

                    ' All
                    countDict("All") = countDict("All") + IIf(half, cnt / 2, cnt)
                    eggDict("All") = eggDict("All") + egg

                    ' 個別
                    If m = "1BT" Then countDict("1BT") = countDict("1BT") + cnt: eggDict("1BT") = eggDict("1BT") + egg
                    If m = "2BT" Then countDict("2BT") = countDict("2BT") + cnt / 2: eggDict("2BT") = eggDict("2BT") + egg
                    If m = "2StepET" Then countDict("2StepET") = countDict("2StepET") + cnt / 2: eggDict("2StepET") = eggDict("2StepET") + egg
                    If m = "1分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt: eggDict("Cleavage") = eggDict("Cleavage") + egg
                    If m = "2分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt / 2: eggDict("Cleavage") = eggDict("Cleavage") + egg
                End If
            Next
        End If
    Next

    ' 出力（9行ごと）
 r = baseRow + i * 9
    For j = 0 To 4
        outKey = year & "_" & "AllClinic" & keys(j)
        
        If countDict(keys(j)) <> 0 And hCG_globalET_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(r, baseCol + j * 2).NumberFormat = "0.0"
        ws.Cells(r, baseCol + j * 2).value = Round(countDict(keys(j)) / hCG_globalET_Count_Denominator(outKey) * 100, 1)
        ws.Cells(r, baseCol + j * 2 + 1).value = "'" & countDict(keys(j)) & "/" & hCG_globalET_Count_Denominator(outKey)
'        ws.Cells(r + 1, baseCol + j).value = eggDict(keys(j))
        
        ' グローバル変数に格納
'        outKey = year & "_" & "AllClinic" & keys(j)
'        globalET_Count(outKey) = countDict(keys(j))
'        globalEgg_Count(outKey) = eggDict(keys(j))

        Else
          wsSummary.Cells(r, baseCol + j * 2).NumberFormat = "0.0"
          wsSummary.Cells(r, baseCol + j * 2).value = 0
          wsSummary.Cells(r, baseCol + j * 2 + 1).value = "'" & countDict(keys(j)) & "/" & hCG_globalET_Count_Denominator(outKey)
        End If

    Next j
    
            ' === 想定外3分類の合算出力 ===
    unexp1 = 0
    unexp2 = 0
    mixed = 0

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 2 Then
           method = parts(1)
            Dim ym As String: ym = parts(2)
            If Left(ym, 4) = year Then
                Select Case method
                    Case "1想定外STAGE": unexp1 = unexp1 + ET_Count(k)
                    Case "2想定外STAGE": unexp2 = unexp2 + ET_Count(k)
                    Case "混在：1想定外 + 他": mixed = mixed + ET_Count(k)
                End Select
            End If
        End If
    Next

    totalC = unexp1 + unexp2 / 2 + mixed / 2
    totalR = unexp1 + unexp2 + mixed
    
    outKey = year & "_" & "AllClinic" & "_unexp"
    
        If totalC <> 0 And hCG_globalET_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(r, baseCol + 10).NumberFormat = "0.0"
        ws.Cells(r, baseCol + 10).value = Round(totalC / hCG_globalET_Count_Denominator(outKey) * 100, 1)
        ws.Cells(r, baseCol + 11).value = "'" & totalC & "/" & hCG_globalET_Count_Denominator(outKey)
        

        Else
          wsSummary.Cells(r, baseCol + 10).NumberFormat = "0.0"
          wsSummary.Cells(r, baseCol + 10).value = 0
          wsSummary.Cells(r, baseCol + 11).value = "'" & totalC & "/" & hCG_globalET_Count_Denominator(outKey)
        End If
Next i


'全期間×各院

'Dim lastYear As String
'lastYear = yearArray(UBound(yearArray)) - 1  ' 前年度

Dim cIdx As Variant
 baseRow = 9   ' 件数：S7（行7）
 baseCol = 19  ' 列S（19）
 
c = 0

For Each cIdx In clinicList.keys
    clinic = cIdx

     Set countDict = CreateObject("Scripting.Dictionary")
    Set eggDict = CreateObject("Scripting.Dictionary")
    Dim etType As Variant
    For Each etType In keys: countDict(etType) = 0: eggDict(etType) = 0: Next

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 3 Then
            year = parts(2)
            If parts(0) = clinic Then
                For Each m In methodList
                    If InStr(k, m) > 0 Then
                        cnt = ET_Count(k)
                        egg = cnt  ' 卵数は補正なし
                         half = Not IsError(Application.Match(m, correctHalfList, 0))

                        ' All
                        countDict("All") = countDict("All") + IIf(half, cnt / 2, cnt)
                        eggDict("All") = eggDict("All") + egg

                        ' 個別
                        If m = "1BT" Then countDict("1BT") = countDict("1BT") + cnt: eggDict("1BT") = eggDict("1BT") + egg
                        If m = "2BT" Then countDict("2BT") = countDict("2BT") + cnt / 2: eggDict("2BT") = eggDict("2BT") + egg
                        If m = "2StepET" Then countDict("2StepET") = countDict("2StepET") + cnt / 2: eggDict("2StepET") = eggDict("2StepET") + egg
                        If m = "1分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt: eggDict("Cleavage") = eggDict("Cleavage") + egg
                        If m = "2分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt / 2: eggDict("Cleavage") = eggDict("Cleavage") + egg
                    End If
                Next
            End If
        End If
    Next

    ' 出力（8列おきに右へ）
    Dim colOffset As Long: colOffset = baseCol + c * 15
    For j = 0 To 4
        outKey = Format(clinic, "00") & "_" & keys(j)
        
        If countDict(keys(j)) <> 0 And hCG_globalET_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(baseRow, colOffset + j * 2).NumberFormat = "0.0"
        ws.Cells(baseRow, colOffset + j * 2).value = Round(countDict(keys(j)) / hCG_globalET_Count_Denominator(outKey) * 100, 1)   ' 件数
        ws.Cells(baseRow, colOffset + j * 2 + 1).value = "'" & countDict(keys(j)) & "/" & hCG_globalET_Count_Denominator(outKey)

'        ws.Cells(baseRow + 1, colOffset + j).value = eggDict(keys(j))    ' 卵数（1行下）
        
        ' グローバル変数に格納
'        outKey = Format(clinic, "00") & "_" & keys(j)
'        globalET_Count(outKey) = countDict(keys(j))
'        globalEgg_Count(outKey) = eggDict(keys(j))

        Else
          wsSummary.Cells(baseRow, colOffset + j * 2).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, colOffset + j * 2).value = 0
          wsSummary.Cells(baseRow, colOffset + j * 2 + 1).value = "'" & countDict(keys(j)) & "/" & hCG_globalET_Count_Denominator(outKey)
        End If
        
    Next j
    
       ' === 想定外3分類の合算（クリニック単位・全期間） ===
    unexp1 = 0
    unexp2 = 0
    mixed = 0

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 2 Then
            Dim cl As String: cl = parts(0)
            method = parts(1)

            If cl = clinic Then
                Select Case method
                    Case "1想定外STAGE": unexp1 = unexp1 + ET_Count(k)
                    Case "2想定外STAGE": unexp2 = unexp2 + ET_Count(k)
                    Case "混在：1想定外 + 他": mixed = mixed + ET_Count(k)
                End Select
            End If
        End If
    Next

    totalC = unexp1 + unexp2 / 2 + mixed / 2
    totalR = unexp1 + unexp2 + mixed
    
         outKey = Format(clinic, "00") & "_" & "unexp"
    
        If totalC <> 0 And hCG_globalET_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(baseRow, colOffset + 10).NumberFormat = "0.0"
        ws.Cells(baseRow, colOffset + 10).value = Round(totalC / hCG_globalET_Count_Denominator(outKey) * 100, 1)
        ws.Cells(baseRow, colOffset + 11).value = "'" & totalC & "/" & hCG_globalET_Count_Denominator(outKey)
        

        Else
          wsSummary.Cells(baseRow, colOffset + 10).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, colOffset + 10).value = 0
          wsSummary.Cells(baseRow, colOffset + 11).value = "'" & totalC & "/" & hCG_globalET_Count_Denominator(outKey)
        End If
    
     c = c + 1
Next cIdx

End Sub

Sub ET03_hCG_Counts_Denominator()

    Dim wsPivot As Worksheet
    Dim wsSummary As Worksheet
    Dim pt As pivotTable
    Dim lastCol As Long, lastRow As Long
    Dim methodRow As Long, clinicRow As Long
    Dim yearCol As Long
    Dim totalRow As Long
    Dim colLabel1 As String, colLabel2 As String
    Dim prevLabel1 As String
    Dim value As Variant
    Dim c As Long, r As Long
    Dim totalSum As Double
    Dim currentRowOffset As Long
    Dim yearmonth As Variant, year As Variant, month As Variant
    Dim cell As Range
    Dim methodName As Variant
    Dim baseCol As Long, baseMethodCol As Long
    Dim currentYear As Variant
    Dim yearList As Collection
    Dim yearArray() As Variant
    Dim i As Long, j As Long, tmp As Variant
    Dim yearExists As Boolean
    Dim hospitalMap As Object
    Dim sortedHospitals As Variant
    Dim hospitalName As Variant
    Dim clinicID As String
    Dim hospitalIndex As Long
       
       
    Set hCG_globalET_Count_Denominator = CreateObject("Scripting.Dictionary")
       

    ' ピボットシートと出力先シートの設定
    Set wsPivot = ThisWorkbook.Sheets("S08_母数_科学的妊娠判定")
    Set wsSummary = ThisWorkbook.Sheets("移植サマリー")
    Set pt = wsPivot.PivotTables("P08_母数_科学的妊娠判定")

    ' ピボットの行・列情報を取得
    yearCol = pt.TableRange2.Column

    ETmethodRow = pt.RowRange.row - 1
    clinicRow = pt.RowRange.row
    rowYear = pt.RowRange.row + 1
    Dim dataStartRow As Long: dataStartRow = rowYear ' データ本体の開始行

    lastCol = pt.TableRange2.Columns.count + pt.TableRange2.Column - 1
    lastRow = pt.TableRange2.Rows.count + pt.TableRange2.row - 1
    totalRow = lastRow

    ' 年度リストを作成
    yearArray = GetSortedYearsFromPivot()

    ' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
    Dim yearDict As Object
    Set yearDict = CreateObject("Scripting.Dictionary")

    For i = UBound(yearArray) To LBound(yearArray) Step -1
        If Not yearDict.Exists(yearArray(i)) Then
            yearDict.Add yearArray(i), True
        End If
    Next i


'' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
'On Error Resume Next
'For Each cell In wsPivot.Range(wsPivot.Cells(rowYear, yearCol), wsPivot.Cells(totalRow - 1, yearCol))
'    If cell.IndentLevel = 0 And IsNumeric(cell.value) Then
'        If Not yearDict.Exists(cell.value) Then
'            yearDict.Add cell.value, 1 ' 値をキーとして、値は任意（ここでは 1）
'        End If
'    End If
'Next cell
'On Error GoTo 0
'
'' 年度リストが空なら終了
'If yearDict.Count = 0 Then Exit Sub
'
'' Dictionary のキーを配列に変換して昇順にソート
'yearArray = yearDict.keys
'
'' ソート（昇順）
'Call QuickSort(yearArray, LBound(yearArray), UBound(yearArray))
'
''' ソート後の年を使用する場合
''For i = LBound(yearArray) To UBound(yearArray)
''    Debug.Print yearArray(i) ' 年度を表示
''Next i

    ' 院マップと識別番号でソートされた院名リストを取得
    Set hospitalMap = GetHospitalMap()
    sortedHospitals = SortKeysByValue(hospitalMap)

    ' データ列の開始列
    Dim firstDataCol As Long: firstDataCol = pt.TableRange2.Column
    
        ' データ集計
     ' 集計用ディクショナリ
    Dim ET_Count As Object
    Set ET_Count = CreateObject("Scripting.Dictionary")
    
    For r = dataStartRow To lastRow - 1 ' 最終行（総計）は除外
        yearmonth = wsPivot.Cells(r, firstDataCol).value
        If IsNumeric(yearmonth) Then
            year = yearmonth
        Else
            month = yearmonth
            yearMonthKey = year & "_" & month

            For c = firstDataCol To lastCol - 1 ' 最終列（総計）は除外
                If wsPivot.Cells(ETmethodRow, c).value <> "" Then prevMethod = Trim(wsPivot.Cells(ETmethodRow, c).value)
                method = prevMethod

                If wsPivot.Cells(clinicRow, c).value <> "" Then prevClinic = Trim(wsPivot.Cells(clinicRow, c).value)
                clinic = prevClinic

                value = wsPivot.Cells(r, c).value

                If method <> "" And clinic <> "" And IsNumeric(value) Then
                    Dim uniqueKey As String
                    
                    uniqueKey = Format(clinic, "00") & "_" & method & "_" & yearMonthKey

                    If Not ET_Count.Exists(uniqueKey) Then
                        ET_Count.Add uniqueKey, value
                    Else
                        ET_Count(uniqueKey) = ET_Count(uniqueKey) + value
                    End If
                End If
            Next c
        End If
    Next r


    ' === 院識別番号一覧を抽出 ===
    Dim clinicList As Object
    Set clinicList = CreateObject("Scripting.Dictionary")
    
For i = LBound(sortedHospitals) To UBound(sortedHospitals)
    Dim code As String
    code = Format(i + 1, "00")  ' "01", "02", ...
    
    If Not clinicList.Exists(code) Then
        clinicList.Add code, True
    End If
Next i


' === 各年度 × 院別 × 移植方法の合算値を出力（補正あり＆なし）===
Dim yearClinicSumDict As Object
Set yearClinicSumDict = CreateObject("Scripting.Dictionary")

Dim methodList As Variant
methodList = Array("1BT", "2BT", "2StepET", "1分割胚", "2分割胚", "1想定外STAGE", "2想定外STAGE", "混在：1想定外 + 他")

' 集計：分類ごとに件数を格納
For Each method In methodList
    For Each k In ET_Count.keys
'        If InStr(k, method) > 0 Then
            parts = Split(k, "_")
            If UBound(parts) >= 3 Then
             If parts(1) = method Then
                gClinic = parts(0)
                localYear = parts(2)
                
                If yearDict.Exists(localYear) And clinicList.Exists(gClinic) Then
                    yckey = localYear & "_" & Format(gClinic, "00") & "_" & method
                    If yearClinicSumDict.Exists(yckey) Then
                        yearClinicSumDict(yckey) = yearClinicSumDict(yckey) + ET_Count(k)
                    Else
                        yearClinicSumDict.Add yckey, ET_Count(k)
                    End If
                End If
            End If
        End If
    Next k
Next method


' === 出力設定 ===
Dim methodMap As Object
Set methodMap = CreateObject("Scripting.Dictionary")
methodMap.Add "1BT", Array(1, False)
methodMap.Add "2BT", Array(2, True)
methodMap.Add "2StepET", Array(3, True)
methodMap.Add "1+2分割胚", Array(4, "mixed")
methodMap.Add "1想定外STAGE", Array(5, False)
methodMap.Add "2想定外STAGE", Array(6, True)
methodMap.Add "混在：1想定外 + 他", Array(7, True)

' 年度を新しい順に並び替え
' 年度を昇順にソート
Call QuickSort(yearArray, LBound(yearArray), UBound(yearArray))

' ソート後、逆順に入れ替え（新しい年度順）
Dim sortedYears() As Variant
Dim n As Long

n = UBound(yearArray) - LBound(yearArray) + 1
ReDim sortedYears(0 To n - 1)

For i = 0 To n - 1
    sortedYears(i) = yearArray(UBound(yearArray) - i)
Next i

' === 出力処理 ===
Dim yearIndex As Long, clinicIndex As Long
For yearIndex = LBound(sortedYears) To UBound(sortedYears)
    Dim yearItem As Variant: yearItem = sortedYears(yearIndex)
    Dim rowBase As Long: rowBase = 16 + yearIndex * 9

    clinicIndex = 0
    For Each clinicItem In clinicList.keys
        Dim clinicCode As String: clinicCode = Format(clinicItem, "00")
        Dim colStart As Long: colStart = 12 + clinicIndex * 8 ' M列スタート

        Dim totalWithCorrection As Double: totalWithCorrection = 0
        Dim totalNoCorrection As Double: totalNoCorrection = 0

        ' 分類ごとに出力
        For Each method In methodMap.keys
            Dim offset As Long: offset = methodMap(method)(0)
            Dim applyCorrection As Variant: applyCorrection = methodMap(method)(1)

            Dim valueWithCorrection As Double: valueWithCorrection = 0
            Dim valueRaw As Double: valueRaw = 0

            If method = "1+2分割胚" Then
                Dim v1 As Double: v1 = 0
                Dim v2 As Double: v2 = 0
                If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "1分割胚") Then
                    v1 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "1分割胚")
                End If
                If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "2分割胚") Then
                    v2 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "2分割胚")
                End If
                valueWithCorrection = v1 + v2 / 2
                valueRaw = v1 + v2
            Else
                Dim key As String: key = yearItem & "_" & clinicCode & "_" & method
                If yearClinicSumDict.Exists(key) Then
                    valueRaw = yearClinicSumDict(key)
                    valueWithCorrection = IIf(applyCorrection = True, valueRaw / 2, valueRaw)
                End If
            End If
            
            Dim outKey As String: outKey = yearItem & "_" & Format(clinicItem, "00") & "_" & method

' 出力時に分岐
If method <> "1想定外STAGE" And method <> "2想定外STAGE" And method <> "混在：1想定外 + 他" Then

            ' 出力（補正あり（件数）：上段、補正なし（卵数）：下段）
'            wsSummary.Cells(rowBase, colStart + offset).value = valueWithCorrection
'            wsSummary.Cells(rowBase + 1, colStart + offset).value = valueRaw
            
             ' グローバル変数に格納
             hCG_globalET_Count_Denominator(outKey) = valueWithCorrection
'             hCG_globalEgg_Count_Denominator(outKey) = valueRaw
             
            End If

            ' === 総合値（補正あり）の加算 ===
totalWithCorrection = totalWithCorrection + valueWithCorrection

' === 総合値（補正なし）の加算 ===
totalNoCorrection = totalNoCorrection + valueRaw

        Next method

        ' 総合値（0列目）
'        wsSummary.Cells(rowBase, colStart).value = totalWithCorrection
'        wsSummary.Cells(rowBase + 1, colStart).value = totalNoCorrection
        
        ' グローバル変数に格納
        outKey = yearItem & "_" & Format(clinicItem, "00") & "_All"
             hCG_globalET_Count_Denominator(outKey) = totalWithCorrection
'             hCG_globalEgg_Count_Denominator(outKey) = totalNoCorrection

         ' --- 想定外系合計の出力 ---
        Dim unexpected1 As Double, unexpected2 As Double, mixed As Double
        unexpected1 = 0: unexpected2 = 0: mixed = 0

        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "1想定外STAGE") Then
            unexpected1 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "1想定外STAGE")
        End If
        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "2想定外STAGE") Then
            unexpected2 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "2想定外STAGE")
        End If
        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "混在：1想定外 + 他") Then
            mixed = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "混在：1想定外 + 他")
        End If

        Dim valueWithCorrectionU As Double, valueRawU As Double
        valueWithCorrectionU = unexpected1 + unexpected2 / 2 + mixed / 2
        valueRawU = unexpected1 + unexpected2 + mixed

        ' 分割胚(列番号8)の2列隣 = offset 10
'        wsSummary.Cells(rowBase, colStart + 10).value = valueWithCorrectionU
'        wsSummary.Cells(rowBase + 1, colStart + 10).value = valueRawU
        
         ' グローバル変数に格納
        outKey = yearItem & "_" & Format(clinicItem, "00") & "_unexpected"
        hCG_globalET_Count_Denominator(outKey) = valueWithCorrectionU

        clinicIndex = clinicIndex + 1
    Next clinicItem
Next yearIndex


'' === 全期間 × ET方法ごとの合計値を記録・出力 ===

Dim totalRaw As Object: Set totalRaw = CreateObject("Scripting.Dictionary")
Dim totalCorrected As Object: Set totalCorrected = CreateObject("Scripting.Dictionary")

' 出力対象（E列?）→ 見せたい分類のみ
Dim outputMethods As Variant
outputMethods = Array("1BT", "2BT", "2StepET", "分割胚")

'' 全体集計対象（D列：総合に含める分類すべて）
'Dim allMethods As Variant
'allMethods = Array("1BT", "2BT", "2StepET", "1分割胚", "2分割胚", "1想定外STAGE", "2想定外STAGE", "混在：1想定外 + 他")

' 2で割る分類
Dim correctHalfList As Variant
correctHalfList = Array("2BT", "2StepET", "2分割胚", "2想定外STAGE", "混在：1想定外 + 他")

Dim raw As Double, corrected As Double

' === 件数集計（全分類） ===
For Each method In methodList
    raw = 0
    For Each k In ET_Count.keys
        If InStr(k, method) > 0 Then raw = raw + ET_Count(k)
    Next k
    totalRaw(method) = raw
    If Not IsError(Application.Match(method, correctHalfList, 0)) Then
        totalCorrected(method) = raw / 2
    Else
        totalCorrected(method) = raw
    End If
Next method

' === 総合（補正あり／なし） ===
Dim sumRaw As Double: sumRaw = 0
Dim sumCorrected As Double: sumCorrected = 0
For Each method In methodList
    sumRaw = sumRaw + totalRaw(method)
    sumCorrected = sumCorrected + totalCorrected(method)
Next method

' === 出力処理 ===
Dim ws As Worksheet: Set ws = wsSummary
Dim baseRow As Long: baseRow = 7
 baseCol = 4  ' D列

' 総合値をD列へ出力
'ws.Cells(baseRow, baseCol).value = sumCorrected
'ws.Cells(baseRow + 1, baseCol).value = sumRaw

        ' グローバル変数に格納
        outKey = "AllClinic" & "_Allmethod"
        hCG_globalET_Count_Denominator(outKey) = sumCorrected
'        hCG_globalEgg_Count_Denominator(outKey) = sumRaw


' 出力対象のみを右に並べて出力（E列-）
For i = 0 To UBound(outputMethods)
    method = outputMethods(i)
    If method = "分割胚" Then
'        ws.Cells(baseRow, baseCol + 1 + i).value = totalCorrected("1分割胚") + totalCorrected("2分割胚")
'        ws.Cells(baseRow + 1, baseCol + 1 + i).value = totalRaw("1分割胚") + totalRaw("2分割胚")
        
         ' グローバル変数に格納
        outKey = "AllClinic" & "_" & method
        hCG_globalET_Count_Denominator(outKey) = totalCorrected("1分割胚") + totalCorrected("2分割胚")
'        hCG_globalEgg_Count_Denominator(outKey) = totalRaw("1分割胚") + totalRaw("2分割胚")
        
    Else
'        ws.Cells(baseRow, baseCol + 1 + i).value = totalCorrected(method)
'        ws.Cells(baseRow + 1, baseCol + 1 + i).value = totalRaw(method)
        
        ' グローバル変数に格納
        outKey = "AllClinic" & "_" & method
        hCG_globalET_Count_Denominator(outKey) = totalCorrected(method)
'        hCG_globalEgg_Count_Denominator(outKey) = totalRaw(method)

    End If
Next i

' === 想定外合算の出力 ===
unexpected1 = 0: unexpected2 = 0: mixed = 0

If totalRaw.Exists("1想定外STAGE") Then unexpected1 = totalRaw("1想定外STAGE")
If totalRaw.Exists("2想定外STAGE") Then unexpected2 = totalRaw("2想定外STAGE")
If totalRaw.Exists("混在：1想定外 + 他") Then mixed = totalRaw("混在：1想定外 + 他")

valueWithCorrectionU = 0
valueRawU = 0

valueWithCorrectionU = unexpected1 + unexpected2 / 2 + mixed / 2
valueRawU = unexpected1 + unexpected2 + mixed

'' 分割胚（=baseCol + 6）の2列右 → baseCol + 8
'ws.Cells(baseRow, baseCol + 10).value = valueWithCorrectionU
'ws.Cells(baseRow + 1, baseCol + 10).value = valueRawU

        ' グローバル変数に格納
        outKey = "AllClinic" & "_" & "unexpected"
        hCG_globalET_Count_Denominator(outKey) = valueWithCorrectionU

'' === 各年度 × ET方法ごとの合計値を記録 ===

 baseRow = 16
 baseCol = 4

For i = 0 To UBound(yearArray)
    year = yearArray(i)

    Dim countDict As Object: Set countDict = CreateObject("Scripting.Dictionary")
    Dim eggDict As Object: Set eggDict = CreateObject("Scripting.Dictionary")
    Dim ET_Eggs As Object: Set ET_Eggs = CreateObject("Scripting.Dictionary")
    Dim keys: keys = Array("All", "1BT", "2BT", "2StepET", "Cleavage")
    For Each k In keys: countDict(k) = 0: eggDict(k) = 0: Next

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 2 And parts(2) = year Then
            For Each m In methodList
                If InStr(k, m) > 0 Then
                    Dim cnt As Double: cnt = ET_Count(k)
                    Dim egg As Double: egg = cnt
                    Dim half As Boolean: half = Not IsError(Application.Match(m, correctHalfList, 0))

                    ' All
                    countDict("All") = countDict("All") + IIf(half, cnt / 2, cnt)
                    eggDict("All") = eggDict("All") + egg

                    ' 個別
                    If m = "1BT" Then countDict("1BT") = countDict("1BT") + cnt: eggDict("1BT") = eggDict("1BT") + egg
                    If m = "2BT" Then countDict("2BT") = countDict("2BT") + cnt / 2: eggDict("2BT") = eggDict("2BT") + egg
                    If m = "2StepET" Then countDict("2StepET") = countDict("2StepET") + cnt / 2: eggDict("2StepET") = eggDict("2StepET") + egg
                    If m = "1分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt: eggDict("Cleavage") = eggDict("Cleavage") + egg
                    If m = "2分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt / 2: eggDict("Cleavage") = eggDict("Cleavage") + egg
                End If
            Next
        End If
    Next

    ' 出力（9行ごと）
 r = baseRow + i * 9
    For j = 0 To 4
'        ws.Cells(r, baseCol + j).value = countDict(keys(j))
'        ws.Cells(r + 1, baseCol + j).value = eggDict(keys(j))
        
        ' グローバル変数に格納
        outKey = year & "_" & "AllClinic" & keys(j)
        hCG_globalET_Count_Denominator(outKey) = countDict(keys(j))
'        hCG_globalEgg_Count_Denominator(outKey) = eggDict(keys(j))

    Next j
    
        ' === 想定外3分類の合算出力 ===
    unexp1 = 0
    unexp2 = 0
    mixed = 0

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 2 Then
           method = parts(1)
            Dim ym As String: ym = parts(2)
            If Left(ym, 4) = year Then
                Select Case method
                    Case "1想定外STAGE": unexp1 = unexp1 + ET_Count(k)
                    Case "2想定外STAGE": unexp2 = unexp2 + ET_Count(k)
                    Case "混在：1想定外 + 他": mixed = mixed + ET_Count(k)
                End Select
            End If
        End If
    Next

    totalC = unexp1 + unexp2 / 2 + mixed / 2
    totalR = unexp1 + unexp2 + mixed

'    ws.Cells(r, baseCol + 10).value = totalC
'    ws.Cells(r + 1, baseCol + 10).value = totalR
    
         ' グローバル変数に格納
        outKey = year & "_" & "AllClinic" & "_unexp"
        hCG_globalET_Count_Denominator(outKey) = totalC
    
Next i

'全期間×各院

Dim lastYear As String
lastYear = yearArray(UBound(yearArray)) - 1  ' 前年度

Dim cIdx As Variant
 baseRow = 7   ' 件数：L7（行7）
 baseCol = 12  ' 列L（12）
 
c = 0

For Each cIdx In clinicList.keys
    clinic = cIdx

     Set countDict = CreateObject("Scripting.Dictionary")
    Set eggDict = CreateObject("Scripting.Dictionary")
    Dim etType As Variant
    For Each etType In keys: countDict(etType) = 0: eggDict(etType) = 0: Next

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 3 Then
            year = parts(2)
            If parts(0) = clinic Then
                For Each m In methodList
                    If InStr(k, m) > 0 Then
                        cnt = ET_Count(k)
                        egg = cnt  ' 卵数は補正なし
                         half = Not IsError(Application.Match(m, correctHalfList, 0))

                        ' All
                        countDict("All") = countDict("All") + IIf(half, cnt / 2, cnt)
                        eggDict("All") = eggDict("All") + egg

                        ' 個別
                        If m = "1BT" Then countDict("1BT") = countDict("1BT") + cnt: eggDict("1BT") = eggDict("1BT") + egg
                        If m = "2BT" Then countDict("2BT") = countDict("2BT") + cnt / 2: eggDict("2BT") = eggDict("2BT") + egg
                        If m = "2StepET" Then countDict("2StepET") = countDict("2StepET") + cnt / 2: eggDict("2StepET") = eggDict("2StepET") + egg
                        If m = "1分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt: eggDict("Cleavage") = eggDict("Cleavage") + egg
                        If m = "2分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt / 2: eggDict("Cleavage") = eggDict("Cleavage") + egg
                    End If
                Next
            End If
        End If
    Next

    ' 出力（8列おきに右へ）
    Dim colOffset As Long: colOffset = baseCol + c * 8
    For j = 0 To 4
'        ws.Cells(baseRow, colOffset + j).value = countDict(keys(j))      ' 件数
'        ws.Cells(baseRow + 1, colOffset + j).value = eggDict(keys(j))    ' 卵数（1行下）
        
        ' グローバル変数に格納
        outKey = Format(clinic, "00") & "_" & keys(j)
        hCG_globalET_Count_Denominator(outKey) = countDict(keys(j))
'        hCG_globalEgg_Count_Denominator(outKey) = eggDict(keys(j))
        
    Next j
    
    
   ' === 想定外3分類の合算（クリニック単位・全期間） ===
    unexp1 = 0
    unexp2 = 0
    mixed = 0

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 2 Then
            Dim cl As String: cl = parts(0)
            method = parts(1)

            If cl = clinic Then
                Select Case method
                    Case "1想定外STAGE": unexp1 = unexp1 + ET_Count(k)
                    Case "2想定外STAGE": unexp2 = unexp2 + ET_Count(k)
                    Case "混在：1想定外 + 他": mixed = mixed + ET_Count(k)
                End Select
            End If
        End If
    Next

    totalC = unexp1 + unexp2 / 2 + mixed / 2
    totalR = unexp1 + unexp2 + mixed
    
    ' グローバル変数に格納
    outKey = Format(clinic, "00") & "_" & "unexp"
    hCG_globalET_Count_Denominator(outKey) = totalC
    
     c = c + 1
     
Next cIdx

End Sub

Sub ET05_GS_Counts_Denominator()

    Dim wsPivot As Worksheet
    Dim wsSummary As Worksheet
    Dim pt As pivotTable
    Dim lastCol As Long, lastRow As Long
    Dim methodRow As Long, clinicRow As Long
    Dim yearCol As Long
    Dim totalRow As Long
    Dim colLabel1 As String, colLabel2 As String
    Dim prevLabel1 As String
    Dim value As Variant
    Dim c As Long, r As Long
    Dim totalSum As Double
    Dim currentRowOffset As Long
    Dim yearmonth As Variant, year As Variant, month As Variant
    Dim cell As Range
    Dim methodName As Variant
    Dim baseCol As Long, baseMethodCol As Long
    Dim currentYear As Variant
    Dim yearList As Collection
    Dim yearArray() As Variant
    Dim i As Long, j As Long, tmp As Variant
    Dim yearExists As Boolean
    Dim hospitalMap As Object
    Dim sortedHospitals As Variant
    Dim hospitalName As Variant
    Dim clinicID As String
    Dim hospitalIndex As Long
       
       
    Set GS_globalEgg_Count_Denominator = CreateObject("Scripting.Dictionary")
       

    ' ピボットシートと出力先シートの設定
    Set wsPivot = ThisWorkbook.Sheets("S10_母数_GS")
    Set wsSummary = ThisWorkbook.Sheets("移植サマリー")
    Set pt = wsPivot.PivotTables("P10_母数_GS")

    ' ピボットの行・列情報を取得
    yearCol = pt.TableRange2.Column

    ETmethodRow = pt.RowRange.row - 1
    clinicRow = pt.RowRange.row
    rowYear = pt.RowRange.row + 1
    Dim dataStartRow As Long: dataStartRow = rowYear ' データ本体の開始行

    lastCol = pt.TableRange2.Columns.count + pt.TableRange2.Column - 1
    lastRow = pt.TableRange2.Rows.count + pt.TableRange2.row - 1
    totalRow = lastRow
    
    ' 年度リストを作成
    yearArray = GetSortedYearsFromPivot()

    ' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
    Dim yearDict As Object
    Set yearDict = CreateObject("Scripting.Dictionary")

    For i = UBound(yearArray) To LBound(yearArray) Step -1
        If Not yearDict.Exists(yearArray(i)) Then
            yearDict.Add yearArray(i), True
        End If
    Next i


'    ' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
'Dim yearDict As Object
'Set yearDict = CreateObject("Scripting.Dictionary")
'
'' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
'On Error Resume Next
'For Each cell In wsPivot.Range(wsPivot.Cells(rowYear, yearCol), wsPivot.Cells(totalRow - 1, yearCol))
'    If cell.IndentLevel = 0 And IsNumeric(cell.value) Then
'        If Not yearDict.Exists(cell.value) Then
'            yearDict.Add cell.value, 1 ' 値をキーとして、値は任意（ここでは 1）
'        End If
'    End If
'Next cell
'On Error GoTo 0
'
'' 年度リストが空なら終了
'If yearDict.Count = 0 Then Exit Sub
'
'' Dictionary のキーを配列に変換して昇順にソート
'yearArray = yearDict.keys
'
'' ソート（昇順）
'Call QuickSort(yearArray, LBound(yearArray), UBound(yearArray))

'' ソート後の年を使用する場合
'For i = LBound(yearArray) To UBound(yearArray)
'    Debug.Print yearArray(i) ' 年度を表示
'Next i

    ' 院マップと識別番号でソートされた院名リストを取得
    Set hospitalMap = GetHospitalMap()
    sortedHospitals = SortKeysByValue(hospitalMap)

    ' データ列の開始列
    Dim firstDataCol As Long: firstDataCol = pt.TableRange2.Column
    
        ' データ集計
     ' 集計用ディクショナリ
    Dim ET_Count As Object
    Set ET_Count = CreateObject("Scripting.Dictionary")
    
    For r = dataStartRow To lastRow - 1 ' 最終行（総計）は除外
        yearmonth = wsPivot.Cells(r, firstDataCol).value
        If IsNumeric(yearmonth) Then
            year = yearmonth
        Else
            month = yearmonth
            yearMonthKey = year & "_" & month

            For c = firstDataCol To lastCol - 1 ' 最終列（総計）は除外
                If wsPivot.Cells(ETmethodRow, c).value <> "" Then prevMethod = Trim(wsPivot.Cells(ETmethodRow, c).value)
                method = prevMethod

                If wsPivot.Cells(clinicRow, c).value <> "" Then prevClinic = Trim(wsPivot.Cells(clinicRow, c).value)
                clinic = prevClinic

                value = wsPivot.Cells(r, c).value

                If method <> "" And clinic <> "" And IsNumeric(value) Then
                    Dim uniqueKey As String
                    
                    uniqueKey = Format(clinic, "00") & "_" & method & "_" & yearMonthKey

                    If Not ET_Count.Exists(uniqueKey) Then
                        ET_Count.Add uniqueKey, value
                    Else
                        ET_Count(uniqueKey) = ET_Count(uniqueKey) + value
                    End If
                End If
            Next c
        End If
    Next r


    ' === 院識別番号一覧をET_Count から自動抽出 ===
    Dim clinicList As Object
    Set clinicList = CreateObject("Scripting.Dictionary")
    
For i = LBound(sortedHospitals) To UBound(sortedHospitals)
    Dim code As String
    code = Format(i + 1, "00")  ' "01", "02", ...
    
    If Not clinicList.Exists(code) Then
        clinicList.Add code, True
    End If
Next i


' === 各年度 × 院別 × 移植方法の合算値を出力（補正あり＆なし）===
Dim yearClinicSumDict As Object
Set yearClinicSumDict = CreateObject("Scripting.Dictionary")

Dim methodList As Variant
methodList = Array("1BT", "2BT", "2StepET", "1分割胚", "2分割胚", "1想定外STAGE", "2想定外STAGE", "混在：1想定外 + 他")

' 集計：分類ごとに件数を格納
For Each method In methodList
    For Each k In ET_Count.keys
'        If InStr(k, method) > 0 Then
            parts = Split(k, "_")
            If UBound(parts) >= 3 Then
             If parts(1) = method Then
                gClinic = parts(0)
                localYear = parts(2)
                
                If yearDict.Exists(localYear) And clinicList.Exists(gClinic) Then
                    yckey = localYear & "_" & Format(gClinic, "00") & "_" & method
                    If yearClinicSumDict.Exists(yckey) Then
                        yearClinicSumDict(yckey) = yearClinicSumDict(yckey) + ET_Count(k)
                    Else
                        yearClinicSumDict.Add yckey, ET_Count(k)
                    End If
                End If
            End If
        End If
    Next k
Next method


' === 出力設定 ===
Dim methodMap As Object
Set methodMap = CreateObject("Scripting.Dictionary")
methodMap.Add "1BT", Array(1, False)
methodMap.Add "2BT", Array(2, True)
methodMap.Add "2StepET", Array(3, True)
methodMap.Add "1+2分割胚", Array(4, "mixed")
methodMap.Add "1想定外STAGE", Array(5, False)
methodMap.Add "2想定外STAGE", Array(6, True)
methodMap.Add "混在：1想定外 + 他", Array(7, True)

' 年度を新しい順に並び替え
' 年度を昇順にソート
Call QuickSort(yearArray, LBound(yearArray), UBound(yearArray))

' ソート後、逆順に入れ替え（新しい年度順）
Dim sortedYears() As Variant
Dim n As Long

n = UBound(yearArray) - LBound(yearArray) + 1
ReDim sortedYears(0 To n - 1)

For i = 0 To n - 1
    sortedYears(i) = yearArray(UBound(yearArray) - i)
Next i

' === 出力処理 ===
Dim yearIndex As Long, clinicIndex As Long
For yearIndex = LBound(sortedYears) To UBound(sortedYears)
    Dim yearItem As Variant: yearItem = sortedYears(yearIndex)
    Dim rowBase As Long: rowBase = 16 + yearIndex * 9

    clinicIndex = 0
    For Each clinicItem In clinicList.keys
        Dim clinicCode As String: clinicCode = Format(clinicItem, "00")
        Dim colStart As Long: colStart = 12 + clinicIndex * 8 ' M列スタート

        Dim totalWithCorrection As Double: totalWithCorrection = 0
        Dim totalNoCorrection As Double: totalNoCorrection = 0

        ' 分類ごとに出力
        For Each method In methodMap.keys
            Dim offset As Long: offset = methodMap(method)(0)
            Dim applyCorrection As Variant: applyCorrection = methodMap(method)(1)

            Dim valueWithCorrection As Double: valueWithCorrection = 0
            Dim valueRaw As Double: valueRaw = 0

            If method = "1+2分割胚" Then
                Dim v1 As Double: v1 = 0
                Dim v2 As Double: v2 = 0
                If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "1分割胚") Then
                    v1 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "1分割胚")
                End If
                If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "2分割胚") Then
                    v2 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "2分割胚")
                End If
                valueWithCorrection = v1 + v2 / 2
                valueRaw = v1 + v2
            Else
                Dim key As String: key = yearItem & "_" & clinicCode & "_" & method
                If yearClinicSumDict.Exists(key) Then
                    valueRaw = yearClinicSumDict(key)
                    valueWithCorrection = IIf(applyCorrection = True, valueRaw / 2, valueRaw)
                End If
            End If
            
            Dim outKey As String: outKey = yearItem & "_" & Format(clinicItem, "00") & "_" & method

' 出力時に分岐
If method <> "1想定外STAGE" And method <> "2想定外STAGE" And method <> "混在：1想定外 + 他" Then

            ' 出力（補正あり（件数）：上段、補正なし（卵数）：下段）
'            wsSummary.Cells(rowBase, colStart + offset).value = valueWithCorrection
'            wsSummary.Cells(rowBase + 1, colStart + offset).value = valueRaw
            
             ' グローバル変数に格納
'             hCG_globalET_Count_Denominator(outKey) = valueWithCorrection
             GS_globalEgg_Count_Denominator(outKey) = valueRaw
             
            End If

            ' === 総合値（補正あり）の加算 ===
totalWithCorrection = totalWithCorrection + valueWithCorrection

' === 総合値（補正なし）の加算 ===
totalNoCorrection = totalNoCorrection + valueRaw

        Next method

        ' 総合値（0列目）
'        wsSummary.Cells(rowBase, colStart).value = totalWithCorrection
'        wsSummary.Cells(rowBase + 1, colStart).value = totalNoCorrection
        
        ' グローバル変数に格納
        outKey = yearItem & "_" & Format(clinicItem, "00") & "_All"
'             hCG_globalET_Count_Denominator(outKey) = totalWithCorrection
             GS_globalEgg_Count_Denominator(outKey) = totalNoCorrection
             
        ' --- 想定外系合計の出力 ---
        Dim unexpected1 As Double, unexpected2 As Double, mixed As Double
        unexpected1 = 0: unexpected2 = 0: mixed = 0

        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "1想定外STAGE") Then
            unexpected1 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "1想定外STAGE")
        End If
        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "2想定外STAGE") Then
            unexpected2 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "2想定外STAGE")
        End If
        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "混在：1想定外 + 他") Then
            mixed = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "混在：1想定外 + 他")
        End If

        Dim valueWithCorrectionU As Double, valueRawU As Double
        valueWithCorrectionU = unexpected1 + unexpected2 / 2 + mixed / 2
        valueRawU = unexpected1 + unexpected2 + mixed

        ' 分割胚(列番号8)の2列隣 = offset 10
'        wsSummary.Cells(rowBase, colStart + 10).value = valueWithCorrectionU
'        wsSummary.Cells(rowBase + 1, colStart + 10).value = valueRawU
        
         ' グローバル変数に格納
        outKey = yearItem & "_" & Format(clinicItem, "00") & "_unexpected"
        GS_globalEgg_Count_Denominator(outKey) = valueRawU

        clinicIndex = clinicIndex + 1
    Next clinicItem
Next yearIndex


'' === 全期間 × ET方法ごとの合計値を記録・出力 ===

Dim totalRaw As Object: Set totalRaw = CreateObject("Scripting.Dictionary")
Dim totalCorrected As Object: Set totalCorrected = CreateObject("Scripting.Dictionary")

' 出力対象（E列?）→ 見せたい分類のみ
Dim outputMethods As Variant
outputMethods = Array("1BT", "2BT", "2StepET", "分割胚")

'' 全体集計対象（D列：総合に含める分類すべて）
'Dim allMethods As Variant
'allMethods = Array("1BT", "2BT", "2StepET", "1分割胚", "2分割胚", "1想定外STAGE", "2想定外STAGE", "混在：1想定外 + 他")

' 2で割る分類
Dim correctHalfList As Variant
correctHalfList = Array("2BT", "2StepET", "2分割胚", "2想定外STAGE", "混在：1想定外 + 他")

Dim raw As Double, corrected As Double

' === 件数集計（全分類） ===
For Each method In methodList
    raw = 0
    For Each k In ET_Count.keys
        If InStr(k, method) > 0 Then raw = raw + ET_Count(k)
    Next k
    totalRaw(method) = raw
    If Not IsError(Application.Match(method, correctHalfList, 0)) Then
        totalCorrected(method) = raw / 2
    Else
        totalCorrected(method) = raw
    End If
Next method

' === 総合（補正あり／なし） ===
Dim sumRaw As Double: sumRaw = 0
Dim sumCorrected As Double: sumCorrected = 0
For Each method In methodList
    sumRaw = sumRaw + totalRaw(method)
    sumCorrected = sumCorrected + totalCorrected(method)
Next method

' === 出力処理 ===
Dim ws As Worksheet: Set ws = wsSummary
Dim baseRow As Long: baseRow = 7
 baseCol = 4  ' D列

' 総合値をD列へ出力
'ws.Cells(baseRow, baseCol).value = sumCorrected
'ws.Cells(baseRow + 1, baseCol).value = sumRaw

        ' グローバル変数に格納
        outKey = "AllClinic" & "_Allmethod"
'        hCG_globalET_Count_Denominator(outKey) = sumCorrected
        GS_globalEgg_Count_Denominator(outKey) = sumRaw


' 出力対象のみを右に並べて出力（E列-）
For i = 0 To UBound(outputMethods)
    method = outputMethods(i)
    If method = "分割胚" Then
'        ws.Cells(baseRow, baseCol + 1 + i).value = totalCorrected("1分割胚") + totalCorrected("2分割胚")
'        ws.Cells(baseRow + 1, baseCol + 1 + i).value = totalRaw("1分割胚") + totalRaw("2分割胚")
        
         ' グローバル変数に格納
        outKey = "AllClinic" & "_" & method
'        hCG_globalET_Count_Denominator(outKey) = totalCorrected("1分割胚") + totalCorrected("2分割胚")
        GS_globalEgg_Count_Denominator(outKey) = totalRaw("1分割胚") + totalRaw("2分割胚")
        
    Else
'        ws.Cells(baseRow, baseCol + 1 + i).value = totalCorrected(method)
'        ws.Cells(baseRow + 1, baseCol + 1 + i).value = totalRaw(method)
        
        ' グローバル変数に格納
        outKey = "AllClinic" & "_" & method
'        hCG_globalET_Count_Denominator(outKey) = totalCorrected(method)
        GS_globalEgg_Count_Denominator(outKey) = totalRaw(method)

    
    End If
Next i

' === 想定外合算の出力 ===
unexpected1 = 0: unexpected2 = 0: mixed = 0

If totalRaw.Exists("1想定外STAGE") Then unexpected1 = totalRaw("1想定外STAGE")
If totalRaw.Exists("2想定外STAGE") Then unexpected2 = totalRaw("2想定外STAGE")
If totalRaw.Exists("混在：1想定外 + 他") Then mixed = totalRaw("混在：1想定外 + 他")

valueWithCorrectionU = 0
valueRawU = 0

valueWithCorrectionU = unexpected1 + unexpected2 / 2 + mixed / 2
valueRawU = unexpected1 + unexpected2 + mixed

'' 分割胚（=baseCol + 6）の2列右 → baseCol + 8
'ws.Cells(baseRow, baseCol + 10).value = valueWithCorrectionU
'ws.Cells(baseRow + 1, baseCol + 10).value = valueRawU

        ' グローバル変数に格納
        outKey = "AllClinic" & "_" & "unexpected"
        GS_globalEgg_Count_Denominator(outKey) = valueRawU


'' === 各年度 × ET方法ごとの合計値を記録 ===

 baseRow = 16
 baseCol = 4

For i = 0 To UBound(yearArray)
    year = yearArray(i)

    Dim countDict As Object: Set countDict = CreateObject("Scripting.Dictionary")
    Dim eggDict As Object: Set eggDict = CreateObject("Scripting.Dictionary")
    Dim ET_Eggs As Object: Set ET_Eggs = CreateObject("Scripting.Dictionary")
    Dim keys: keys = Array("All", "1BT", "2BT", "2StepET", "Cleavage")
    For Each k In keys: countDict(k) = 0: eggDict(k) = 0: Next

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 3 And parts(2) = year Then
            For Each m In methodList
                If InStr(k, m) > 0 Then
                    Dim cnt As Double: cnt = ET_Count(k)
                    Dim egg As Double: egg = cnt
                    Dim half As Boolean: half = Not IsError(Application.Match(m, correctHalfList, 0))

                    ' All
                    countDict("All") = countDict("All") + IIf(half, cnt / 2, cnt)
                    eggDict("All") = eggDict("All") + egg

                    ' 個別
                    If m = "1BT" Then countDict("1BT") = countDict("1BT") + cnt: eggDict("1BT") = eggDict("1BT") + egg
                    If m = "2BT" Then countDict("2BT") = countDict("2BT") + cnt / 2: eggDict("2BT") = eggDict("2BT") + egg
                    If m = "2StepET" Then countDict("2StepET") = countDict("2StepET") + cnt / 2: eggDict("2StepET") = eggDict("2StepET") + egg
                    If m = "1分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt: eggDict("Cleavage") = eggDict("Cleavage") + egg
                    If m = "2分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt / 2: eggDict("Cleavage") = eggDict("Cleavage") + egg
                End If
            Next
        End If
    Next

    ' 出力（9行ごと）
 r = baseRow + i * 9
    For j = 0 To 4
'        ws.Cells(r, baseCol + j).value = countDict(keys(j))
'        ws.Cells(r + 1, baseCol + j).value = eggDict(keys(j))
        
        ' グローバル変数に格納
        outKey = year & "_" & "AllClinic" & keys(j)
'        hCG_globalET_Count_Denominator(outKey) = countDict(keys(j))
        GS_globalEgg_Count_Denominator(outKey) = eggDict(keys(j))

    Next j
    
            ' === 想定外3分類の合算出力 ===
    unexp1 = 0
    unexp2 = 0
    mixed = 0

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 2 Then
           method = parts(1)
            Dim ym As String: ym = parts(2)
            If Left(ym, 4) = year Then
                Select Case method
                    Case "1想定外STAGE": unexp1 = unexp1 + ET_Count(k)
                    Case "2想定外STAGE": unexp2 = unexp2 + ET_Count(k)
                    Case "混在：1想定外 + 他": mixed = mixed + ET_Count(k)
                End Select
            End If
        End If
    Next

    totalC = unexp1 + unexp2 / 2 + mixed / 2
    totalR = unexp1 + unexp2 + mixed

'    ws.Cells(r, baseCol + 10).value = totalC
'    ws.Cells(r + 1, baseCol + 10).value = totalR
    
         ' グローバル変数に格納
        outKey = year & "_" & "AllClinic" & "_unexp"
        GS_globalEgg_Count_Denominator(outKey) = totalR
Next i

'全期間×各院

Dim lastYear As String
lastYear = yearArray(UBound(yearArray)) - 1  ' 前年度

Dim cIdx As Variant
 baseRow = 7   ' 件数：L7（行7）
 baseCol = 12  ' 列L（12）
 
c = 0

For Each cIdx In clinicList.keys
    clinic = cIdx

     Set countDict = CreateObject("Scripting.Dictionary")
    Set eggDict = CreateObject("Scripting.Dictionary")
    Dim etType As Variant
    For Each etType In keys: countDict(etType) = 0: eggDict(etType) = 0: Next

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 3 Then
            year = parts(2)
            If parts(0) = clinic Then
                For Each m In methodList
                    If InStr(k, m) > 0 Then
                        cnt = ET_Count(k)
                        egg = cnt  ' 卵数は補正なし
                         half = Not IsError(Application.Match(m, correctHalfList, 0))

                        ' All
                        countDict("All") = countDict("All") + IIf(half, cnt / 2, cnt)
                        eggDict("All") = eggDict("All") + egg

                        ' 個別
                        If m = "1BT" Then countDict("1BT") = countDict("1BT") + cnt: eggDict("1BT") = eggDict("1BT") + egg
                        If m = "2BT" Then countDict("2BT") = countDict("2BT") + cnt / 2: eggDict("2BT") = eggDict("2BT") + egg
                        If m = "2StepET" Then countDict("2StepET") = countDict("2StepET") + cnt / 2: eggDict("2StepET") = eggDict("2StepET") + egg
                        If m = "1分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt: eggDict("Cleavage") = eggDict("Cleavage") + egg
                        If m = "2分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt / 2: eggDict("Cleavage") = eggDict("Cleavage") + egg
                    End If
                Next
            End If
        End If
    Next

    ' 出力（8列おきに右へ）
    Dim colOffset As Long: colOffset = baseCol + c * 8
    For j = 0 To 4
'        ws.Cells(baseRow, colOffset + j).value = countDict(keys(j))      ' 件数
'        ws.Cells(baseRow + 1, colOffset + j).value = eggDict(keys(j))    ' 卵数（1行下）
        
        ' グローバル変数に格納
        outKey = Format(clinic, "00") & "_" & keys(j)
'        hCG_globalET_Count_Denominator(outKey) = countDict(keys(j))
        GS_globalEgg_Count_Denominator(outKey) = eggDict(keys(j))
        
    Next j
    
       ' === 想定外3分類の合算（クリニック単位・全期間） ===
    unexp1 = 0
    unexp2 = 0
    mixed = 0

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 2 Then
            Dim cl As String: cl = parts(0)
            method = parts(1)

            If cl = clinic Then
                Select Case method
                    Case "1想定外STAGE": unexp1 = unexp1 + ET_Count(k)
                    Case "2想定外STAGE": unexp2 = unexp2 + ET_Count(k)
                    Case "混在：1想定外 + 他": mixed = mixed + ET_Count(k)
                End Select
            End If
        End If
    Next

    totalC = unexp1 + unexp2 / 2 + mixed / 2
    totalR = unexp1 + unexp2 + mixed
    
    ' グローバル変数に格納
    outKey = Format(clinic, "00") & "_" & "unexp"
    GS_globalEgg_Count_Denominator(outKey) = totalR

     c = c + 1
Next cIdx

End Sub

Sub ET06_GS_Counts()

    Dim wsPivot As Worksheet
    Dim wsSummary As Worksheet
    Dim pt As pivotTable
    Dim lastCol As Long, lastRow As Long
    Dim methodRow As Long, clinicRow As Long
    Dim yearCol As Long
    Dim totalRow As Long
    Dim colLabel1 As String, colLabel2 As String
    Dim prevLabel1 As String
    Dim value As Variant
    Dim c As Long, r As Long
    Dim totalSum As Double
    Dim currentRowOffset As Long
    Dim yearmonth As Variant, year As Variant, month As Variant
    Dim cell As Range
    Dim methodName As Variant
    Dim baseCol As Long, baseMethodCol As Long
    Dim currentYear As Variant
    Dim yearList As Collection
    Dim yearArray() As Variant
    Dim i As Long, j As Long, tmp As Variant
    Dim yearExists As Boolean
    Dim hospitalMap As Object
    Dim sortedHospitals As Variant
    Dim hospitalName As Variant
    Dim clinicID As String
    Dim hospitalIndex As Long
       

    ' ピボットシートと出力先シートの設定
    Set wsPivot = ThisWorkbook.Sheets("S11_GS")
    Set wsSummary = ThisWorkbook.Sheets("移植サマリー")
    Set pt = wsPivot.PivotTables("P11_GS")

    ' ピボットの行・列情報を取得
    yearCol = pt.TableRange2.Column

    ETmethodRow = pt.RowRange.row - 1
    clinicRow = pt.RowRange.row
    rowYear = pt.RowRange.row + 1
    Dim dataStartRow As Long: dataStartRow = rowYear ' データ本体の開始行

    lastCol = pt.TableRange2.Columns.count + pt.TableRange2.Column - 1
    lastRow = pt.TableRange2.Rows.count + pt.TableRange2.row - 1
    totalRow = lastRow
    
        ' 年度リストを作成
    yearArray = GetSortedYearsFromPivot()

    ' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
    Dim yearDict As Object
    Set yearDict = CreateObject("Scripting.Dictionary")

    For i = UBound(yearArray) To LBound(yearArray) Step -1
        If Not yearDict.Exists(yearArray(i)) Then
            yearDict.Add yearArray(i), True
        End If
    Next i


'    ' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
'Dim yearDict As Object
'Set yearDict = CreateObject("Scripting.Dictionary")
'
'' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
'On Error Resume Next
'For Each cell In wsPivot.Range(wsPivot.Cells(rowYear, yearCol), wsPivot.Cells(totalRow - 1, yearCol))
'    If cell.IndentLevel = 0 And IsNumeric(cell.value) Then
'        If Not yearDict.Exists(cell.value) Then
'            yearDict.Add cell.value, 1 ' 値をキーとして、値は任意（ここでは 1）
'        End If
'    End If
'Next cell
'On Error GoTo 0
'
'' 年度リストが空なら終了
'If yearDict.Count = 0 Then Exit Sub
'
'' Dictionary のキーを配列に変換して昇順にソート
'yearArray = yearDict.keys
'
'' ソート（昇順）
'Call QuickSort(yearArray, LBound(yearArray), UBound(yearArray))

'' ソート後の年を使用する場合
'For i = LBound(yearArray) To UBound(yearArray)
'    Debug.Print yearArray(i) ' 年度を表示
'Next i

    ' 院マップと識別番号でソートされた院名リストを取得
    Set hospitalMap = GetHospitalMap()
    sortedHospitals = SortKeysByValue(hospitalMap)

    ' データ列の開始列
    Dim firstDataCol As Long: firstDataCol = pt.TableRange2.Column
    
        ' データ集計
     ' 集計用ディクショナリ
    Dim ET_Count As Object
    Set ET_Count = CreateObject("Scripting.Dictionary")
    
    For r = dataStartRow To lastRow - 1 ' 最終行（総計）は除外
        yearmonth = wsPivot.Cells(r, firstDataCol).value
        If IsNumeric(yearmonth) Then
            year = yearmonth
        Else
            month = yearmonth
            yearMonthKey = year & "_" & month

            For c = firstDataCol To lastCol - 1 ' 最終列（総計）は除外
                If wsPivot.Cells(ETmethodRow, c).value <> "" Then prevMethod = Trim(wsPivot.Cells(ETmethodRow, c).value)
                method = prevMethod

                If wsPivot.Cells(clinicRow, c).value <> "" Then prevClinic = Trim(wsPivot.Cells(clinicRow, c).value)
                clinic = prevClinic

                value = wsPivot.Cells(r, c).value

                If method <> "" And clinic <> "" And IsNumeric(value) Then
                    Dim uniqueKey As String
                    
                    uniqueKey = Format(clinic, "00") & "_" & method & "_" & yearMonthKey

                    If Not ET_Count.Exists(uniqueKey) Then
                        ET_Count.Add uniqueKey, value
                    Else
                        ET_Count(uniqueKey) = ET_Count(uniqueKey) + value
                    End If
                End If
            Next c
        End If
    Next r


    ' === 院識別番号一覧をET_Count から自動抽出 ===
    Dim clinicList As Object
    Set clinicList = CreateObject("Scripting.Dictionary")
    
For i = LBound(sortedHospitals) To UBound(sortedHospitals)
    Dim code As String
    code = Format(i + 1, "00")  ' "01", "02", ...
    
    If Not clinicList.Exists(code) Then
        clinicList.Add code, True
    End If
Next i


' === 各年度 × 院別 × 移植方法の合算値を出力（補正あり＆なし）===
Dim yearClinicSumDict As Object
Set yearClinicSumDict = CreateObject("Scripting.Dictionary")

Dim methodList As Variant
methodList = Array("1BT", "2BT", "2StepET", "1分割胚", "2分割胚", "1想定外STAGE", "2想定外STAGE", "混在：1想定外 + 他")

' 集計：分類ごとに件数を格納
For Each method In methodList
    For Each k In ET_Count.keys
'        If InStr(k, method) > 0 Then
            parts = Split(k, "_")
            If UBound(parts) >= 3 Then
             If parts(1) = method Then
                gClinic = parts(0)
                localYear = parts(2)
                
                If yearDict.Exists(localYear) And clinicList.Exists(gClinic) Then
                    yckey = localYear & "_" & Format(gClinic, "00") & "_" & method
                    If yearClinicSumDict.Exists(yckey) Then
                        yearClinicSumDict(yckey) = yearClinicSumDict(yckey) + ET_Count(k)
                    Else
                        yearClinicSumDict.Add yckey, ET_Count(k)
                    End If
                End If
            End If
        End If
    Next k
Next method


' === 出力設定 ===
Dim methodMap As Object
Set methodMap = CreateObject("Scripting.Dictionary")
methodMap.Add "1BT", Array(1, False)
methodMap.Add "2BT", Array(2, True)
methodMap.Add "2StepET", Array(3, True)
methodMap.Add "1+2分割胚", Array(4, "mixed")
methodMap.Add "1想定外STAGE", Array(5, False)
methodMap.Add "2想定外STAGE", Array(6, True)
methodMap.Add "混在：1想定外 + 他", Array(7, True)

' 年度を新しい順に並び替え
' 年度を昇順にソート
Call QuickSort(yearArray, LBound(yearArray), UBound(yearArray))

' ソート後、逆順に入れ替え（新しい年度順）
Dim sortedYears() As Variant
Dim n As Long

n = UBound(yearArray) - LBound(yearArray) + 1
ReDim sortedYears(0 To n - 1)

For i = 0 To n - 1
    sortedYears(i) = yearArray(UBound(yearArray) - i)
Next i

' === 出力処理 ===
Dim yearIndex As Long, clinicIndex As Long
For yearIndex = LBound(sortedYears) To UBound(sortedYears)
    Dim yearItem As Variant: yearItem = sortedYears(yearIndex)
    Dim rowBase As Long: rowBase = 19 + yearIndex * 9

    clinicIndex = 0
    For Each clinicItem In clinicList.keys
        Dim clinicCode As String: clinicCode = Format(clinicItem, "00")
        Dim colStart As Long: colStart = 19 + clinicIndex * 15 ' M列スタート

        Dim totalWithCorrection As Double: totalWithCorrection = 0
        Dim totalNoCorrection As Double: totalNoCorrection = 0

        ' 分類ごとに出力
        For Each method In methodMap.keys
            Dim offset As Long: offset = methodMap(method)(0)
            Dim applyCorrection As Variant: applyCorrection = methodMap(method)(1)

            Dim valueWithCorrection As Double: valueWithCorrection = 0
            Dim valueRaw As Double: valueRaw = 0

            If method = "1+2分割胚" Then
                Dim v1 As Double: v1 = 0
                Dim v2 As Double: v2 = 0
                If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "1分割胚") Then
                    v1 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "1分割胚")
                End If
                If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "2分割胚") Then
                    v2 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "2分割胚")
                End If
                valueWithCorrection = v1 + v2 / 2
                valueRaw = v1 + v2
            Else
                Dim key As String: key = yearItem & "_" & clinicCode & "_" & method
                If yearClinicSumDict.Exists(key) Then
                    valueRaw = yearClinicSumDict(key)
                    valueWithCorrection = IIf(applyCorrection = True, valueRaw / 2, valueRaw)
                End If
            End If
            
            Dim outKey As String: outKey = yearItem & "_" & Format(clinicItem, "00") & "_" & method

' 出力時に分岐
If method <> "1想定外STAGE" And method <> "2想定外STAGE" And method <> "混在：1想定外 + 他" Then
                
    If valueWithCorrection <> 0 And GS_globalEgg_Count_Denominator(outKey) <> 0 Then

            ' 出力（補正あり（件数）：上段、補正なし（卵数）：下段）
            wsSummary.Cells(rowBase, colStart + offset * 2).NumberFormat = "0.0"
            wsSummary.Cells(rowBase, colStart + offset * 2).value = Round(valueWithCorrection / GS_globalEgg_Count_Denominator(outKey) * 100, 1)
            wsSummary.Cells(rowBase, colStart + offset * 2 + 1).value = "'" & valueWithCorrection & "/" & GS_globalEgg_Count_Denominator(outKey)
'            wsSummary.Cells(rowBase + 1, colStart + offset).value = valueRaw

                    Else
                    wsSummary.Cells(rowBase, colStart + offset * 2).NumberFormat = "0.0"
                    wsSummary.Cells(rowBase, colStart + offset * 2).value = 0
                    wsSummary.Cells(rowBase, colStart + offset * 2 + 1).value = "'" & valueWithCorrection & "/" & GS_globalEgg_Count_Denominator(outKey)
                    
                End If
             
            End If

            ' === 総合値（補正あり）の加算 ===
totalWithCorrection = totalWithCorrection + valueWithCorrection

' === 総合値（補正なし）の加算 ===
totalNoCorrection = totalNoCorrection + valueRaw

        Next method
        
        outKey = yearItem & "_" & Format(clinicItem, "00") & "_All"
        
        If totalWithCorrection <> 0 And GS_globalEgg_Count_Denominator(outKey) <> 0 Then

        ' 総合値（0列目）
        wsSummary.Cells(rowBase, colStart).NumberFormat = "0.0"
        wsSummary.Cells(rowBase, colStart).value = Round(totalWithCorrection / GS_globalEgg_Count_Denominator(outKey) * 100, 1)
        wsSummary.Cells(rowBase, colStart + 1).value = "'" & totalWithCorrection & "/" & GS_globalEgg_Count_Denominator(outKey)

'        wsSummary.Cells(rowBase + 1, colStart).value = totalNoCorrection

        Else
          wsSummary.Cells(rowBase, colStart).NumberFormat = "0.0"
          wsSummary.Cells(rowBase, colStart).value = 0
          wsSummary.Cells(rowBase, colStart + 1).value = "'" & totalWithCorrection & "/" & GS_globalEgg_Count_Denominator(outKey)
        End If
        
                         ' --- 想定外系合計の出力 ---
        Dim unexpected1 As Double, unexpected2 As Double, mixed As Double
        unexpected1 = 0: unexpected2 = 0: mixed = 0

        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "1想定外STAGE") Then
            unexpected1 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "1想定外STAGE")
        End If
        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "2想定外STAGE") Then
            unexpected2 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "2想定外STAGE")
        End If
        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "混在：1想定外 + 他") Then
            mixed = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "混在：1想定外 + 他")
        End If

        Dim valueWithCorrectionU As Double, valueRawU As Double
        valueWithCorrectionU = unexpected1 + unexpected2 / 2 + mixed / 2
        valueRawU = unexpected1 + unexpected2 + mixed

        outKey = yearItem & "_" & Format(clinicItem, "00") & "_unexpected"
        
        If valueWithCorrectionU <> 0 And GS_globalEgg_Count_Denominator(outKey) <> 0 Then

'         分割胚(列番号8)の2列隣 = offset 10
        wsSummary.Cells(rowBase, colStart + 10).NumberFormat = "0.0"
        wsSummary.Cells(rowBase, colStart + 10).value = Round(valueWithCorrectionU / GS_globalEgg_Count_Denominator(outKey) * 100, 1)
        wsSummary.Cells(rowBase, colStart + 11).value = "'" & valueWithCorrectionU & "/" & GS_globalEgg_Count_Denominator(outKey)

        Else
          wsSummary.Cells(rowBase, colStart + 10).NumberFormat = "0.0"
          wsSummary.Cells(rowBase, colStart + 10).value = 0
          wsSummary.Cells(rowBase, colStart + 11).value = "'" & valueWithCorrectionU & "/" & GS_globalEgg_Count_Denominator(outKey)
        End If

        clinicIndex = clinicIndex + 1
    Next clinicItem
Next yearIndex


'' === 全期間 × ET方法ごとの合計値を記録・出力 ===

Dim totalRaw As Object: Set totalRaw = CreateObject("Scripting.Dictionary")
Dim totalCorrected As Object: Set totalCorrected = CreateObject("Scripting.Dictionary")

' 出力対象（E列?）→ 見せたい分類のみ
Dim outputMethods As Variant
outputMethods = Array("1BT", "2BT", "2StepET", "分割胚")

'' 全体集計対象（D列：総合に含める分類すべて）
'Dim allMethods As Variant
'allMethods = Array("1BT", "2BT", "2StepET", "1分割胚", "2分割胚", "1想定外STAGE", "2想定外STAGE", "混在：1想定外 + 他")

' 2で割る分類
Dim correctHalfList As Variant
correctHalfList = Array("2BT", "2StepET", "2分割胚", "2想定外STAGE", "混在：1想定外 + 他")

Dim raw As Double, corrected As Double

' === 件数集計（全分類） ===
For Each method In methodList
    raw = 0
    For Each k In ET_Count.keys
        If InStr(k, method) > 0 Then raw = raw + ET_Count(k)
    Next k
    totalRaw(method) = raw
    If Not IsError(Application.Match(method, correctHalfList, 0)) Then
        totalCorrected(method) = raw / 2
    Else
        totalCorrected(method) = raw
    End If
Next method

' === 総合（補正あり／なし） ===
Dim sumRaw As Double: sumRaw = 0
Dim sumCorrected As Double: sumCorrected = 0
For Each method In methodList
    sumRaw = sumRaw + totalRaw(method)
    sumCorrected = sumCorrected + totalCorrected(method)
Next method

' === 出力処理 ===
Dim ws As Worksheet: Set ws = wsSummary
Dim baseRow As Long: baseRow = 10
 baseCol = 4  ' D列

' 総合値をD列へ出力
outKey = "AllClinic" & "_Allmethod"

        If sumCorrected <> 0 And GS_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(baseRow, baseCol).NumberFormat = "0.0"
        ws.Cells(baseRow, baseCol).value = Round(sumCorrected / GS_globalEgg_Count_Denominator(outKey) * 100, 1)
        ws.Cells(baseRow, baseCol + 1).value = "'" & sumCorrected & "/" & GS_globalEgg_Count_Denominator(outKey)
        'ws.Cells(baseRow + 1, baseCol).value = sumRaw

        Else
          wsSummary.Cells(baseRow, baseCol).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, baseCol).value = 0
          ws.Cells(baseRow, baseCol + 1).value = "'" & sumCorrected & "/" & GS_globalEgg_Count_Denominator(outKey)

        End If

'        ' グローバル変数に格納
'        outKey = "AllClinic" & "_Allmethod"
'        globalET_Count(outKey) = sumCorrected
'        globalEgg_Count(outKey) = sumRaw


' 出力対象のみを右に並べて出力（E列-）
For i = 0 To UBound(outputMethods)
    method = outputMethods(i)
    If method = "分割胚" Then
    
    Dim CountValue As Variant
    Dim EggValue As Variant
    
    outKey = "AllClinic" & "_" & method
    
        CountValue = totalCorrected("1分割胚") + totalCorrected("2分割胚")
        EggValue = totalRaw("1分割胚") + totalRaw("2分割胚")
        
        If CountValue <> 0 And GS_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(baseRow, baseCol + 2 + i * 2).NumberFormat = "0.0"
        ws.Cells(baseRow, baseCol + 2 + i * 2).value = Round(CountValue / GS_globalEgg_Count_Denominator(outKey) * 100, 1)
        ws.Cells(baseRow, baseCol + 3 + i * 2).value = "'" & CountValue & "/" & GS_globalEgg_Count_Denominator(outKey)
                
        
         ' グローバル変数に格納
'        outKey = "AllClinic" & "_" & method
'        globalET_Count(outKey) = totalCorrected("1分割胚") + totalCorrected("2分割胚")
'        globalEgg_Count(outKey) = totalRaw("1分割胚") + totalRaw("2分割胚")
        
        Else
          wsSummary.Cells(baseRow, baseCol + 2 + i * 2).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, baseCol + 2 + i * 2).value = 0
          ws.Cells(baseRow, baseCol + 3 + i * 2).value = "'" & CountValue & "/" & GS_globalEgg_Count_Denominator(outKey)

        End If
        
    Else
        outKey = "AllClinic" & "_" & method
        
        If totalCorrected(method) <> 0 And GS_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(baseRow, baseCol + 2 + i * 2).NumberFormat = "0.0"
        ws.Cells(baseRow, baseCol + 2 + i * 2).value = Round(totalCorrected(method) / GS_globalEgg_Count_Denominator(outKey) * 100, 1)
        ws.Cells(baseRow, baseCol + 3 + i * 2).value = "'" & totalCorrected(method) & "/" & GS_globalEgg_Count_Denominator(outKey)
       
'        ws.Cells(baseRow + 1, baseCol + 1 + i).value = totalRaw(method)
        
        ' グローバル変数に格納
'        outKey = "AllClinic" & "_" & method
'        globalET_Count(outKey) = totalCorrected(method)
'        globalEgg_Count(outKey) = totalRaw(method)
        
        Else
          wsSummary.Cells(baseRow, baseCol + 2 + i * 2).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, baseCol + 2 + i * 2).value = 0
          ws.Cells(baseRow, baseCol + 3 + i * 2).value = "'" & totalCorrected(method) & "/" & GS_globalEgg_Count_Denominator(outKey)

        End If
    End If
Next i

' === 想定外合算の出力 ===
unexpected1 = 0: unexpected2 = 0: mixed = 0

If totalRaw.Exists("1想定外STAGE") Then unexpected1 = totalRaw("1想定外STAGE")
If totalRaw.Exists("2想定外STAGE") Then unexpected2 = totalRaw("2想定外STAGE")
If totalRaw.Exists("混在：1想定外 + 他") Then mixed = totalRaw("混在：1想定外 + 他")

valueWithCorrectionU = 0
valueRawU = 0

valueWithCorrectionU = unexpected1 + unexpected2 / 2 + mixed / 2
valueRawU = unexpected1 + unexpected2 + mixed

outKey = "AllClinic" & "_" & "unexpected"

If valueWithCorrectionU <> 0 And GS_globalEgg_Count_Denominator(outKey) <> 0 Then

'' 分割胚（=baseCol + 6）の2列右 → baseCol + 8
wsSummary.Cells(baseRow, baseCol + 10).NumberFormat = "0.0"
ws.Cells(baseRow, baseCol + 10).value = Round(valueWithCorrectionU / GS_globalEgg_Count_Denominator(outKey) * 100, 1)
wsSummary.Cells(baseRow, baseCol + 11).value = "'" & valueWithCorrectionU & "/" & GS_globalEgg_Count_Denominator(outKey)
        
        Else
          wsSummary.Cells(baseRow, baseCol + 10).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, baseCol + 10).value = 0
          wsSummary.Cells(baseRow, baseCol + 11).value = "'" & valueWithCorrectionU & "/" & GS_globalEgg_Count_Denominator(outKey)
        End If


'' === 各年度 × ET方法ごとの合計値を記録 ===

 baseRow = 19
 baseCol = 4

For i = 0 To UBound(sortedYears)
    year = sortedYears(i)

    Dim countDict As Object: Set countDict = CreateObject("Scripting.Dictionary")
    Dim eggDict As Object: Set eggDict = CreateObject("Scripting.Dictionary")
    Dim ET_Eggs As Object: Set ET_Eggs = CreateObject("Scripting.Dictionary")
    Dim keys: keys = Array("All", "1BT", "2BT", "2StepET", "Cleavage")
    For Each k In keys: countDict(k) = 0: eggDict(k) = 0: Next

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 3 And parts(2) = year Then
            For Each m In methodList
                If InStr(k, m) > 0 Then
                    Dim cnt As Double: cnt = ET_Count(k)
                    Dim egg As Double: egg = cnt
                    Dim half As Boolean: half = Not IsError(Application.Match(m, correctHalfList, 0))

                    ' All
                    countDict("All") = countDict("All") + IIf(half, cnt / 2, cnt)
                    eggDict("All") = eggDict("All") + egg

                    ' 個別
                    If m = "1BT" Then countDict("1BT") = countDict("1BT") + cnt: eggDict("1BT") = eggDict("1BT") + egg
                    If m = "2BT" Then countDict("2BT") = countDict("2BT") + cnt / 2: eggDict("2BT") = eggDict("2BT") + egg
                    If m = "2StepET" Then countDict("2StepET") = countDict("2StepET") + cnt / 2: eggDict("2StepET") = eggDict("2StepET") + egg
                    If m = "1分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt: eggDict("Cleavage") = eggDict("Cleavage") + egg
                    If m = "2分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt / 2: eggDict("Cleavage") = eggDict("Cleavage") + egg
                End If
            Next
        End If
    Next

    ' 出力（9行ごと）
 r = baseRow + i * 9
    For j = 0 To 4
        outKey = year & "_" & "AllClinic" & keys(j)
        
        If countDict(keys(j)) <> 0 And GS_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(r, baseCol + j * 2).NumberFormat = "0.0"
        ws.Cells(r, baseCol + j * 2).value = Round(countDict(keys(j)) / GS_globalEgg_Count_Denominator(outKey) * 100, 1)
        ws.Cells(r, baseCol + j * 2 + 1).value = "'" & countDict(keys(j)) & "/" & GS_globalEgg_Count_Denominator(outKey)

'        ws.Cells(r + 1, baseCol + j).value = eggDict(keys(j))
        
        ' グローバル変数に格納
'        outKey = year & "_" & "AllClinic" & keys(j)
'        globalET_Count(outKey) = countDict(keys(j))
'        globalEgg_Count(outKey) = eggDict(keys(j))

        Else
          wsSummary.Cells(r, baseCol + j * 2).NumberFormat = "0.0"
          wsSummary.Cells(r, baseCol + j * 2).value = 0
          ws.Cells(r, baseCol + j * 2 + 1).value = "'" & countDict(keys(j)) & "/" & GS_globalEgg_Count_Denominator(outKey)
        End If
    Next j
    
                ' === 想定外3分類の合算出力 ===
    unexp1 = 0
    unexp2 = 0
    mixed = 0

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 2 Then
           method = parts(1)
            Dim ym As String: ym = parts(2)
            If Left(ym, 4) = year Then
                Select Case method
                    Case "1想定外STAGE": unexp1 = unexp1 + ET_Count(k)
                    Case "2想定外STAGE": unexp2 = unexp2 + ET_Count(k)
                    Case "混在：1想定外 + 他": mixed = mixed + ET_Count(k)
                End Select
            End If
        End If
    Next

    totalC = unexp1 + unexp2 / 2 + mixed / 2
    totalR = unexp1 + unexp2 + mixed
    
    outKey = year & "_" & "AllClinic" & "_unexp"
    
        If totalC <> 0 And GS_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(r, baseCol + 10).NumberFormat = "0.0"
        ws.Cells(r, baseCol + 10).value = Round(totalC / GS_globalEgg_Count_Denominator(outKey) * 100, 1)
        ws.Cells(r, baseCol + 11).value = "'" & totalC & "/" & GS_globalEgg_Count_Denominator(outKey)
        

        Else
          wsSummary.Cells(r, baseCol + 10).NumberFormat = "0.0"
          wsSummary.Cells(r, baseCol + 10).value = 0
          wsSummary.Cells(r, baseCol + 11).value = "'" & totalC & "/" & GS_globalEgg_Count_Denominator(outKey)
        End If
    
Next i


'全期間×各院

'Dim lastYear As String
'lastYear = yearArray(UBound(yearArray)) - 1  ' 前年度

Dim cIdx As Variant
 baseRow = 10   ' 件数：L7（行7）
 baseCol = 19  ' 列S（19）
 
c = 0

For Each cIdx In clinicList.keys
    clinic = cIdx

     Set countDict = CreateObject("Scripting.Dictionary")
    Set eggDict = CreateObject("Scripting.Dictionary")
    Dim etType As Variant
    For Each etType In keys: countDict(etType) = 0: eggDict(etType) = 0: Next

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 3 Then
            year = parts(2)
            If parts(0) = clinic Then
                For Each m In methodList
                    If InStr(k, m) > 0 Then
                        cnt = ET_Count(k)
                        egg = cnt  ' 卵数は補正なし
                         half = Not IsError(Application.Match(m, correctHalfList, 0))

                        ' All
                        countDict("All") = countDict("All") + IIf(half, cnt / 2, cnt)
                        eggDict("All") = eggDict("All") + egg

                        ' 個別
                        If m = "1BT" Then countDict("1BT") = countDict("1BT") + cnt: eggDict("1BT") = eggDict("1BT") + egg
                        If m = "2BT" Then countDict("2BT") = countDict("2BT") + cnt / 2: eggDict("2BT") = eggDict("2BT") + egg
                        If m = "2StepET" Then countDict("2StepET") = countDict("2StepET") + cnt / 2: eggDict("2StepET") = eggDict("2StepET") + egg
                        If m = "1分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt: eggDict("Cleavage") = eggDict("Cleavage") + egg
                        If m = "2分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt / 2: eggDict("Cleavage") = eggDict("Cleavage") + egg
                    End If
                Next
            End If
        End If
    Next

    ' 出力（8列おきに右へ）
    Dim colOffset As Long: colOffset = baseCol + c * 15
    For j = 0 To 4
        outKey = Format(clinic, "00") & "_" & keys(j)
        
        If eggDict(keys(j)) <> 0 And GS_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(baseRow, colOffset + j * 2).NumberFormat = "0.0"
        ws.Cells(baseRow, colOffset + j * 2).value = Round(countDict(keys(j)) / GS_globalEgg_Count_Denominator(outKey) * 100, 1)     ' 件数
        ws.Cells(baseRow, colOffset + j * 2 + 1).value = "'" & countDict(keys(j)) & "/" & GS_globalEgg_Count_Denominator(outKey)
'        ws.Cells(baseRow + 1, colOffset + j).value = eggDict(keys(j))    ' 卵数（1行下）
        
        ' グローバル変数に格納
'        outKey = Format(clinic, "00") & "_" & keys(j)
'        globalET_Count(outKey) = countDict(keys(j))
'        globalEgg_Count(outKey) = eggDict(keys(j))

        Else
          wsSummary.Cells(baseRow, colOffset + j * 2).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, colOffset + j * 2).value = 0
          ws.Cells(baseRow, colOffset + j * 2 + 1).value = "'" & countDict(keys(j)) & "/" & GS_globalEgg_Count_Denominator(outKey)
        End If
        
    Next j
    
           ' === 想定外3分類の合算（クリニック単位・全期間） ===
    unexp1 = 0
    unexp2 = 0
    mixed = 0

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 2 Then
            Dim cl As String: cl = parts(0)
            method = parts(1)

            If cl = clinic Then
                Select Case method
                    Case "1想定外STAGE": unexp1 = unexp1 + ET_Count(k)
                    Case "2想定外STAGE": unexp2 = unexp2 + ET_Count(k)
                    Case "混在：1想定外 + 他": mixed = mixed + ET_Count(k)
                End Select
            End If
        End If
    Next

    totalC = unexp1 + unexp2 / 2 + mixed / 2
    totalR = unexp1 + unexp2 + mixed
    
         outKey = Format(clinic, "00") & "_" & "unexp"
    
        If totalC <> 0 And GS_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(baseRow, colOffset + 10).NumberFormat = "0.0"
        ws.Cells(baseRow, colOffset + 10).value = Round(totalC / GS_globalEgg_Count_Denominator(outKey) * 100, 1)
        ws.Cells(baseRow, colOffset + 11).value = "'" & totalC & "/" & GS_globalEgg_Count_Denominator(outKey)
        

        Else
          wsSummary.Cells(baseRow, colOffset + 10).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, colOffset + 10).value = 0
          wsSummary.Cells(baseRow, colOffset + 11).value = "'" & totalC & "/" & GS_globalEgg_Count_Denominator(outKey)
        End If
    
     c = c + 1
Next cIdx

End Sub

Sub ET07_FHB_Counts_Denominator()

    Dim wsPivot As Worksheet
    Dim wsSummary As Worksheet
    Dim pt As pivotTable
    Dim lastCol As Long, lastRow As Long
    Dim methodRow As Long, clinicRow As Long
    Dim yearCol As Long
    Dim totalRow As Long
    Dim colLabel1 As String, colLabel2 As String
    Dim prevLabel1 As String
    Dim value As Variant
    Dim c As Long, r As Long
    Dim totalSum As Double
    Dim currentRowOffset As Long
    Dim yearmonth As Variant, year As Variant, month As Variant
    Dim cell As Range
    Dim methodName As Variant
    Dim baseCol As Long, baseMethodCol As Long
    Dim currentYear As Variant
    Dim yearList As Collection
    Dim yearArray() As Variant
    Dim i As Long, j As Long, tmp As Variant
    Dim yearExists As Boolean
    Dim hospitalMap As Object
    Dim sortedHospitals As Variant
    Dim hospitalName As Variant
    Dim clinicID As String
    Dim hospitalIndex As Long
       
       
    Set FHB_globalEgg_Count_Denominator = CreateObject("Scripting.Dictionary")
       

    ' ピボットシートと出力先シートの設定
    Set wsPivot = ThisWorkbook.Sheets("S12_母数_FHB")
    Set wsSummary = ThisWorkbook.Sheets("移植サマリー")
    Set pt = wsPivot.PivotTables("P12_母数_FHB")

    ' ピボットの行・列情報を取得
    yearCol = pt.TableRange2.Column

    ETmethodRow = pt.RowRange.row - 1
    clinicRow = pt.RowRange.row
    rowYear = pt.RowRange.row + 1
    Dim dataStartRow As Long: dataStartRow = rowYear ' データ本体の開始行

    lastCol = pt.TableRange2.Columns.count + pt.TableRange2.Column - 1
    lastRow = pt.TableRange2.Rows.count + pt.TableRange2.row - 1
    totalRow = lastRow
    
     ' 年度リストを作成
    yearArray = GetSortedYearsFromPivot()

    ' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
    Dim yearDict As Object
    Set yearDict = CreateObject("Scripting.Dictionary")

    For i = UBound(yearArray) To LBound(yearArray) Step -1
        If Not yearDict.Exists(yearArray(i)) Then
            yearDict.Add yearArray(i), True
        End If
    Next i


    ' 院マップと識別番号でソートされた院名リストを取得
    Set hospitalMap = GetHospitalMap()
    sortedHospitals = SortKeysByValue(hospitalMap)

    ' データ列の開始列
    Dim firstDataCol As Long: firstDataCol = pt.TableRange2.Column
    
        ' データ集計
     ' 集計用ディクショナリ
    Dim ET_Count As Object
    Set ET_Count = CreateObject("Scripting.Dictionary")
    
    For r = dataStartRow To lastRow - 1 ' 最終行（総計）は除外
        yearmonth = wsPivot.Cells(r, firstDataCol).value
        If IsNumeric(yearmonth) Then
            year = yearmonth
        Else
            month = yearmonth
            yearMonthKey = year & "_" & month

            For c = firstDataCol To lastCol - 1 ' 最終列（総計）は除外
                If wsPivot.Cells(ETmethodRow, c).value <> "" Then prevMethod = Trim(wsPivot.Cells(ETmethodRow, c).value)
                method = prevMethod

                If wsPivot.Cells(clinicRow, c).value <> "" Then prevClinic = Trim(wsPivot.Cells(clinicRow, c).value)
                clinic = prevClinic

                value = wsPivot.Cells(r, c).value

                If method <> "" And clinic <> "" And IsNumeric(value) Then
                    Dim uniqueKey As String
                    
                    uniqueKey = Format(clinic, "00") & "_" & method & "_" & yearMonthKey

                    If Not ET_Count.Exists(uniqueKey) Then
                        ET_Count.Add uniqueKey, value
                    Else
                        ET_Count(uniqueKey) = ET_Count(uniqueKey) + value
                    End If
                End If
            Next c
        End If
    Next r


    ' === 院識別番号一覧を抽出 ===
    Dim clinicList As Object
    Set clinicList = CreateObject("Scripting.Dictionary")
    
For i = LBound(sortedHospitals) To UBound(sortedHospitals)
    Dim code As String
    code = Format(i + 1, "00")  ' "01", "02", ...
    
    If Not clinicList.Exists(code) Then
        clinicList.Add code, True
    End If
Next i


' === 各年度 × 院別 × 移植方法の合算値を出力（補正あり＆なし）===
Dim yearClinicSumDict As Object
Set yearClinicSumDict = CreateObject("Scripting.Dictionary")

Dim methodList As Variant
methodList = Array("1BT", "2BT", "2StepET", "1分割胚", "2分割胚", "1想定外STAGE", "2想定外STAGE", "混在：1想定外 + 他")

' 集計：分類ごとに件数を格納
For Each method In methodList
    For Each k In ET_Count.keys
'        If InStr(k, method) > 0 Then
            parts = Split(k, "_")
            If UBound(parts) >= 3 Then
             If parts(1) = method Then
                gClinic = parts(0)
                localYear = parts(2)
                
                If yearDict.Exists(localYear) And clinicList.Exists(gClinic) Then
                    yckey = localYear & "_" & Format(gClinic, "00") & "_" & method
                    If yearClinicSumDict.Exists(yckey) Then
                        yearClinicSumDict(yckey) = yearClinicSumDict(yckey) + ET_Count(k)
                    Else
                        yearClinicSumDict.Add yckey, ET_Count(k)
                    End If
                End If
            End If
        End If
    Next k
Next method


' === 出力設定 ===
Dim methodMap As Object
Set methodMap = CreateObject("Scripting.Dictionary")
methodMap.Add "1BT", Array(1, False)
methodMap.Add "2BT", Array(2, True)
methodMap.Add "2StepET", Array(3, True)
methodMap.Add "1+2分割胚", Array(4, "mixed")
methodMap.Add "1想定外STAGE", Array(5, False)
methodMap.Add "2想定外STAGE", Array(6, True)
methodMap.Add "混在：1想定外 + 他", Array(7, True)

' 年度を新しい順に並び替え
' 年度を昇順にソート
Call QuickSort(yearArray, LBound(yearArray), UBound(yearArray))

' ソート後、逆順に入れ替え（新しい年度順）
Dim sortedYears() As Variant
Dim n As Long

n = UBound(yearArray) - LBound(yearArray) + 1
ReDim sortedYears(0 To n - 1)

For i = 0 To n - 1
    sortedYears(i) = yearArray(UBound(yearArray) - i)
Next i

' === 出力処理 ===
Dim yearIndex As Long, clinicIndex As Long
For yearIndex = LBound(sortedYears) To UBound(sortedYears)
    Dim yearItem As Variant: yearItem = sortedYears(yearIndex)
    Dim rowBase As Long: rowBase = 16 + yearIndex * 9

    clinicIndex = 0
    For Each clinicItem In clinicList.keys
        Dim clinicCode As String: clinicCode = Format(clinicItem, "00")
        Dim colStart As Long: colStart = 12 + clinicIndex * 8 ' M列スタート

        Dim totalWithCorrection As Double: totalWithCorrection = 0
        Dim totalNoCorrection As Double: totalNoCorrection = 0

        ' 分類ごとに出力
        For Each method In methodMap.keys
            Dim offset As Long: offset = methodMap(method)(0)
            Dim applyCorrection As Variant: applyCorrection = methodMap(method)(1)

            Dim valueWithCorrection As Double: valueWithCorrection = 0
            Dim valueRaw As Double: valueRaw = 0

            If method = "1+2分割胚" Then
                Dim v1 As Double: v1 = 0
                Dim v2 As Double: v2 = 0
                If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "1分割胚") Then
                    v1 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "1分割胚")
                End If
                If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "2分割胚") Then
                    v2 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "2分割胚")
                End If
                valueWithCorrection = v1 + v2 / 2
                valueRaw = v1 + v2
            Else
                Dim key As String: key = yearItem & "_" & clinicCode & "_" & method
                If yearClinicSumDict.Exists(key) Then
                    valueRaw = yearClinicSumDict(key)
                    valueWithCorrection = IIf(applyCorrection = True, valueRaw / 2, valueRaw)
                End If
            End If
            
            Dim outKey As String: outKey = yearItem & "_" & Format(clinicItem, "00") & "_" & method

' 出力時に分岐
If method <> "1想定外STAGE" And method <> "2想定外STAGE" And method <> "混在：1想定外 + 他" Then

            ' 出力（補正あり（件数）：上段、補正なし（卵数）：下段）
'            wsSummary.Cells(rowBase, colStart + offset).value = valueWithCorrection
'            wsSummary.Cells(rowBase + 1, colStart + offset).value = valueRaw
            
             ' グローバル変数に格納
'             hCG_globalET_Count_Denominator(outKey) = valueWithCorrection
             FHB_globalEgg_Count_Denominator(outKey) = valueRaw
             
            End If

            ' === 総合値（補正あり）の加算 ===
totalWithCorrection = totalWithCorrection + valueWithCorrection

' === 総合値（補正なし）の加算 ===
totalNoCorrection = totalNoCorrection + valueRaw

        Next method

        ' 総合値（0列目）
'        wsSummary.Cells(rowBase, colStart).value = totalWithCorrection
'        wsSummary.Cells(rowBase + 1, colStart).value = totalNoCorrection
        
        ' グローバル変数に格納
        outKey = yearItem & "_" & Format(clinicItem, "00") & "_All"
'             hCG_globalET_Count_Denominator(outKey) = totalWithCorrection
             FHB_globalEgg_Count_Denominator(outKey) = totalNoCorrection
             
        ' --- 想定外系合計の出力 ---
        Dim unexpected1 As Double, unexpected2 As Double, mixed As Double
        unexpected1 = 0: unexpected2 = 0: mixed = 0

        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "1想定外STAGE") Then
            unexpected1 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "1想定外STAGE")
        End If
        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "2想定外STAGE") Then
            unexpected2 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "2想定外STAGE")
        End If
        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "混在：1想定外 + 他") Then
            mixed = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "混在：1想定外 + 他")
        End If

        Dim valueWithCorrectionU As Double, valueRawU As Double
        valueWithCorrectionU = unexpected1 + unexpected2 / 2 + mixed / 2
        valueRawU = unexpected1 + unexpected2 + mixed

        ' 分割胚(列番号8)の2列隣 = offset 10
'        wsSummary.Cells(rowBase, colStart + 10).value = valueWithCorrectionU
'        wsSummary.Cells(rowBase + 1, colStart + 10).value = valueRawU
        
         ' グローバル変数に格納
        outKey = yearItem & "_" & Format(clinicItem, "00") & "_unexpected"
        FHB_globalEgg_Count_Denominator(outKey) = valueRawU

        clinicIndex = clinicIndex + 1
    Next clinicItem
Next yearIndex


'' === 全期間 × ET方法ごとの合計値を記録・出力 ===

Dim totalRaw As Object: Set totalRaw = CreateObject("Scripting.Dictionary")
Dim totalCorrected As Object: Set totalCorrected = CreateObject("Scripting.Dictionary")

' 出力対象（E列?）→ 見せたい分類のみ
Dim outputMethods As Variant
outputMethods = Array("1BT", "2BT", "2StepET", "分割胚")

'' 全体集計対象（D列：総合に含める分類すべて）
'Dim allMethods As Variant
'allMethods = Array("1BT", "2BT", "2StepET", "1分割胚", "2分割胚", "1想定外STAGE", "2想定外STAGE", "混在：1想定外 + 他")

' 2で割る分類
Dim correctHalfList As Variant
correctHalfList = Array("2BT", "2StepET", "2分割胚", "2想定外STAGE", "混在：1想定外 + 他")

Dim raw As Double, corrected As Double

' === 件数集計（全分類） ===
For Each method In methodList
    raw = 0
    For Each k In ET_Count.keys
        If InStr(k, method) > 0 Then raw = raw + ET_Count(k)
    Next k
    totalRaw(method) = raw
    If Not IsError(Application.Match(method, correctHalfList, 0)) Then
        totalCorrected(method) = raw / 2
    Else
        totalCorrected(method) = raw
    End If
Next method

' === 総合（補正あり／なし） ===
Dim sumRaw As Double: sumRaw = 0
Dim sumCorrected As Double: sumCorrected = 0
For Each method In methodList
    sumRaw = sumRaw + totalRaw(method)
    sumCorrected = sumCorrected + totalCorrected(method)
Next method

' === 出力処理 ===
Dim ws As Worksheet: Set ws = wsSummary
Dim baseRow As Long: baseRow = 7
 baseCol = 4  ' D列

' 総合値をD列へ出力
'ws.Cells(baseRow, baseCol).value = sumCorrected
'ws.Cells(baseRow + 1, baseCol).value = sumRaw

        ' グローバル変数に格納
        outKey = "AllClinic" & "_Allmethod"
'        hCG_globalET_Count_Denominator(outKey) = sumCorrected
        FHB_globalEgg_Count_Denominator(outKey) = sumRaw


' 出力対象のみを右に並べて出力（E列-）
For i = 0 To UBound(outputMethods)
    method = outputMethods(i)
    If method = "分割胚" Then
'        ws.Cells(baseRow, baseCol + 1 + i).value = totalCorrected("1分割胚") + totalCorrected("2分割胚")
'        ws.Cells(baseRow + 1, baseCol + 1 + i).value = totalRaw("1分割胚") + totalRaw("2分割胚")
        
         ' グローバル変数に格納
        outKey = "AllClinic" & "_" & method
'        hCG_globalET_Count_Denominator(outKey) = totalCorrected("1分割胚") + totalCorrected("2分割胚")
        FHB_globalEgg_Count_Denominator(outKey) = totalRaw("1分割胚") + totalRaw("2分割胚")
        
    Else
'        ws.Cells(baseRow, baseCol + 1 + i).value = totalCorrected(method)
'        ws.Cells(baseRow + 1, baseCol + 1 + i).value = totalRaw(method)
        
        ' グローバル変数に格納
        outKey = "AllClinic" & "_" & method
'        hCG_globalET_Count_Denominator(outKey) = totalCorrected(method)
        FHB_globalEgg_Count_Denominator(outKey) = totalRaw(method)

    End If
Next i

' === 想定外合算の出力 ===
unexpected1 = 0: unexpected2 = 0: mixed = 0

If totalRaw.Exists("1想定外STAGE") Then unexpected1 = totalRaw("1想定外STAGE")
If totalRaw.Exists("2想定外STAGE") Then unexpected2 = totalRaw("2想定外STAGE")
If totalRaw.Exists("混在：1想定外 + 他") Then mixed = totalRaw("混在：1想定外 + 他")

valueWithCorrectionU = 0
valueRawU = 0

valueWithCorrectionU = unexpected1 + unexpected2 / 2 + mixed / 2
valueRawU = unexpected1 + unexpected2 + mixed

'' 分割胚（=baseCol + 6）の2列右 → baseCol + 8
'ws.Cells(baseRow, baseCol + 10).value = valueWithCorrectionU
'ws.Cells(baseRow + 1, baseCol + 10).value = valueRawU

        ' グローバル変数に格納
        outKey = "AllClinic" & "_" & "unexpected"
        FHB_globalEgg_Count_Denominator(outKey) = valueRawU


'' === 各年度 × ET方法ごとの合計値を記録 ===

 baseRow = 16
 baseCol = 4

For i = 0 To UBound(yearArray)
    year = yearArray(i)

    Dim countDict As Object: Set countDict = CreateObject("Scripting.Dictionary")
    Dim eggDict As Object: Set eggDict = CreateObject("Scripting.Dictionary")
    Dim ET_Eggs As Object: Set ET_Eggs = CreateObject("Scripting.Dictionary")
    Dim keys: keys = Array("All", "1BT", "2BT", "2StepET", "Cleavage")
    For Each k In keys: countDict(k) = 0: eggDict(k) = 0: Next

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 3 And parts(2) = year Then
            For Each m In methodList
                If InStr(k, m) > 0 Then
                    Dim cnt As Double: cnt = ET_Count(k)
                    Dim egg As Double: egg = cnt
                    Dim half As Boolean: half = Not IsError(Application.Match(m, correctHalfList, 0))

                    ' All
                    countDict("All") = countDict("All") + IIf(half, cnt / 2, cnt)
                    eggDict("All") = eggDict("All") + egg

                    ' 個別
                    If m = "1BT" Then countDict("1BT") = countDict("1BT") + cnt: eggDict("1BT") = eggDict("1BT") + egg
                    If m = "2BT" Then countDict("2BT") = countDict("2BT") + cnt / 2: eggDict("2BT") = eggDict("2BT") + egg
                    If m = "2StepET" Then countDict("2StepET") = countDict("2StepET") + cnt / 2: eggDict("2StepET") = eggDict("2StepET") + egg
                    If m = "1分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt: eggDict("Cleavage") = eggDict("Cleavage") + egg
                    If m = "2分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt / 2: eggDict("Cleavage") = eggDict("Cleavage") + egg
                End If
            Next
        End If
    Next

    ' 出力（9行ごと）
 r = baseRow + i * 9
    For j = 0 To 4
'        ws.Cells(r, baseCol + j).value = countDict(keys(j))
'        ws.Cells(r + 1, baseCol + j).value = eggDict(keys(j))
        
        ' グローバル変数に格納
        outKey = year & "_" & "AllClinic" & keys(j)
'        hCG_globalET_Count_Denominator(outKey) = countDict(keys(j))
        FHB_globalEgg_Count_Denominator(outKey) = eggDict(keys(j))

    Next j
    
                ' === 想定外3分類の合算出力 ===
    unexp1 = 0
    unexp2 = 0
    mixed = 0

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 2 Then
           method = parts(1)
            Dim ym As String: ym = parts(2)
            If Left(ym, 4) = year Then
                Select Case method
                    Case "1想定外STAGE": unexp1 = unexp1 + ET_Count(k)
                    Case "2想定外STAGE": unexp2 = unexp2 + ET_Count(k)
                    Case "混在：1想定外 + 他": mixed = mixed + ET_Count(k)
                End Select
            End If
        End If
    Next

    totalC = unexp1 + unexp2 / 2 + mixed / 2
    totalR = unexp1 + unexp2 + mixed

'    ws.Cells(r, baseCol + 10).value = totalC
'    ws.Cells(r + 1, baseCol + 10).value = totalR
    
         ' グローバル変数に格納
        outKey = year & "_" & "AllClinic" & "_unexp"
        FHB_globalEgg_Count_Denominator(outKey) = totalR
Next i

'全期間×各院

Dim lastYear As String
lastYear = yearArray(UBound(yearArray)) - 1  ' 前年度

Dim cIdx As Variant
 baseRow = 7   ' 件数：L7（行7）
 baseCol = 12  ' 列L（12）
 
c = 0

For Each cIdx In clinicList.keys
    clinic = cIdx

     Set countDict = CreateObject("Scripting.Dictionary")
    Set eggDict = CreateObject("Scripting.Dictionary")
    Dim etType As Variant
    For Each etType In keys: countDict(etType) = 0: eggDict(etType) = 0: Next

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 3 Then
            year = parts(2)
            If parts(0) = clinic Then
                For Each m In methodList
                    If InStr(k, m) > 0 Then
                        cnt = ET_Count(k)
                        egg = cnt  ' 卵数は補正なし
                         half = Not IsError(Application.Match(m, correctHalfList, 0))

                        ' All
                        countDict("All") = countDict("All") + IIf(half, cnt / 2, cnt)
                        eggDict("All") = eggDict("All") + egg

                        ' 個別
                        If m = "1BT" Then countDict("1BT") = countDict("1BT") + cnt: eggDict("1BT") = eggDict("1BT") + egg
                        If m = "2BT" Then countDict("2BT") = countDict("2BT") + cnt / 2: eggDict("2BT") = eggDict("2BT") + egg
                        If m = "2StepET" Then countDict("2StepET") = countDict("2StepET") + cnt / 2: eggDict("2StepET") = eggDict("2StepET") + egg
                        If m = "1分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt: eggDict("Cleavage") = eggDict("Cleavage") + egg
                        If m = "2分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt / 2: eggDict("Cleavage") = eggDict("Cleavage") + egg
                    End If
                Next
            End If
        End If
    Next

    ' 出力（8列おきに右へ）
    Dim colOffset As Long: colOffset = baseCol + c * 8
    For j = 0 To 4
'        ws.Cells(baseRow, colOffset + j).value = countDict(keys(j))      ' 件数
'        ws.Cells(baseRow + 1, colOffset + j).value = eggDict(keys(j))    ' 卵数（1行下）
        
        ' グローバル変数に格納
        outKey = Format(clinic, "00") & "_" & keys(j)
'        hCG_globalET_Count_Denominator(outKey) = countDict(keys(j))
        FHB_globalEgg_Count_Denominator(outKey) = eggDict(keys(j))
        
    Next j
    
           ' === 想定外3分類の合算（クリニック単位・全期間） ===
    unexp1 = 0
    unexp2 = 0
    mixed = 0

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 2 Then
            Dim cl As String: cl = parts(0)
            method = parts(1)

            If cl = clinic Then
                Select Case method
                    Case "1想定外STAGE": unexp1 = unexp1 + ET_Count(k)
                    Case "2想定外STAGE": unexp2 = unexp2 + ET_Count(k)
                    Case "混在：1想定外 + 他": mixed = mixed + ET_Count(k)
                End Select
            End If
        End If
    Next

    totalC = unexp1 + unexp2 / 2 + mixed / 2
    totalR = unexp1 + unexp2 + mixed
    
    ' グローバル変数に格納
    outKey = Format(clinic, "00") & "_" & "unexp"
    FHB_globalEgg_Count_Denominator(outKey) = totalR

     c = c + 1
Next cIdx

End Sub

Sub ET08_FHB_Counts()

    Dim wsPivot As Worksheet
    Dim wsSummary As Worksheet
    Dim pt As pivotTable
    Dim lastCol As Long, lastRow As Long
    Dim methodRow As Long, clinicRow As Long
    Dim yearCol As Long
    Dim totalRow As Long
    Dim colLabel1 As String, colLabel2 As String
    Dim prevLabel1 As String
    Dim value As Variant
    Dim c As Long, r As Long
    Dim totalSum As Double
    Dim currentRowOffset As Long
    Dim yearmonth As Variant, year As Variant, month As Variant
    Dim cell As Range
    Dim methodName As Variant
    Dim baseCol As Long, baseMethodCol As Long
    Dim currentYear As Variant
    Dim yearList As Collection
    Dim yearArray() As Variant
    Dim i As Long, j As Long, tmp As Variant
    Dim yearExists As Boolean
    Dim hospitalMap As Object
    Dim sortedHospitals As Variant
    Dim hospitalName As Variant
    Dim clinicID As String
    Dim hospitalIndex As Long


    ' ピボットシートと出力先シートの設定
    Set wsPivot = ThisWorkbook.Sheets("S12_FHB")
    Set wsSummary = ThisWorkbook.Sheets("移植サマリー")
    Set pt = wsPivot.PivotTables("P12_FHB")

    ' ピボットの行・列情報を取得
    yearCol = pt.TableRange2.Column

    ETmethodRow = pt.RowRange.row - 1
    clinicRow = pt.RowRange.row
    rowYear = pt.RowRange.row + 1
    Dim dataStartRow As Long: dataStartRow = rowYear ' データ本体の開始行

    lastCol = pt.TableRange2.Columns.count + pt.TableRange2.Column - 1
    lastRow = pt.TableRange2.Rows.count + pt.TableRange2.row - 1
    totalRow = lastRow
    
      ' 年度リストを作成
    yearArray = GetSortedYearsFromPivot()

    ' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
    Dim yearDict As Object
    Set yearDict = CreateObject("Scripting.Dictionary")

    For i = UBound(yearArray) To LBound(yearArray) Step -1
        If Not yearDict.Exists(yearArray(i)) Then
            yearDict.Add yearArray(i), True
        End If
    Next i


'    ' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
'Dim yearDict As Object
'Set yearDict = CreateObject("Scripting.Dictionary")
'
'' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
'On Error Resume Next
'For Each cell In wsPivot.Range(wsPivot.Cells(rowYear, yearCol), wsPivot.Cells(totalRow - 1, yearCol))
'    If cell.IndentLevel = 0 And IsNumeric(cell.value) Then
'        If Not yearDict.Exists(cell.value) Then
'            yearDict.Add cell.value, 1 ' 値をキーとして、値は任意（ここでは 1）
'        End If
'    End If
'Next cell
'On Error GoTo 0
'
'' 年度リストが空なら終了
'If yearDict.Count = 0 Then Exit Sub
'
'' Dictionary のキーを配列に変換して昇順にソート
'yearArray = yearDict.keys
'
'' ソート（昇順）
'Call QuickSort(yearArray, LBound(yearArray), UBound(yearArray))
'
''' ソート後の年を使用する場合
''For i = LBound(yearArray) To UBound(yearArray)
''    Debug.Print yearArray(i) ' 年度を表示
''Next i

    ' 院マップと識別番号でソートされた院名リストを取得
    Set hospitalMap = GetHospitalMap()
    sortedHospitals = SortKeysByValue(hospitalMap)

    ' データ列の開始列
    Dim firstDataCol As Long: firstDataCol = pt.TableRange2.Column
    
        ' データ集計
     ' 集計用ディクショナリ
    Dim ET_Count As Object
    Set ET_Count = CreateObject("Scripting.Dictionary")
    
    For r = dataStartRow To lastRow - 1 ' 最終行（総計）は除外
        yearmonth = wsPivot.Cells(r, firstDataCol).value
        If IsNumeric(yearmonth) Then
            year = yearmonth
        Else
            month = yearmonth
            yearMonthKey = year & "_" & month

            For c = firstDataCol To lastCol - 1 ' 最終列（総計）は除外
                If wsPivot.Cells(ETmethodRow, c).value <> "" Then prevMethod = Trim(wsPivot.Cells(ETmethodRow, c).value)
                method = prevMethod

                If wsPivot.Cells(clinicRow, c).value <> "" Then prevClinic = Trim(wsPivot.Cells(clinicRow, c).value)
                clinic = prevClinic

                value = wsPivot.Cells(r, c).value

                If method <> "" And clinic <> "" And IsNumeric(value) Then
                    Dim uniqueKey As String
                    
                    uniqueKey = Format(clinic, "00") & "_" & method & "_" & yearMonthKey

                    If Not ET_Count.Exists(uniqueKey) Then
                        ET_Count.Add uniqueKey, value
                    Else
                        ET_Count(uniqueKey) = ET_Count(uniqueKey) + value
                    End If
                End If
            Next c
        End If
    Next r


    ' === 院識別番号一覧を抽出 ===
    Dim clinicList As Object
    Set clinicList = CreateObject("Scripting.Dictionary")
    
For i = LBound(sortedHospitals) To UBound(sortedHospitals)
    Dim code As String
    code = Format(i + 1, "00")  ' "01", "02", ...
    
    If Not clinicList.Exists(code) Then
        clinicList.Add code, True
    End If
Next i


' === 各年度 × 院別 × 移植方法の合算値を出力（補正あり＆なし）===
Dim yearClinicSumDict As Object
Set yearClinicSumDict = CreateObject("Scripting.Dictionary")

Dim methodList As Variant
methodList = Array("1BT", "2BT", "2StepET", "1分割胚", "2分割胚", "1想定外STAGE", "2想定外STAGE", "混在：1想定外 + 他")

' 集計：分類ごとに件数を格納
For Each method In methodList
    For Each k In ET_Count.keys
'        If InStr(k, method) > 0 Then
            parts = Split(k, "_")
            If UBound(parts) >= 3 Then
             If parts(1) = method Then
                gClinic = parts(0)
                localYear = parts(2)
                
                If yearDict.Exists(localYear) And clinicList.Exists(gClinic) Then
                    yckey = localYear & "_" & Format(gClinic, "00") & "_" & method
                    If yearClinicSumDict.Exists(yckey) Then
                        yearClinicSumDict(yckey) = yearClinicSumDict(yckey) + ET_Count(k)
                    Else
                        yearClinicSumDict.Add yckey, ET_Count(k)
                    End If
                End If
            End If
        End If
    Next k
Next method


' === 出力設定 ===
Dim methodMap As Object
Set methodMap = CreateObject("Scripting.Dictionary")
methodMap.Add "1BT", Array(1, False)
methodMap.Add "2BT", Array(2, True)
methodMap.Add "2StepET", Array(3, True)
methodMap.Add "1+2分割胚", Array(4, "mixed")
methodMap.Add "1想定外STAGE", Array(5, False)
methodMap.Add "2想定外STAGE", Array(6, True)
methodMap.Add "混在：1想定外 + 他", Array(7, True)

' 年度を新しい順に並び替え
' 年度を昇順にソート
Call QuickSort(yearArray, LBound(yearArray), UBound(yearArray))

' ソート後、逆順に入れ替え（新しい年度順）
Dim sortedYears() As Variant
Dim n As Long

n = UBound(yearArray) - LBound(yearArray) + 1
ReDim sortedYears(0 To n - 1)

For i = 0 To n - 1
    sortedYears(i) = yearArray(UBound(yearArray) - i)
Next i

' === 出力処理 ===
Dim yearIndex As Long, clinicIndex As Long
For yearIndex = LBound(sortedYears) To UBound(sortedYears)
    Dim yearItem As Variant: yearItem = sortedYears(yearIndex)
    Dim rowBase As Long: rowBase = 20 + yearIndex * 9

    clinicIndex = 0
    For Each clinicItem In clinicList.keys
        Dim clinicCode As String: clinicCode = Format(clinicItem, "00")
        Dim colStart As Long: colStart = 19 + clinicIndex * 15 ' M列スタート

        Dim totalWithCorrection As Double: totalWithCorrection = 0
        Dim totalNoCorrection As Double: totalNoCorrection = 0

        ' 分類ごとに出力
        For Each method In methodMap.keys
            Dim offset As Long: offset = methodMap(method)(0)
            Dim applyCorrection As Variant: applyCorrection = methodMap(method)(1)

            Dim valueWithCorrection As Double: valueWithCorrection = 0
            Dim valueRaw As Double: valueRaw = 0

            If method = "1+2分割胚" Then
                Dim v1 As Double: v1 = 0
                Dim v2 As Double: v2 = 0
                If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "1分割胚") Then
                    v1 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "1分割胚")
                End If
                If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "2分割胚") Then
                    v2 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "2分割胚")
                End If
                valueWithCorrection = v1 + v2 / 2
                valueRaw = v1 + v2
            Else
                Dim key As String: key = yearItem & "_" & clinicCode & "_" & method
                If yearClinicSumDict.Exists(key) Then
                    valueRaw = yearClinicSumDict(key)
                    valueWithCorrection = IIf(applyCorrection = True, valueRaw / 2, valueRaw)
                End If
            End If
            
            Dim outKey As String: outKey = yearItem & "_" & Format(clinicItem, "00") & "_" & method

' 出力時に分岐
If method <> "1想定外STAGE" And method <> "2想定外STAGE" And method <> "混在：1想定外 + 他" Then
                
    If valueWithCorrection <> 0 And FHB_globalEgg_Count_Denominator(outKey) <> 0 Then

            ' 出力（補正あり（件数）：上段、補正なし（卵数）：下段）
            wsSummary.Cells(rowBase, colStart + offset * 2).NumberFormat = "0.0"
            wsSummary.Cells(rowBase, colStart + offset * 2).value = Round(valueWithCorrection / FHB_globalEgg_Count_Denominator(outKey) * 100, 1)
            wsSummary.Cells(rowBase, colStart + offset * 2 + 1).value = "'" & valueWithCorrection & "/" & FHB_globalEgg_Count_Denominator(outKey)

                    Else
                    wsSummary.Cells(rowBase, colStart + offset * 2).NumberFormat = "0.0"
                    wsSummary.Cells(rowBase, colStart + offset * 2).value = 0
                    wsSummary.Cells(rowBase, colStart + offset * 2 + 1).value = "'" & valueWithCorrection & "/" & FHB_globalEgg_Count_Denominator(outKey)
                End If
             
            End If

            ' === 総合値（補正あり）の加算 ===
totalWithCorrection = totalWithCorrection + valueWithCorrection

' === 総合値（補正なし）の加算 ===
totalNoCorrection = totalNoCorrection + valueRaw

        Next method
        
        outKey = yearItem & "_" & Format(clinicItem, "00") & "_All"
        
        If totalWithCorrection <> 0 And FHB_globalEgg_Count_Denominator(outKey) <> 0 Then

        ' 総合値（0列目）
        wsSummary.Cells(rowBase, colStart).NumberFormat = "0.0"
        wsSummary.Cells(rowBase, colStart).value = Round(totalWithCorrection / FHB_globalEgg_Count_Denominator(outKey) * 100, 1)
        wsSummary.Cells(rowBase, colStart + 1).value = "'" & totalWithCorrection & "/" & FHB_globalEgg_Count_Denominator(outKey)
'        wsSummary.Cells(rowBase + 1, colStart).value = totalNoCorrection

        Else
          wsSummary.Cells(rowBase, colStart).NumberFormat = "0.0"
          wsSummary.Cells(rowBase, colStart).value = 0
          wsSummary.Cells(rowBase, colStart + 1).value = "'" & totalWithCorrection & "/" & FHB_globalEgg_Count_Denominator(outKey)
          
        End If
        
                                 ' --- 想定外系合計の出力 ---
        Dim unexpected1 As Double, unexpected2 As Double, mixed As Double
        unexpected1 = 0: unexpected2 = 0: mixed = 0

        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "1想定外STAGE") Then
            unexpected1 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "1想定外STAGE")
        End If
        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "2想定外STAGE") Then
            unexpected2 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "2想定外STAGE")
        End If
        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "混在：1想定外 + 他") Then
            mixed = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "混在：1想定外 + 他")
        End If

        Dim valueWithCorrectionU As Double, valueRawU As Double
        valueWithCorrectionU = unexpected1 + unexpected2 / 2 + mixed / 2
        valueRawU = unexpected1 + unexpected2 + mixed

        outKey = yearItem & "_" & Format(clinicItem, "00") & "_unexpected"
        
        If valueWithCorrectionU <> 0 And FHB_globalEgg_Count_Denominator(outKey) <> 0 Then

'         分割胚(列番号8)の2列隣 = offset 10
        wsSummary.Cells(rowBase, colStart + 10).NumberFormat = "0.0"
        wsSummary.Cells(rowBase, colStart + 10).value = Round(valueWithCorrectionU / FHB_globalEgg_Count_Denominator(outKey) * 100, 1)
        wsSummary.Cells(rowBase, colStart + 11).value = "'" & valueWithCorrectionU & "/" & FHB_globalEgg_Count_Denominator(outKey)

        Else
          wsSummary.Cells(rowBase, colStart + 10).NumberFormat = "0.0"
          wsSummary.Cells(rowBase, colStart + 10).value = 0
          wsSummary.Cells(rowBase, colStart + 11).value = "'" & valueWithCorrectionU & "/" & FHB_globalEgg_Count_Denominator(outKey)
        End If
        
        clinicIndex = clinicIndex + 1
    Next clinicItem
Next yearIndex


'' === 全期間 × ET方法ごとの合計値を記録・出力 ===

Dim totalRaw As Object: Set totalRaw = CreateObject("Scripting.Dictionary")
Dim totalCorrected As Object: Set totalCorrected = CreateObject("Scripting.Dictionary")

' 出力対象（E列?）→ 見せたい分類のみ
Dim outputMethods As Variant
outputMethods = Array("1BT", "2BT", "2StepET", "分割胚")

'' 全体集計対象（D列：総合に含める分類すべて）
'Dim allMethods As Variant
'allMethods = Array("1BT", "2BT", "2StepET", "1分割胚", "2分割胚", "1想定外STAGE", "2想定外STAGE", "混在：1想定外 + 他")

' 2で割る分類
Dim correctHalfList As Variant
correctHalfList = Array("2BT", "2StepET", "2分割胚", "2想定外STAGE", "混在：1想定外 + 他")

Dim raw As Double, corrected As Double

' === 件数集計（全分類） ===
For Each method In methodList
    raw = 0
    For Each k In ET_Count.keys
        If InStr(k, method) > 0 Then raw = raw + ET_Count(k)
    Next k
    totalRaw(method) = raw
    If Not IsError(Application.Match(method, correctHalfList, 0)) Then
        totalCorrected(method) = raw / 2
    Else
        totalCorrected(method) = raw
    End If
Next method

' === 総合（補正あり／なし） ===
Dim sumRaw As Double: sumRaw = 0
Dim sumCorrected As Double: sumCorrected = 0
For Each method In methodList
    sumRaw = sumRaw + totalRaw(method)
    sumCorrected = sumCorrected + totalCorrected(method)
Next method

' === 出力処理 ===
Dim ws As Worksheet: Set ws = wsSummary
Dim baseRow As Long: baseRow = 11
 baseCol = 4  ' D列

' 総合値をD列へ出力
outKey = "AllClinic" & "_Allmethod"

        If sumCorrected <> 0 And FHB_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(baseRow, baseCol).NumberFormat = "0.0"
        ws.Cells(baseRow, baseCol).value = Round(sumCorrected / FHB_globalEgg_Count_Denominator(outKey) * 100, 1)
        ws.Cells(baseRow, baseCol + 1).value = "'" & sumCorrected & "/" & FHB_globalEgg_Count_Denominator(outKey)
        'ws.Cells(baseRow + 1, baseCol).value = sumRaw

        Else
          wsSummary.Cells(baseRow, baseCol).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, baseCol).value = 0
          ws.Cells(baseRow, baseCol + 1).value = "'" & sumCorrected & "/" & FHB_globalEgg_Count_Denominator(outKey)
        End If

'        ' グローバル変数に格納
'        outKey = "AllClinic" & "_Allmethod"
'        globalET_Count(outKey) = sumCorrected
'        globalEgg_Count(outKey) = sumRaw


' 出力対象のみを右に並べて出力（E列-）
For i = 0 To UBound(outputMethods)
    method = outputMethods(i)
    If method = "分割胚" Then
    
    Dim CountValue As Variant
    Dim EggValue As Variant
    
    outKey = "AllClinic" & "_" & method
    
        CountValue = totalCorrected("1分割胚") + totalCorrected("2分割胚")
        EggValue = totalRaw("1分割胚") + totalRaw("2分割胚")
        
        If CountValue <> 0 And FHB_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(baseRow, baseCol + 2 + i * 2).NumberFormat = "0.0"
        ws.Cells(baseRow, baseCol + 2 + i * 2).value = Round(CountValue / FHB_globalEgg_Count_Denominator(outKey) * 100, 1)
        ws.Cells(baseRow, baseCol + 3 + i * 2).value = "'" & CountValue & "/" & FHB_globalEgg_Count_Denominator(outKey)
        
'        ws.Cells(baseRow + 1, baseCol + 1 + i).value = EggValue
        
        
         ' グローバル変数に格納
'        outKey = "AllClinic" & "_" & method
'        globalET_Count(outKey) = totalCorrected("1分割胚") + totalCorrected("2分割胚")
'        globalEgg_Count(outKey) = totalRaw("1分割胚") + totalRaw("2分割胚")
        
        Else
          wsSummary.Cells(baseRow, baseCol + 2 + i * 2).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, baseCol + 2 + i * 2).value = 0
          ws.Cells(baseRow, baseCol + 3 + i * 2).value = "'" & CountValue & "/" & FHB_globalEgg_Count_Denominator(outKey)

        End If
        
    Else
        outKey = "AllClinic" & "_" & method
        
        If totalCorrected(method) <> 0 And FHB_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(baseRow, baseCol + 2 + i * 2).NumberFormat = "0.0"
        ws.Cells(baseRow, baseCol + 2 + i * 2).value = Round(totalCorrected(method) / FHB_globalEgg_Count_Denominator(outKey) * 100, 1)
        ws.Cells(baseRow, baseCol + 3 + i * 2).value = "'" & totalCorrected(method) & "/" & FHB_globalEgg_Count_Denominator(outKey)
        
'        ws.Cells(baseRow + 1, baseCol + 1 + i).value = totalRaw(method)
        
        ' グローバル変数に格納
'        outKey = "AllClinic" & "_" & method
'        globalET_Count(outKey) = totalCorrected(method)
'        globalEgg_Count(outKey) = totalRaw(method)
        
        Else
          wsSummary.Cells(baseRow, baseCol + 2 + i * 2).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, baseCol + 2 + i * 2).value = 0
          ws.Cells(baseRow, baseCol + 3 + i * 2).value = "'" & totalCorrected(method) & "/" & FHB_globalEgg_Count_Denominator(outKey)

        End If
    End If
Next i

' === 想定外合算の出力 ===
unexpected1 = 0: unexpected2 = 0: mixed = 0

If totalRaw.Exists("1想定外STAGE") Then unexpected1 = totalRaw("1想定外STAGE")
If totalRaw.Exists("2想定外STAGE") Then unexpected2 = totalRaw("2想定外STAGE")
If totalRaw.Exists("混在：1想定外 + 他") Then mixed = totalRaw("混在：1想定外 + 他")

valueWithCorrectionU = 0
valueRawU = 0

valueWithCorrectionU = unexpected1 + unexpected2 / 2 + mixed / 2
valueRawU = unexpected1 + unexpected2 + mixed

outKey = "AllClinic" & "_" & "unexpected"

If valueWithCorrectionU <> 0 And FHB_globalEgg_Count_Denominator(outKey) <> 0 Then

'' 分割胚（=baseCol + 6）の2列右 → baseCol + 8
wsSummary.Cells(baseRow, baseCol + 10).NumberFormat = "0.0"
ws.Cells(baseRow, baseCol + 10).value = Round(valueWithCorrectionU / FHB_globalEgg_Count_Denominator(outKey) * 100, 1)
wsSummary.Cells(baseRow, baseCol + 11).value = "'" & valueWithCorrectionU & "/" & FHB_globalEgg_Count_Denominator(outKey)
        
        Else
          wsSummary.Cells(baseRow, baseCol + 10).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, baseCol + 10).value = 0
          wsSummary.Cells(baseRow, baseCol + 11).value = "'" & valueWithCorrectionU & "/" & FHB_globalEgg_Count_Denominator(outKey)
        End If


'' === 各年度 × ET方法ごとの合計値を記録 ===

 baseRow = 20
 baseCol = 4

For i = 0 To UBound(sortedYears)
    year = sortedYears(i)

    Dim countDict As Object: Set countDict = CreateObject("Scripting.Dictionary")
    Dim eggDict As Object: Set eggDict = CreateObject("Scripting.Dictionary")
    Dim ET_Eggs As Object: Set ET_Eggs = CreateObject("Scripting.Dictionary")
    Dim keys: keys = Array("All", "1BT", "2BT", "2StepET", "Cleavage")
    For Each k In keys: countDict(k) = 0: eggDict(k) = 0: Next

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 3 And parts(2) = year Then
            For Each m In methodList
                If InStr(k, m) > 0 Then
                    Dim cnt As Double: cnt = ET_Count(k)
                    Dim egg As Double: egg = cnt
                    Dim half As Boolean: half = Not IsError(Application.Match(m, correctHalfList, 0))

                    ' All
                    countDict("All") = countDict("All") + IIf(half, cnt / 2, cnt)
                    eggDict("All") = eggDict("All") + egg

                    ' 個別
                    If m = "1BT" Then countDict("1BT") = countDict("1BT") + cnt: eggDict("1BT") = eggDict("1BT") + egg
                    If m = "2BT" Then countDict("2BT") = countDict("2BT") + cnt / 2: eggDict("2BT") = eggDict("2BT") + egg
                    If m = "2StepET" Then countDict("2StepET") = countDict("2StepET") + cnt / 2: eggDict("2StepET") = eggDict("2StepET") + egg
                    If m = "1分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt: eggDict("Cleavage") = eggDict("Cleavage") + egg
                    If m = "2分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt / 2: eggDict("Cleavage") = eggDict("Cleavage") + egg
                End If
            Next
        End If
    Next

    ' 出力（9行ごと）
 r = baseRow + i * 9
    For j = 0 To 4
        outKey = year & "_" & "AllClinic" & keys(j)
        
        If countDict(keys(j)) <> 0 And FHB_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(r, baseCol + j * 2).NumberFormat = "0.0"
        ws.Cells(r, baseCol + j * 2).value = Round(countDict(keys(j)) / FHB_globalEgg_Count_Denominator(outKey) * 100, 1)
        ws.Cells(r, baseCol + j * 2 + 1).value = "'" & countDict(keys(j)) & "/" & FHB_globalEgg_Count_Denominator(outKey)

'        ws.Cells(r + 1, baseCol + j).value = eggDict(keys(j))
        
        ' グローバル変数に格納
'        outKey = year & "_" & "AllClinic" & keys(j)
'        globalET_Count(outKey) = countDict(keys(j))
'        globalEgg_Count(outKey) = eggDict(keys(j))

        Else
          wsSummary.Cells(r, baseCol + j * 2).NumberFormat = "0.0"
          wsSummary.Cells(r, baseCol + j * 2).value = 0
          ws.Cells(r, baseCol + j * 2 + 1).value = "'" & countDict(keys(j)) & "/" & FHB_globalEgg_Count_Denominator(outKey)

        End If
    Next j
    
                    ' === 想定外3分類の合算出力 ===
    unexp1 = 0
    unexp2 = 0
    mixed = 0

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 2 Then
           method = parts(1)
            Dim ym As String: ym = parts(2)
            If Left(ym, 4) = year Then
                Select Case method
                    Case "1想定外STAGE": unexp1 = unexp1 + ET_Count(k)
                    Case "2想定外STAGE": unexp2 = unexp2 + ET_Count(k)
                    Case "混在：1想定外 + 他": mixed = mixed + ET_Count(k)
                End Select
            End If
        End If
    Next

    totalC = unexp1 + unexp2 / 2 + mixed / 2
    totalR = unexp1 + unexp2 + mixed
    
    outKey = year & "_" & "AllClinic" & "_unexp"
    
        If totalC <> 0 And FHB_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(r, baseCol + 10).NumberFormat = "0.0"
        ws.Cells(r, baseCol + 10).value = Round(totalC / FHB_globalEgg_Count_Denominator(outKey) * 100, 1)
        ws.Cells(r, baseCol + 11).value = "'" & totalC & "/" & FHB_globalEgg_Count_Denominator(outKey)
        

        Else
          wsSummary.Cells(r, baseCol + 10).NumberFormat = "0.0"
          wsSummary.Cells(r, baseCol + 10).value = 0
          wsSummary.Cells(r, baseCol + 11).value = "'" & totalC & "/" & FHB_globalEgg_Count_Denominator(outKey)
        End If
Next i


'全期間×各院

'Dim lastYear As String
'lastYear = yearArray(UBound(yearArray)) - 1  ' 前年度

Dim cIdx As Variant
 baseRow = 11   ' 件数：L7（行7）
 baseCol = 19  ' 列L（12）
 
c = 0

For Each cIdx In clinicList.keys
    clinic = cIdx

     Set countDict = CreateObject("Scripting.Dictionary")
    Set eggDict = CreateObject("Scripting.Dictionary")
    Dim etType As Variant
    For Each etType In keys: countDict(etType) = 0: eggDict(etType) = 0: Next

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 3 Then
            year = parts(2)
            If parts(0) = clinic Then
                For Each m In methodList
                    If InStr(k, m) > 0 Then
                        cnt = ET_Count(k)
                        egg = cnt  ' 卵数は補正なし
                         half = Not IsError(Application.Match(m, correctHalfList, 0))

                        ' All
                        countDict("All") = countDict("All") + IIf(half, cnt / 2, cnt)
                        eggDict("All") = eggDict("All") + egg

                        ' 個別
                        If m = "1BT" Then countDict("1BT") = countDict("1BT") + cnt: eggDict("1BT") = eggDict("1BT") + egg
                        If m = "2BT" Then countDict("2BT") = countDict("2BT") + cnt / 2: eggDict("2BT") = eggDict("2BT") + egg
                        If m = "2StepET" Then countDict("2StepET") = countDict("2StepET") + cnt / 2: eggDict("2StepET") = eggDict("2StepET") + egg
                        If m = "1分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt: eggDict("Cleavage") = eggDict("Cleavage") + egg
                        If m = "2分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt / 2: eggDict("Cleavage") = eggDict("Cleavage") + egg
                    End If
                Next
            End If
        End If
    Next

    ' 出力（8列おきに右へ）
    Dim colOffset As Long: colOffset = baseCol + c * 15
    For j = 0 To 4
        outKey = Format(clinic, "00") & "_" & keys(j)
        
        If eggDict(keys(j)) <> 0 And FHB_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(baseRow, colOffset + j * 2).NumberFormat = "0.0"
        ws.Cells(baseRow, colOffset + j * 2).value = Round(countDict(keys(j)) / FHB_globalEgg_Count_Denominator(outKey) * 100, 1)
        ws.Cells(baseRow, colOffset + j * 2 + 1).value = "'" & countDict(keys(j)) & "/" & FHB_globalEgg_Count_Denominator(outKey)
'        ws.Cells(baseRow + 1, colOffset + j).value = eggDict(keys(j))    ' 卵数（1行下）
        
        ' グローバル変数に格納
'        outKey = Format(clinic, "00") & "_" & keys(j)
'        globalET_Count(outKey) = countDict(keys(j))
'        globalEgg_Count(outKey) = eggDict(keys(j))

        Else
          wsSummary.Cells(baseRow, colOffset + j * 2).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, colOffset + j * 2).value = 0
          ws.Cells(baseRow, colOffset + j * 2 + 1).value = "'" & countDict(keys(j)) & "/" & FHB_globalEgg_Count_Denominator(outKey)

        End If
        
    Next j
    
               ' === 想定外3分類の合算（クリニック単位・全期間） ===
    unexp1 = 0
    unexp2 = 0
    mixed = 0

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 2 Then
            Dim cl As String: cl = parts(0)
            method = parts(1)

            If cl = clinic Then
                Select Case method
                    Case "1想定外STAGE": unexp1 = unexp1 + ET_Count(k)
                    Case "2想定外STAGE": unexp2 = unexp2 + ET_Count(k)
                    Case "混在：1想定外 + 他": mixed = mixed + ET_Count(k)
                End Select
            End If
        End If
    Next

    totalC = unexp1 + unexp2 / 2 + mixed / 2
    totalR = unexp1 + unexp2 + mixed
    
         outKey = Format(clinic, "00") & "_" & "unexp"
    
        If totalC <> 0 And FHB_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(baseRow, colOffset + 10).NumberFormat = "0.0"
        ws.Cells(baseRow, colOffset + 10).value = Round(totalC / FHB_globalEgg_Count_Denominator(outKey) * 100, 1)
        ws.Cells(baseRow, colOffset + 11).value = "'" & totalC & "/" & FHB_globalEgg_Count_Denominator(outKey)
        

        Else
          wsSummary.Cells(baseRow, colOffset + 10).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, colOffset + 10).value = 0
          wsSummary.Cells(baseRow, colOffset + 11).value = "'" & totalC & "/" & FHB_globalEgg_Count_Denominator(outKey)
        End If

     c = c + 1
Next cIdx

End Sub

Sub ET09_LB_Counts_Denominator()

    Dim wsPivot As Worksheet
    Dim wsSummary As Worksheet
    Dim pt As pivotTable
    Dim lastCol As Long, lastRow As Long
    Dim methodRow As Long, clinicRow As Long
    Dim yearCol As Long
    Dim totalRow As Long
    Dim colLabel1 As String, colLabel2 As String
    Dim prevLabel1 As String
    Dim value As Variant
    Dim c As Long, r As Long
    Dim totalSum As Double
    Dim currentRowOffset As Long
    Dim yearmonth As Variant, year As Variant, month As Variant
    Dim cell As Range
    Dim methodName As Variant
    Dim baseCol As Long, baseMethodCol As Long
    Dim currentYear As Variant
    Dim yearList As Collection
    Dim yearArray() As Variant
    Dim i As Long, j As Long, tmp As Variant
    Dim yearExists As Boolean
    Dim hospitalMap As Object
    Dim sortedHospitals As Variant
    Dim hospitalName As Variant
    Dim clinicID As String
    Dim hospitalIndex As Long
       
       
    Set LB_globalEgg_Count_Denominator = CreateObject("Scripting.Dictionary")
       

    ' ピボットシートと出力先シートの設定
    Set wsPivot = ThisWorkbook.Sheets("S13_母数_出生率")
    Set wsSummary = ThisWorkbook.Sheets("移植サマリー")
    Set pt = wsPivot.PivotTables("P13_母数_出生率")

    ' ピボットの行・列情報を取得
    yearCol = pt.TableRange2.Column

    ETmethodRow = pt.RowRange.row - 1
    clinicRow = pt.RowRange.row
    rowYear = pt.RowRange.row + 1
    Dim dataStartRow As Long: dataStartRow = rowYear ' データ本体の開始行

    lastCol = pt.TableRange2.Columns.count + pt.TableRange2.Column - 1
    lastRow = pt.TableRange2.Rows.count + pt.TableRange2.row - 1
    totalRow = lastRow
    
    ' 年度リストを作成
    yearArray = GetSortedYearsFromPivot()

    ' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
    Dim yearDict As Object
    Set yearDict = CreateObject("Scripting.Dictionary")

    For i = UBound(yearArray) To LBound(yearArray) Step -1
        If Not yearDict.Exists(yearArray(i)) Then
            yearDict.Add yearArray(i), True
        End If
    Next i


'    ' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
'Dim yearDict As Object
'Set yearDict = CreateObject("Scripting.Dictionary")
'
'' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
'On Error Resume Next
'For Each cell In wsPivot.Range(wsPivot.Cells(rowYear, yearCol), wsPivot.Cells(totalRow - 1, yearCol))
'    If cell.IndentLevel = 0 And IsNumeric(cell.value) Then
'        If Not yearDict.Exists(cell.value) Then
'            yearDict.Add cell.value, 1 ' 値をキーとして、値は任意（ここでは 1）
'        End If
'    End If
'Next cell
'On Error GoTo 0
'
'' 年度リストが空なら終了
'If yearDict.Count = 0 Then Exit Sub
'
'' Dictionary のキーを配列に変換して昇順にソート
'yearArray = yearDict.keys
'
'' ソート（昇順）
'Call QuickSort(yearArray, LBound(yearArray), UBound(yearArray))

'' ソート後の年を使用する場合
'For i = LBound(yearArray) To UBound(yearArray)
'    Debug.Print yearArray(i) ' 年度を表示
'Next i

    ' 院マップと識別番号でソートされた院名リストを取得
    Set hospitalMap = GetHospitalMap()
    sortedHospitals = SortKeysByValue(hospitalMap)

    ' データ列の開始列
    Dim firstDataCol As Long: firstDataCol = pt.TableRange2.Column
    
        ' データ集計
     ' 集計用ディクショナリ
    Dim ET_Count As Object
    Set ET_Count = CreateObject("Scripting.Dictionary")
    
    For r = dataStartRow To lastRow - 1 ' 最終行（総計）は除外
        yearmonth = wsPivot.Cells(r, firstDataCol).value
        If IsNumeric(yearmonth) Then
            year = yearmonth
        Else
            month = yearmonth
            yearMonthKey = year & "_" & month

            For c = firstDataCol To lastCol - 1 ' 最終列（総計）は除外
                If wsPivot.Cells(ETmethodRow, c).value <> "" Then prevMethod = Trim(wsPivot.Cells(ETmethodRow, c).value)
                method = prevMethod

                If wsPivot.Cells(clinicRow, c).value <> "" Then prevClinic = Trim(wsPivot.Cells(clinicRow, c).value)
                clinic = prevClinic

                value = wsPivot.Cells(r, c).value

                If method <> "" And clinic <> "" And IsNumeric(value) Then
                    Dim uniqueKey As String
                    
                    uniqueKey = Format(clinic, "00") & "_" & method & "_" & yearMonthKey

                    If Not ET_Count.Exists(uniqueKey) Then
                        ET_Count.Add uniqueKey, value
                    Else
                        ET_Count(uniqueKey) = ET_Count(uniqueKey) + value
                    End If
                End If
            Next c
        End If
    Next r


    ' === 院識別番号一覧を抽出 ===
    Dim clinicList As Object
    Set clinicList = CreateObject("Scripting.Dictionary")
    
For i = LBound(sortedHospitals) To UBound(sortedHospitals)
    Dim code As String
    code = Format(i + 1, "00")  ' "01", "02", ...
    
    If Not clinicList.Exists(code) Then
        clinicList.Add code, True
    End If
Next i



' === 各年度 × 院別 × 移植方法の合算値を出力（補正あり＆なし）===
Dim yearClinicSumDict As Object
Set yearClinicSumDict = CreateObject("Scripting.Dictionary")

Dim methodList As Variant
methodList = Array("1BT", "2BT", "2StepET", "1分割胚", "2分割胚", "1想定外STAGE", "2想定外STAGE", "混在：1想定外 + 他")

' 集計：分類ごとに件数を格納
For Each method In methodList
    For Each k In ET_Count.keys
'        If InStr(k, method) > 0 Then
            parts = Split(k, "_")
            If UBound(parts) >= 3 Then
             If parts(1) = method Then
                gClinic = parts(0)
                localYear = parts(2)
                
                If yearDict.Exists(localYear) And clinicList.Exists(gClinic) Then
                    yckey = localYear & "_" & Format(gClinic, "00") & "_" & method
                    If yearClinicSumDict.Exists(yckey) Then
                        yearClinicSumDict(yckey) = yearClinicSumDict(yckey) + ET_Count(k)
                    Else
                        yearClinicSumDict.Add yckey, ET_Count(k)
                    End If
                End If
            End If
        End If
    Next k
Next method


' === 出力設定 ===
Dim methodMap As Object
Set methodMap = CreateObject("Scripting.Dictionary")
methodMap.Add "1BT", Array(1, False)
methodMap.Add "2BT", Array(2, True)
methodMap.Add "2StepET", Array(3, True)
methodMap.Add "1+2分割胚", Array(4, "mixed")
methodMap.Add "1想定外STAGE", Array(5, False)
methodMap.Add "2想定外STAGE", Array(6, True)
methodMap.Add "混在：1想定外 + 他", Array(7, True)

' 年度を新しい順に並び替え
' 年度を昇順にソート
Call QuickSort(yearArray, LBound(yearArray), UBound(yearArray))

' ソート後、逆順に入れ替え（新しい年度順）
Dim sortedYears() As Variant
Dim n As Long

n = UBound(yearArray) - LBound(yearArray) + 1
ReDim sortedYears(0 To n - 1)

For i = 0 To n - 1
    sortedYears(i) = yearArray(UBound(yearArray) - i)
Next i

' === 出力処理 ===
Dim yearIndex As Long, clinicIndex As Long
For yearIndex = LBound(sortedYears) To UBound(sortedYears)
    Dim yearItem As Variant: yearItem = sortedYears(yearIndex)
    Dim rowBase As Long: rowBase = 17 + yearIndex * 9

    clinicIndex = 0
    For Each clinicItem In clinicList.keys
        Dim clinicCode As String: clinicCode = Format(clinicItem, "00")
        Dim colStart As Long: colStart = 12 + clinicIndex * 8 ' M列スタート

        Dim totalWithCorrection As Double: totalWithCorrection = 0
        Dim totalNoCorrection As Double: totalNoCorrection = 0

        ' 分類ごとに出力
        For Each method In methodMap.keys
            Dim offset As Long: offset = methodMap(method)(0)
            Dim applyCorrection As Variant: applyCorrection = methodMap(method)(1)

            Dim valueWithCorrection As Double: valueWithCorrection = 0
            Dim valueRaw As Double: valueRaw = 0

            If method = "1+2分割胚" Then
                Dim v1 As Double: v1 = 0
                Dim v2 As Double: v2 = 0
                If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "1分割胚") Then
                    v1 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "1分割胚")
                End If
                If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "2分割胚") Then
                    v2 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "2分割胚")
                End If
                valueWithCorrection = v1 + v2 / 2
                valueRaw = v1 + v2
            Else
                Dim key As String: key = yearItem & "_" & clinicCode & "_" & method
                If yearClinicSumDict.Exists(key) Then
                    valueRaw = yearClinicSumDict(key)
                    valueWithCorrection = IIf(applyCorrection = True, valueRaw / 2, valueRaw)
                End If
            End If
            
            Dim outKey As String: outKey = yearItem & "_" & Format(clinicItem, "00") & "_" & method

' 出力時に分岐
If method <> "1想定外STAGE" And method <> "2想定外STAGE" And method <> "混在：1想定外 + 他" Then

            ' 出力（補正あり（件数）：上段、補正なし（卵数）：下段）
'            wsSummary.Cells(rowBase, colStart + offset).value = valueWithCorrection
'            wsSummary.Cells(rowBase + 1, colStart + offset).value = valueRaw
            
             ' グローバル変数に格納
'             hCG_globalET_Count_Denominator(outKey) = valueWithCorrection
             LB_globalEgg_Count_Denominator(outKey) = valueRaw
             
            End If

            ' === 総合値（補正あり）の加算 ===
totalWithCorrection = totalWithCorrection + valueWithCorrection

' === 総合値（補正なし）の加算 ===
totalNoCorrection = totalNoCorrection + valueRaw

        Next method

        ' 総合値（0列目）
'        wsSummary.Cells(rowBase, colStart).value = totalWithCorrection
'        wsSummary.Cells(rowBase + 1, colStart).value = totalNoCorrection
        
        ' グローバル変数に格納
        outKey = yearItem & "_" & Format(clinicItem, "00") & "_All"
'             hCG_globalET_Count_Denominator(outKey) = totalWithCorrection
             LB_globalEgg_Count_Denominator(outKey) = totalNoCorrection
             
                     ' --- 想定外系合計の出力 ---
        Dim unexpected1 As Double, unexpected2 As Double, mixed As Double
        unexpected1 = 0: unexpected2 = 0: mixed = 0

        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "1想定外STAGE") Then
            unexpected1 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "1想定外STAGE")
        End If
        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "2想定外STAGE") Then
            unexpected2 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "2想定外STAGE")
        End If
        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "混在：1想定外 + 他") Then
            mixed = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "混在：1想定外 + 他")
        End If

        Dim valueWithCorrectionU As Double, valueRawU As Double
        valueWithCorrectionU = unexpected1 + unexpected2 / 2 + mixed / 2
        valueRawU = unexpected1 + unexpected2 + mixed

        ' 分割胚(列番号8)の2列隣 = offset 10
'        wsSummary.Cells(rowBase, colStart + 10).value = valueWithCorrectionU
'        wsSummary.Cells(rowBase + 1, colStart + 10).value = valueRawU
        
         ' グローバル変数に格納
        outKey = yearItem & "_" & Format(clinicItem, "00") & "_unexpected"
        LB_globalEgg_Count_Denominator(outKey) = valueRawU


        clinicIndex = clinicIndex + 1
    Next clinicItem
Next yearIndex


'' === 全期間 × ET方法ごとの合計値を記録・出力 ===

Dim totalRaw As Object: Set totalRaw = CreateObject("Scripting.Dictionary")
Dim totalCorrected As Object: Set totalCorrected = CreateObject("Scripting.Dictionary")

' 出力対象（E列?）→ 見せたい分類のみ
Dim outputMethods As Variant
outputMethods = Array("1BT", "2BT", "2StepET", "分割胚")

'' 全体集計対象（D列：総合に含める分類すべて）
'Dim allMethods As Variant
'allMethods = Array("1BT", "2BT", "2StepET", "1分割胚", "2分割胚", "1想定外STAGE", "2想定外STAGE", "混在：1想定外 + 他")

' 2で割る分類
Dim correctHalfList As Variant
correctHalfList = Array("2BT", "2StepET", "2分割胚", "2想定外STAGE", "混在：1想定外 + 他")

Dim raw As Double, corrected As Double

' === 件数集計（全分類） ===
For Each method In methodList
    raw = 0
    For Each k In ET_Count.keys
        If InStr(k, method) > 0 Then raw = raw + ET_Count(k)
    Next k
    totalRaw(method) = raw
    If Not IsError(Application.Match(method, correctHalfList, 0)) Then
        totalCorrected(method) = raw / 2
    Else
        totalCorrected(method) = raw
    End If
Next method

' === 総合（補正あり／なし） ===
Dim sumRaw As Double: sumRaw = 0
Dim sumCorrected As Double: sumCorrected = 0
For Each method In methodList
    sumRaw = sumRaw + totalRaw(method)
    sumCorrected = sumCorrected + totalCorrected(method)
Next method

' === 出力処理 ===
Dim ws As Worksheet: Set ws = wsSummary
Dim baseRow As Long: baseRow = 8
 baseCol = 4  ' D列

' 総合値をD列へ出力
'ws.Cells(baseRow, baseCol).value = sumCorrected
'ws.Cells(baseRow + 1, baseCol).value = sumRaw

        ' グローバル変数に格納
        outKey = "AllClinic" & "_Allmethod"
'        hCG_globalET_Count_Denominator(outKey) = sumCorrected
        LB_globalEgg_Count_Denominator(outKey) = sumRaw


' 出力対象のみを右に並べて出力（E列-）
For i = 0 To UBound(outputMethods)
    method = outputMethods(i)
    If method = "分割胚" Then
'        ws.Cells(baseRow, baseCol + 1 + i).value = totalCorrected("1分割胚") + totalCorrected("2分割胚")
'        ws.Cells(baseRow + 1, baseCol + 1 + i).value = totalRaw("1分割胚") + totalRaw("2分割胚")
        
         ' グローバル変数に格納
        outKey = "AllClinic" & "_" & method
'        hCG_globalET_Count_Denominator(outKey) = totalCorrected("1分割胚") + totalCorrected("2分割胚")
        LB_globalEgg_Count_Denominator(outKey) = totalRaw("1分割胚") + totalRaw("2分割胚")
        
    Else
'        ws.Cells(baseRow, baseCol + 1 + i).value = totalCorrected(method)
'        ws.Cells(baseRow + 1, baseCol + 1 + i).value = totalRaw(method)
        
        ' グローバル変数に格納
        outKey = "AllClinic" & "_" & method
'        hCG_globalET_Count_Denominator(outKey) = totalCorrected(method)
        LB_globalEgg_Count_Denominator(outKey) = totalRaw(method)

    
    End If
Next i

' === 想定外合算の出力 ===
unexpected1 = 0: unexpected2 = 0: mixed = 0

If totalRaw.Exists("1想定外STAGE") Then unexpected1 = totalRaw("1想定外STAGE")
If totalRaw.Exists("2想定外STAGE") Then unexpected2 = totalRaw("2想定外STAGE")
If totalRaw.Exists("混在：1想定外 + 他") Then mixed = totalRaw("混在：1想定外 + 他")

valueWithCorrectionU = 0
valueRawU = 0

valueWithCorrectionU = unexpected1 + unexpected2 / 2 + mixed / 2
valueRawU = unexpected1 + unexpected2 + mixed

'' 分割胚（=baseCol + 6）の2列右 → baseCol + 8
'ws.Cells(baseRow, baseCol + 10).value = valueWithCorrectionU
'ws.Cells(baseRow + 1, baseCol + 10).value = valueRawU

        ' グローバル変数に格納
        outKey = "AllClinic" & "_" & "unexpected"
        LB_globalEgg_Count_Denominator(outKey) = valueRawU


'' === 各年度 × ET方法ごとの合計値を記録 ===

 baseRow = 17
 baseCol = 4

For i = 0 To UBound(yearArray)
    year = yearArray(i)

    Dim countDict As Object: Set countDict = CreateObject("Scripting.Dictionary")
    Dim eggDict As Object: Set eggDict = CreateObject("Scripting.Dictionary")
    Dim ET_Eggs As Object: Set ET_Eggs = CreateObject("Scripting.Dictionary")
    Dim keys: keys = Array("All", "1BT", "2BT", "2StepET", "Cleavage")
    For Each k In keys: countDict(k) = 0: eggDict(k) = 0: Next

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 3 And parts(2) = year Then
            For Each m In methodList
                If InStr(k, m) > 0 Then
                    Dim cnt As Double: cnt = ET_Count(k)
                    Dim egg As Double: egg = cnt
                    Dim half As Boolean: half = Not IsError(Application.Match(m, correctHalfList, 0))

                    ' All
                    countDict("All") = countDict("All") + IIf(half, cnt / 2, cnt)
                    eggDict("All") = eggDict("All") + egg

                    ' 個別
                    If m = "1BT" Then countDict("1BT") = countDict("1BT") + cnt: eggDict("1BT") = eggDict("1BT") + egg
                    If m = "2BT" Then countDict("2BT") = countDict("2BT") + cnt / 2: eggDict("2BT") = eggDict("2BT") + egg
                    If m = "2StepET" Then countDict("2StepET") = countDict("2StepET") + cnt / 2: eggDict("2StepET") = eggDict("2StepET") + egg
                    If m = "1分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt: eggDict("Cleavage") = eggDict("Cleavage") + egg
                    If m = "2分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt / 2: eggDict("Cleavage") = eggDict("Cleavage") + egg
                End If
            Next
        End If
    Next

    ' 出力（9行ごと）
 r = baseRow + i * 9
    For j = 0 To 4
'        ws.Cells(r, baseCol + j).value = countDict(keys(j))
'        ws.Cells(r + 1, baseCol + j).value = eggDict(keys(j))
        
        ' グローバル変数に格納
        outKey = year & "_" & "AllClinic" & keys(j)
'        hCG_globalET_Count_Denominator(outKey) = countDict(keys(j))
        LB_globalEgg_Count_Denominator(outKey) = eggDict(keys(j))

    Next j
    
                    ' === 想定外3分類の合算出力 ===
    unexp1 = 0
    unexp2 = 0
    mixed = 0

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 2 Then
           method = parts(1)
            Dim ym As String: ym = parts(2)
            If Left(ym, 4) = year Then
                Select Case method
                    Case "1想定外STAGE": unexp1 = unexp1 + ET_Count(k)
                    Case "2想定外STAGE": unexp2 = unexp2 + ET_Count(k)
                    Case "混在：1想定外 + 他": mixed = mixed + ET_Count(k)
                End Select
            End If
        End If
    Next

    totalC = unexp1 + unexp2 / 2 + mixed / 2
    totalR = unexp1 + unexp2 + mixed

'    ws.Cells(r, baseCol + 10).value = totalC
'    ws.Cells(r + 1, baseCol + 10).value = totalR
    
         ' グローバル変数に格納
        outKey = year & "_" & "AllClinic" & "_unexp"
        LB_globalEgg_Count_Denominator(outKey) = totalR
    
Next i

'全期間×各院

Dim lastYear As String
lastYear = yearArray(UBound(yearArray)) - 1  ' 前年度

Dim cIdx As Variant
 baseRow = 8   ' 件数：L7（行7）
 baseCol = 12  ' 列L（12）
 
c = 0

For Each cIdx In clinicList.keys
    clinic = cIdx

     Set countDict = CreateObject("Scripting.Dictionary")
    Set eggDict = CreateObject("Scripting.Dictionary")
    Dim etType As Variant
    For Each etType In keys: countDict(etType) = 0: eggDict(etType) = 0: Next

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 3 Then
            year = parts(2)
            If parts(0) = clinic Then
                For Each m In methodList
                    If InStr(k, m) > 0 Then
                        cnt = ET_Count(k)
                        egg = cnt  ' 卵数は補正なし
                         half = Not IsError(Application.Match(m, correctHalfList, 0))

                        ' All
                        countDict("All") = countDict("All") + IIf(half, cnt / 2, cnt)
                        eggDict("All") = eggDict("All") + egg

                        ' 個別
                        If m = "1BT" Then countDict("1BT") = countDict("1BT") + cnt: eggDict("1BT") = eggDict("1BT") + egg
                        If m = "2BT" Then countDict("2BT") = countDict("2BT") + cnt / 2: eggDict("2BT") = eggDict("2BT") + egg
                        If m = "2StepET" Then countDict("2StepET") = countDict("2StepET") + cnt / 2: eggDict("2StepET") = eggDict("2StepET") + egg
                        If m = "1分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt: eggDict("Cleavage") = eggDict("Cleavage") + egg
                        If m = "2分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt / 2: eggDict("Cleavage") = eggDict("Cleavage") + egg
                    End If
                Next
            End If
        End If
    Next

    ' 出力（8列おきに右へ）
    Dim colOffset As Long: colOffset = baseCol + c * 8
    For j = 0 To 4
'        ws.Cells(baseRow, colOffset + j).value = countDict(keys(j))      ' 件数
'        ws.Cells(baseRow + 1, colOffset + j).value = eggDict(keys(j))    ' 卵数（1行下）
        
        ' グローバル変数に格納
        outKey = Format(clinic, "00") & "_" & keys(j)
'        hCG_globalET_Count_Denominator(outKey) = countDict(keys(j))
        LB_globalEgg_Count_Denominator(outKey) = eggDict(keys(j))
        
    Next j
    
               ' === 想定外3分類の合算（クリニック単位・全期間） ===
    unexp1 = 0
    unexp2 = 0
    mixed = 0

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 2 Then
            Dim cl As String: cl = parts(0)
            method = parts(1)

            If cl = clinic Then
                Select Case method
                    Case "1想定外STAGE": unexp1 = unexp1 + ET_Count(k)
                    Case "2想定外STAGE": unexp2 = unexp2 + ET_Count(k)
                    Case "混在：1想定外 + 他": mixed = mixed + ET_Count(k)
                End Select
            End If
        End If
    Next

    totalC = unexp1 + unexp2 / 2 + mixed / 2
    totalR = unexp1 + unexp2 + mixed
    
    ' グローバル変数に格納
    outKey = Format(clinic, "00") & "_" & "unexp"
    LB_globalEgg_Count_Denominator(outKey) = totalR

     c = c + 1
Next cIdx

End Sub

Sub ET10_LB_Counts()

    Dim wsPivot As Worksheet
    Dim wsSummary As Worksheet
    Dim pt As pivotTable
    Dim lastCol As Long, lastRow As Long
    Dim methodRow As Long, clinicRow As Long
    Dim yearCol As Long
    Dim totalRow As Long
    Dim colLabel1 As String, colLabel2 As String
    Dim prevLabel1 As String
    Dim value As Variant
    Dim c As Long, r As Long
    Dim totalSum As Double
    Dim currentRowOffset As Long
    Dim yearmonth As Variant, year As Variant, month As Variant
    Dim cell As Range
    Dim methodName As Variant
    Dim baseCol As Long, baseMethodCol As Long
    Dim currentYear As Variant
    Dim yearList As Collection
    Dim yearArray() As Variant
    Dim i As Long, j As Long, tmp As Variant
    Dim yearExists As Boolean
    Dim hospitalMap As Object
    Dim sortedHospitals As Variant
    Dim hospitalName As Variant
    Dim clinicID As String
    Dim hospitalIndex As Long
    
    
    ' ピボットシートと出力先シートの設定
    Set wsPivot = ThisWorkbook.Sheets("S14_出生率")
    Set wsSummary = ThisWorkbook.Sheets("移植サマリー")
    Set pt = wsPivot.PivotTables("P14_出生率")

    ' ピボットの行・列情報を取得
    yearCol = pt.TableRange2.Column

    ETmethodRow = pt.RowRange.row - 1
    clinicRow = pt.RowRange.row
    rowYear = pt.RowRange.row + 1
    Dim dataStartRow As Long: dataStartRow = rowYear ' データ本体の開始行

    lastCol = pt.TableRange2.Columns.count + pt.TableRange2.Column - 1
    lastRow = pt.TableRange2.Rows.count + pt.TableRange2.row - 1
    totalRow = lastRow
    
         ' 年度リストを作成
    yearArray = GetSortedYearsFromPivot()

    ' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
    Dim yearDict As Object
    Set yearDict = CreateObject("Scripting.Dictionary")

    For i = UBound(yearArray) To LBound(yearArray) Step -1
        If Not yearDict.Exists(yearArray(i)) Then
            yearDict.Add yearArray(i), True
        End If
    Next i


'    ' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
'Dim yearDict As Object
'Set yearDict = CreateObject("Scripting.Dictionary")
'
'' 年度リストを作成（IndentLevel = 0 のセルのみ追加）
'On Error Resume Next
'For Each cell In wsPivot.Range(wsPivot.Cells(rowYear, yearCol), wsPivot.Cells(totalRow - 1, yearCol))
'    If cell.IndentLevel = 0 And IsNumeric(cell.value) Then
'        If Not yearDict.Exists(cell.value) Then
'            yearDict.Add cell.value, 1 ' 値をキーとして、値は任意（ここでは 1）
'        End If
'    End If
'Next cell
'On Error GoTo 0
'
'' 年度リストが空なら終了
'If yearDict.Count = 0 Then Exit Sub
'
'' Dictionary のキーを配列に変換して昇順にソート
'yearArray = yearDict.keys
'
'' ソート（昇順）
'Call QuickSort(yearArray, LBound(yearArray), UBound(yearArray))

'' ソート後の年を使用する場合
'For i = LBound(yearArray) To UBound(yearArray)
'    Debug.Print yearArray(i) ' 年度を表示
'Next i

    ' 院マップと識別番号でソートされた院名リストを取得
    Set hospitalMap = GetHospitalMap()
    sortedHospitals = SortKeysByValue(hospitalMap)

    ' データ列の開始列
    Dim firstDataCol As Long: firstDataCol = pt.TableRange2.Column
    
        ' データ集計
     ' 集計用ディクショナリ
    Dim ET_Count As Object
    Set ET_Count = CreateObject("Scripting.Dictionary")
    
    For r = dataStartRow To lastRow - 1 ' 最終行（総計）は除外
        yearmonth = wsPivot.Cells(r, firstDataCol).value
        If IsNumeric(yearmonth) Then
            year = yearmonth
        Else
            month = yearmonth
            yearMonthKey = year & "_" & month

            For c = firstDataCol To lastCol - 1 ' 最終列（総計）は除外
                If wsPivot.Cells(ETmethodRow, c).value <> "" Then prevMethod = Trim(wsPivot.Cells(ETmethodRow, c).value)
                method = prevMethod

                If wsPivot.Cells(clinicRow, c).value <> "" Then prevClinic = Trim(wsPivot.Cells(clinicRow, c).value)
                clinic = prevClinic

                value = wsPivot.Cells(r, c).value

                If method <> "" And clinic <> "" And IsNumeric(value) Then
                    Dim uniqueKey As String
                    
                    uniqueKey = Format(clinic, "00") & "_" & method & "_" & yearMonthKey

                    If Not ET_Count.Exists(uniqueKey) Then
                        ET_Count.Add uniqueKey, value
                    Else
                        ET_Count(uniqueKey) = ET_Count(uniqueKey) + value
                    End If
                End If
            Next c
        End If
    Next r


    ' === 院識別番号一覧をET_Count から自動抽出 ===
    Dim clinicList As Object
    Set clinicList = CreateObject("Scripting.Dictionary")
    
For i = LBound(sortedHospitals) To UBound(sortedHospitals)
    Dim code As String
    code = Format(i + 1, "00")  ' "01", "02", ...
    
    If Not clinicList.Exists(code) Then
        clinicList.Add code, True
    End If
Next i


' === 各年度 × 院別 × 移植方法の合算値を出力（補正あり＆なし）===
Dim yearClinicSumDict As Object
Set yearClinicSumDict = CreateObject("Scripting.Dictionary")

Dim methodList As Variant
methodList = Array("1BT", "2BT", "2StepET", "1分割胚", "2分割胚", "1想定外STAGE", "2想定外STAGE", "混在：1想定外 + 他")

' 集計：分類ごとに件数を格納
For Each method In methodList
    For Each k In ET_Count.keys
'        If InStr(k, method) > 0 Then
            parts = Split(k, "_")
            If UBound(parts) >= 3 Then
             If parts(1) = method Then
                gClinic = parts(0)
                localYear = parts(2)
                
                If yearDict.Exists(localYear) And clinicList.Exists(gClinic) Then
                    yckey = localYear & "_" & Format(gClinic, "00") & "_" & method
                    If yearClinicSumDict.Exists(yckey) Then
                        yearClinicSumDict(yckey) = yearClinicSumDict(yckey) + ET_Count(k)
                    Else
                        yearClinicSumDict.Add yckey, ET_Count(k)
                    End If
                End If
            End If
        End If
    Next k
Next method


' === 出力設定 ===
Dim methodMap As Object
Set methodMap = CreateObject("Scripting.Dictionary")
methodMap.Add "1BT", Array(1, False)
methodMap.Add "2BT", Array(2, True)
methodMap.Add "2StepET", Array(3, True)
methodMap.Add "1+2分割胚", Array(4, "mixed")
methodMap.Add "1想定外STAGE", Array(5, False)
methodMap.Add "2想定外STAGE", Array(6, True)
methodMap.Add "混在：1想定外 + 他", Array(7, True)

' 年度を新しい順に並び替え
' 年度を昇順にソート
Call QuickSort(yearArray, LBound(yearArray), UBound(yearArray))

' ソート後、逆順に入れ替え（新しい年度順）
Dim sortedYears() As Variant
Dim n As Long

n = UBound(yearArray) - LBound(yearArray) + 1
ReDim sortedYears(0 To n - 1)

For i = 0 To n - 1
    sortedYears(i) = yearArray(UBound(yearArray) - i)
Next i

' === 出力処理 ===
Dim yearIndex As Long, clinicIndex As Long
For yearIndex = LBound(sortedYears) To UBound(sortedYears)
    Dim yearItem As Variant: yearItem = sortedYears(yearIndex)
    Dim rowBase As Long: rowBase = 21 + yearIndex * 9

    clinicIndex = 0
    For Each clinicItem In clinicList.keys
        Dim clinicCode As String: clinicCode = Format(clinicItem, "00")
        Dim colStart As Long: colStart = 19 + clinicIndex * 15 ' M列スタート

        Dim totalWithCorrection As Double: totalWithCorrection = 0
        Dim totalNoCorrection As Double: totalNoCorrection = 0

        ' 分類ごとに出力
        For Each method In methodMap.keys
            Dim offset As Long: offset = methodMap(method)(0)
            Dim applyCorrection As Variant: applyCorrection = methodMap(method)(1)

            Dim valueWithCorrection As Double: valueWithCorrection = 0
            Dim valueRaw As Double: valueRaw = 0

            If method = "1+2分割胚" Then
                Dim v1 As Double: v1 = 0
                Dim v2 As Double: v2 = 0
                If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "1分割胚") Then
                    v1 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "1分割胚")
                End If
                If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "2分割胚") Then
                    v2 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "2分割胚")
                End If
                valueWithCorrection = v1 + v2 / 2
                valueRaw = v1 + v2
            Else
                Dim key As String: key = yearItem & "_" & clinicCode & "_" & method
                If yearClinicSumDict.Exists(key) Then
                    valueRaw = yearClinicSumDict(key)
                    valueWithCorrection = IIf(applyCorrection = True, valueRaw / 2, valueRaw)
                End If
            End If
            
            Dim outKey As String: outKey = yearItem & "_" & Format(clinicItem, "00") & "_" & method

' 出力時に分岐
If method <> "1想定外STAGE" And method <> "2想定外STAGE" And method <> "混在：1想定外 + 他" Then
                
    If valueWithCorrection <> 0 And LB_globalEgg_Count_Denominator(outKey) <> 0 Then

            ' 出力（補正あり（件数）：上段、補正なし（卵数）：下段）
            wsSummary.Cells(rowBase, colStart + offset * 2).NumberFormat = "0.0"
            wsSummary.Cells(rowBase, colStart + offset * 2).value = Round(valueWithCorrection / LB_globalEgg_Count_Denominator(outKey) * 100, 1)
            wsSummary.Cells(rowBase, colStart + offset * 2 + 1).value = "'" & valueWithCorrection & "/" & LB_globalEgg_Count_Denominator(outKey)
'            wsSummary.Cells(rowBase + 1, colStart + offset).value = valueRaw

                    Else
                    wsSummary.Cells(rowBase, colStart + offset * 2).NumberFormat = "0.0"
                    wsSummary.Cells(rowBase, colStart + offset * 2).value = 0
                    wsSummary.Cells(rowBase, colStart + offset * 2 + 1).value = "'" & valueWithCorrection & "/" & LB_globalEgg_Count_Denominator(outKey)

                End If
             
            End If

            ' === 総合値（補正あり）の加算 ===
totalWithCorrection = totalWithCorrection + valueWithCorrection

' === 総合値（補正なし）の加算 ===
totalNoCorrection = totalNoCorrection + valueRaw

        Next method
        
        outKey = yearItem & "_" & Format(clinicItem, "00") & "_All"
        
        If totalWithCorrection <> 0 And LB_globalEgg_Count_Denominator(outKey) <> 0 Then

        ' 総合値（0列目）
        wsSummary.Cells(rowBase, colStart).NumberFormat = "0.0"
        wsSummary.Cells(rowBase, colStart).value = Round(totalWithCorrection / LB_globalEgg_Count_Denominator(outKey) * 100, 1)
        wsSummary.Cells(rowBase, colStart + 1).value = "'" & totalWithCorrection & "/" & LB_globalEgg_Count_Denominator(outKey)
'        wsSummary.Cells(rowBase + 1, colStart).value = totalNoCorrection

        Else
          wsSummary.Cells(rowBase, colStart).NumberFormat = "0.0"
          wsSummary.Cells(rowBase, colStart).value = 0
          wsSummary.Cells(rowBase, colStart + 1).value = "'" & totalWithCorrection & "/" & LB_globalEgg_Count_Denominator(outKey)

        End If
        
                                         ' --- 想定外系合計の出力 ---
        Dim unexpected1 As Double, unexpected2 As Double, mixed As Double
        unexpected1 = 0: unexpected2 = 0: mixed = 0

        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "1想定外STAGE") Then
            unexpected1 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "1想定外STAGE")
        End If
        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "2想定外STAGE") Then
            unexpected2 = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "2想定外STAGE")
        End If
        If yearClinicSumDict.Exists(yearItem & "_" & clinicCode & "_" & "混在：1想定外 + 他") Then
            mixed = yearClinicSumDict(yearItem & "_" & clinicCode & "_" & "混在：1想定外 + 他")
        End If

        Dim valueWithCorrectionU As Double, valueRawU As Double
        valueWithCorrectionU = unexpected1 + unexpected2 / 2 + mixed / 2
        valueRawU = unexpected1 + unexpected2 + mixed

        outKey = yearItem & "_" & Format(clinicItem, "00") & "_unexpected"
        
        If valueWithCorrectionU <> 0 And LB_globalEgg_Count_Denominator(outKey) <> 0 Then

'         分割胚(列番号8)の2列隣 = offset 10
        wsSummary.Cells(rowBase, colStart + 10).NumberFormat = "0.0"
        wsSummary.Cells(rowBase, colStart + 10).value = Round(valueWithCorrectionU / LB_globalEgg_Count_Denominator(outKey) * 100, 1)
        wsSummary.Cells(rowBase, colStart + 11).value = "'" & valueWithCorrectionU & "/" & LB_globalEgg_Count_Denominator(outKey)

        Else
          wsSummary.Cells(rowBase, colStart + 10).NumberFormat = "0.0"
          wsSummary.Cells(rowBase, colStart + 10).value = 0
          wsSummary.Cells(rowBase, colStart + 11).value = "'" & valueWithCorrectionU & "/" & LB_globalEgg_Count_Denominator(outKey)
        End If

        clinicIndex = clinicIndex + 1
    Next clinicItem
Next yearIndex


'' === 全期間 × ET方法ごとの合計値を記録・出力 ===

Dim totalRaw As Object: Set totalRaw = CreateObject("Scripting.Dictionary")
Dim totalCorrected As Object: Set totalCorrected = CreateObject("Scripting.Dictionary")

' 出力対象（E列?）→ 見せたい分類のみ
Dim outputMethods As Variant
outputMethods = Array("1BT", "2BT", "2StepET", "分割胚")

'' 全体集計対象（D列：総合に含める分類すべて）
'Dim allMethods As Variant
'allMethods = Array("1BT", "2BT", "2StepET", "1分割胚", "2分割胚", "1想定外STAGE", "2想定外STAGE", "混在：1想定外 + 他")

' 2で割る分類
Dim correctHalfList As Variant
correctHalfList = Array("2BT", "2StepET", "2分割胚", "2想定外STAGE", "混在：1想定外 + 他")

Dim raw As Double, corrected As Double

' === 件数集計（全分類） ===
For Each method In methodList
    raw = 0
    For Each k In ET_Count.keys
        If InStr(k, method) > 0 Then raw = raw + ET_Count(k)
    Next k
    totalRaw(method) = raw
    If Not IsError(Application.Match(method, correctHalfList, 0)) Then
        totalCorrected(method) = raw / 2
    Else
        totalCorrected(method) = raw
    End If
Next method

' === 総合（補正あり／なし） ===
Dim sumRaw As Double: sumRaw = 0
Dim sumCorrected As Double: sumCorrected = 0
For Each method In methodList
    sumRaw = sumRaw + totalRaw(method)
    sumCorrected = sumCorrected + totalCorrected(method)
Next method

' === 出力処理 ===
Dim ws As Worksheet: Set ws = wsSummary
Dim baseRow As Long: baseRow = 12
 baseCol = 4  ' D列

' 総合値をD列へ出力
outKey = "AllClinic" & "_Allmethod"

        If sumCorrected <> 0 And LB_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(baseRow, baseCol).NumberFormat = "0.0"
        ws.Cells(baseRow, baseCol).value = Round(sumCorrected / LB_globalEgg_Count_Denominator(outKey) * 100, 1)
        ws.Cells(baseRow, baseCol + 1).value = "'" & sumCorrected & "/" & LB_globalEgg_Count_Denominator(outKey)
        'ws.Cells(baseRow + 1, baseCol).value = sumRaw

        Else
          wsSummary.Cells(baseRow, baseCol).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, baseCol).value = 0
          ws.Cells(baseRow, baseCol + 1).value = "'" & sumCorrected & "/" & LB_globalEgg_Count_Denominator(outKey)
        End If

'        ' グローバル変数に格納
'        outKey = "AllClinic" & "_Allmethod"
'        globalET_Count(outKey) = sumCorrected
'        globalEgg_Count(outKey) = sumRaw


' 出力対象のみを右に並べて出力（E列-）
For i = 0 To UBound(outputMethods)
    method = outputMethods(i)
    If method = "分割胚" Then
    
    Dim CountValue As Variant
    Dim EggValue As Variant
    
    outKey = "AllClinic" & "_" & method
    
        CountValue = totalCorrected("1分割胚") + totalCorrected("2分割胚")
        EggValue = totalRaw("1分割胚") + totalRaw("2分割胚")
        
        If CountValue <> 0 And LB_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(baseRow, baseCol + 2 + i * 2).NumberFormat = "0.0"
        ws.Cells(baseRow, baseCol + 2 + i * 2).value = Round(CountValue / LB_globalEgg_Count_Denominator(outKey) * 100, 1)
        ws.Cells(baseRow, baseCol + 3 + i * 2).value = "'" & CountValue & "/" & LB_globalEgg_Count_Denominator(outKey)
'        ws.Cells(baseRow + 1, baseCol + 1 + i).value = EggValue
        
        
         ' グローバル変数に格納
'        outKey = "AllClinic" & "_" & method
'        globalET_Count(outKey) = totalCorrected("1分割胚") + totalCorrected("2分割胚")
'        globalEgg_Count(outKey) = totalRaw("1分割胚") + totalRaw("2分割胚")
        
        Else
          wsSummary.Cells(baseRow, baseCol + 2 + i * 2).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, baseCol + 2 + i * 2).value = 0
          ws.Cells(baseRow, baseCol + 3 + i * 2).value = "'" & CountValue & "/" & LB_globalEgg_Count_Denominator(outKey)

        End If
        
    Else
        outKey = "AllClinic" & "_" & method
        
        If totalCorrected(method) <> 0 And LB_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(baseRow, baseCol + 2 + i * 2).NumberFormat = "0.0"
        ws.Cells(baseRow, baseCol + 2 + i * 2).value = Round(totalCorrected(method) / LB_globalEgg_Count_Denominator(outKey) * 100, 1)
        ws.Cells(baseRow, baseCol + 3 + i * 2).value = "'" & totalCorrected(method) & "/" & LB_globalEgg_Count_Denominator(outKey)
'        ws.Cells(baseRow + 1, baseCol + 1 + i).value = totalRaw(method)
        
        ' グローバル変数に格納
'        outKey = "AllClinic" & "_" & method
'        globalET_Count(outKey) = totalCorrected(method)
'        globalEgg_Count(outKey) = totalRaw(method)
        
        Else
          wsSummary.Cells(baseRow, baseCol + 2 + i * 2).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, baseCol + 2 + i * 2).value = 0
          ws.Cells(baseRow, baseCol + 3 + i * 2).value = "'" & totalCorrected(method) & "/" & LB_globalEgg_Count_Denominator(outKey)
        End If


    
    End If
Next i

' === 想定外合算の出力 ===
unexpected1 = 0: unexpected2 = 0: mixed = 0

If totalRaw.Exists("1想定外STAGE") Then unexpected1 = totalRaw("1想定外STAGE")
If totalRaw.Exists("2想定外STAGE") Then unexpected2 = totalRaw("2想定外STAGE")
If totalRaw.Exists("混在：1想定外 + 他") Then mixed = totalRaw("混在：1想定外 + 他")

valueWithCorrectionU = 0
valueRawU = 0

valueWithCorrectionU = unexpected1 + unexpected2 / 2 + mixed / 2
valueRawU = unexpected1 + unexpected2 + mixed

outKey = "AllClinic" & "_" & "unexpected"

If valueWithCorrectionU <> 0 And LB_globalEgg_Count_Denominator(outKey) <> 0 Then

'' 分割胚（=baseCol + 6）の2列右 → baseCol + 8
wsSummary.Cells(baseRow, baseCol + 10).NumberFormat = "0.0"
ws.Cells(baseRow, baseCol + 10).value = Round(valueWithCorrectionU / LB_globalEgg_Count_Denominator(outKey) * 100, 1)
wsSummary.Cells(baseRow, baseCol + 11).value = "'" & valueWithCorrectionU & "/" & LB_globalEgg_Count_Denominator(outKey)
        
        Else
          wsSummary.Cells(baseRow, baseCol + 10).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, baseCol + 10).value = 0
          wsSummary.Cells(baseRow, baseCol + 11).value = "'" & valueWithCorrectionU & "/" & LB_globalEgg_Count_Denominator(outKey)
        End If


'' === 各年度 × ET方法ごとの合計値を記録 ===

 baseRow = 21
 baseCol = 4

For i = 0 To UBound(sortedYears)
    year = sortedYears(i)

    Dim countDict As Object: Set countDict = CreateObject("Scripting.Dictionary")
    Dim eggDict As Object: Set eggDict = CreateObject("Scripting.Dictionary")
    Dim ET_Eggs As Object: Set ET_Eggs = CreateObject("Scripting.Dictionary")
    Dim keys: keys = Array("All", "1BT", "2BT", "2StepET", "Cleavage")
    For Each k In keys: countDict(k) = 0: eggDict(k) = 0: Next

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 3 And parts(2) = year Then
            For Each m In methodList
                If InStr(k, m) > 0 Then
                    Dim cnt As Double: cnt = ET_Count(k)
                    Dim egg As Double: egg = cnt
                    Dim half As Boolean: half = Not IsError(Application.Match(m, correctHalfList, 0))

                    ' All
                    countDict("All") = countDict("All") + IIf(half, cnt / 2, cnt)
                    eggDict("All") = eggDict("All") + egg

                    ' 個別
                    If m = "1BT" Then countDict("1BT") = countDict("1BT") + cnt: eggDict("1BT") = eggDict("1BT") + egg
                    If m = "2BT" Then countDict("2BT") = countDict("2BT") + cnt / 2: eggDict("2BT") = eggDict("2BT") + egg
                    If m = "2StepET" Then countDict("2StepET") = countDict("2StepET") + cnt / 2: eggDict("2StepET") = eggDict("2StepET") + egg
                    If m = "1分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt: eggDict("Cleavage") = eggDict("Cleavage") + egg
                    If m = "2分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt / 2: eggDict("Cleavage") = eggDict("Cleavage") + egg
                End If
            Next
        End If
    Next

    ' 出力（9行ごと）
 r = baseRow + i * 9
    For j = 0 To 4
        outKey = year & "_" & "AllClinic" & keys(j)
        
        If countDict(keys(j)) <> 0 And LB_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(r, baseCol + j * 2).NumberFormat = "0.0"
        ws.Cells(r, baseCol + j * 2).value = Round(countDict(keys(j)) / LB_globalEgg_Count_Denominator(outKey) * 100, 1)
        ws.Cells(r, baseCol + j * 2 + 1).value = "'" & countDict(keys(j)) & "/" & LB_globalEgg_Count_Denominator(outKey)
'        ws.Cells(r + 1, baseCol + j).value = eggDict(keys(j))
        
        ' グローバル変数に格納
'        outKey = year & "_" & "AllClinic" & keys(j)
'        globalET_Count(outKey) = countDict(keys(j))
'        globalEgg_Count(outKey) = eggDict(keys(j))

        Else
          wsSummary.Cells(r, baseCol + j * 2).NumberFormat = "0.0"
          wsSummary.Cells(r, baseCol + j * 2).value = 0
          ws.Cells(r, baseCol + j * 2 + 1).value = "'" & countDict(keys(j)) & "/" & LB_globalEgg_Count_Denominator(outKey)

        End If
    Next j
    
                        ' === 想定外3分類の合算出力 ===
    unexp1 = 0
    unexp2 = 0
    mixed = 0

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 2 Then
           method = parts(1)
            Dim ym As String: ym = parts(2)
            If Left(ym, 4) = year Then
                Select Case method
                    Case "1想定外STAGE": unexp1 = unexp1 + ET_Count(k)
                    Case "2想定外STAGE": unexp2 = unexp2 + ET_Count(k)
                    Case "混在：1想定外 + 他": mixed = mixed + ET_Count(k)
                End Select
            End If
        End If
    Next

    totalC = unexp1 + unexp2 / 2 + mixed / 2
    totalR = unexp1 + unexp2 + mixed
    
    outKey = year & "_" & "AllClinic" & "_unexp"
    
        If totalC <> 0 And FHB_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(r, baseCol + 10).NumberFormat = "0.0"
        ws.Cells(r, baseCol + 10).value = Round(totalC / LB_globalEgg_Count_Denominator(outKey) * 100, 1)
        ws.Cells(r, baseCol + 11).value = "'" & totalC & "/" & LB_globalEgg_Count_Denominator(outKey)
        

        Else
          wsSummary.Cells(r, baseCol + 10).NumberFormat = "0.0"
          wsSummary.Cells(r, baseCol + 10).value = 0
          wsSummary.Cells(r, baseCol + 11).value = "'" & totalC & "/" & LB_globalEgg_Count_Denominator(outKey)
        End If

Next i


'全期間×各院

'Dim lastYear As String
'lastYear = yearArray(UBound(yearArray)) - 1  ' 前年度

Dim cIdx As Variant
 baseRow = 12   ' 件数：L7（行7）
 baseCol = 19  ' 列L（12）
 
c = 0

For Each cIdx In clinicList.keys
    clinic = cIdx

     Set countDict = CreateObject("Scripting.Dictionary")
    Set eggDict = CreateObject("Scripting.Dictionary")
    Dim etType As Variant
    For Each etType In keys: countDict(etType) = 0: eggDict(etType) = 0: Next

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 3 Then
            year = parts(2)
            If parts(0) = clinic Then
                For Each m In methodList
                    If InStr(k, m) > 0 Then
                        cnt = ET_Count(k)
                        egg = cnt  ' 卵数は補正なし
                         half = Not IsError(Application.Match(m, correctHalfList, 0))

                        ' All
                        countDict("All") = countDict("All") + IIf(half, cnt / 2, cnt)
                        eggDict("All") = eggDict("All") + egg

                        ' 個別
                        If m = "1BT" Then countDict("1BT") = countDict("1BT") + cnt: eggDict("1BT") = eggDict("1BT") + egg
                        If m = "2BT" Then countDict("2BT") = countDict("2BT") + cnt / 2: eggDict("2BT") = eggDict("2BT") + egg
                        If m = "2StepET" Then countDict("2StepET") = countDict("2StepET") + cnt / 2: eggDict("2StepET") = eggDict("2StepET") + egg
                        If m = "1分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt: eggDict("Cleavage") = eggDict("Cleavage") + egg
                        If m = "2分割胚" Then countDict("Cleavage") = countDict("Cleavage") + cnt / 2: eggDict("Cleavage") = eggDict("Cleavage") + egg
                    End If
                Next
            End If
        End If
    Next

    ' 出力（8列おきに右へ）
    Dim colOffset As Long: colOffset = baseCol + c * 15
    For j = 0 To 4
        outKey = Format(clinic, "00") & "_" & keys(j)
        
        If eggDict(keys(j)) <> 0 And LB_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(baseRow, colOffset + j * 2).NumberFormat = "0.0"
        ws.Cells(baseRow, colOffset + j * 2).value = Round(countDict(keys(j)) / LB_globalEgg_Count_Denominator(outKey) * 100, 1)     ' 件数
        ws.Cells(baseRow, colOffset + j * 2 + 1).value = "'" & countDict(keys(j)) & "/" & LB_globalEgg_Count_Denominator(outKey)

'        ws.Cells(baseRow + 1, colOffset + j).value = eggDict(keys(j))    ' 卵数（1行下）
        
        ' グローバル変数に格納
'        outKey = Format(clinic, "00") & "_" & keys(j)
'        globalET_Count(outKey) = countDict(keys(j))
'        globalEgg_Count(outKey) = eggDict(keys(j))

        Else
          wsSummary.Cells(baseRow, colOffset + j * 2).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, colOffset + j * 2).value = 0
          ws.Cells(baseRow, colOffset + j * 2 + 1).value = "'" & countDict(keys(j)) & "/" & LB_globalEgg_Count_Denominator(outKey)

        End If
        
    Next j
    
                   ' === 想定外3分類の合算（クリニック単位・全期間） ===
    unexp1 = 0
    unexp2 = 0
    mixed = 0

    For Each k In ET_Count.keys
        parts = Split(k, "_")
        If UBound(parts) >= 2 Then
            Dim cl As String: cl = parts(0)
            method = parts(1)

            If cl = clinic Then
                Select Case method
                    Case "1想定外STAGE": unexp1 = unexp1 + ET_Count(k)
                    Case "2想定外STAGE": unexp2 = unexp2 + ET_Count(k)
                    Case "混在：1想定外 + 他": mixed = mixed + ET_Count(k)
                End Select
            End If
        End If
    Next

    totalC = unexp1 + unexp2 / 2 + mixed / 2
    totalR = unexp1 + unexp2 + mixed
    
         outKey = Format(clinic, "00") & "_" & "unexp"
    
        If totalC <> 0 And LB_globalEgg_Count_Denominator(outKey) <> 0 Then
        
        wsSummary.Cells(baseRow, colOffset + 10).NumberFormat = "0.0"
        ws.Cells(baseRow, colOffset + 10).value = Round(totalC / LB_globalEgg_Count_Denominator(outKey) * 100, 1)
        ws.Cells(baseRow, colOffset + 11).value = "'" & totalC & "/" & LB_globalEgg_Count_Denominator(outKey)
        

        Else
          wsSummary.Cells(baseRow, colOffset + 10).NumberFormat = "0.0"
          wsSummary.Cells(baseRow, colOffset + 10).value = 0
          wsSummary.Cells(baseRow, colOffset + 11).value = "'" & totalC & "/" & LB_globalEgg_Count_Denominator(outKey)
        End If
    
     c = c + 1
Next cIdx

End Sub

Function GetHospitalMap()
    ' GetHospitalMap 関数を呼び出す
    Set GetHospitalMap = M1_OPU_Summary.GetHospitalMap

End Function

' 院の識別番号で昇順に並べ替えた院名リストを返す関数
Function SortKeysByValue(dic As Object) As Variant
 SortKeysByValue = M1_OPU_Summary.SortKeysByValue(dic)
End Function

' クイックソート：配列内の年度を昇順に並べ替える
Sub QuickSort(arr As Variant, low As Long, high As Long)
      ' M1_OPU_Summary モジュール内の QuickSort を呼び出す
    M1_OPU_Summary.QuickSort arr, low, high
End Sub

' 移植を実施した年一（下り順）を取得する
Function GetSortedYearsFromPivot() As Variant

    Dim ws As Worksheet
    Dim pt As pivotTable
    Dim rng As Range
    Dim dict As Object
    Dim cell As Range
    Dim yearKeys As Variant
    Dim temp As Variant
    Dim x As Long, y As Long

    Set ws = ThisWorkbook.Sheets("S06_移植年日検索")
    Set pt = ws.PivotTables("P06_移植年日検索")
    Set rng = pt.RowRange

    Set dict = CreateObject("Scripting.Dictionary")
    For Each cell In rng.Cells
        If cell.IndentLevel = 0 Then
            If IsNumeric(cell.value) And Not dict.Exists(cell.value) Then
                dict.Add cell.value, True
            End If
        End If
    Next cell

    yearKeys = dict.keys

    ' 降順バブルソート
    For x = LBound(yearKeys) To UBound(yearKeys) - 1
        For y = x + 1 To UBound(yearKeys)
            If CLng(yearKeys(x)) < CLng(yearKeys(y)) Then
                temp = yearKeys(x)
                yearKeys(x) = yearKeys(y)
                yearKeys(y) = temp
            End If
        Next y
    Next x

    GetSortedYearsFromPivot = yearKeys
End Function

